<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0e1a">
<title>FotoCalib ¬∑ RD 3/2023</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --accent: #00d4ff;
    --accent2: #00ff9d;
    --warn: #ffb800;
    --danger: #ff4757;
    --text: #e8edf5;
    --text2: #9aadbe;
    --mono: 'JetBrains Mono', 'Courier New', Courier, monospace;
    --sans: 'Sora', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --radius: 12px;
  }

  /* Reset limpio ‚Äî sin !important en selectores universales */
  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
  }

  /* Solo aqu√≠ usamos !important: en html/body para ganar a editores externos */
  html {
    background: #0a0e1a !important;
    min-height: 100%;
  }

  body {
    font-family: var(--sans);
    background: #0a0e1a !important;
    color: #e8edf5;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    max-width: 480px;
    margin: 0 auto;
    position: relative;
    overflow-x: hidden;
  }

  /* --- HEADER --- */
  .header {
    padding: 16px 20px 12px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-title {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-icon {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, var(--accent), #0066ff);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
  }
  .app-name { font-weight: 700; font-size: 16px; letter-spacing: 0.5px; }
  .app-sub { font-family: var(--mono); font-size: 10px; color: var(--accent); letter-spacing: 1px; }
  .header-date {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text2);
    text-align: right;
  }

  /* --- NAV --- */
  .bottom-nav {
    position: fixed;
    bottom: 0; left: 50%;
    transform: translateX(-50%);
    width: 100%; max-width: 480px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    z-index: 100;
    padding-bottom: env(safe-area-inset-bottom);
  }
  .nav-btn {
    flex: 1;
    display: flex; flex-direction: column; align-items: center;
    gap: 3px; padding: 10px 4px 8px;
    background: none; border: none; color: var(--text2);
    cursor: pointer; transition: color 0.2s;
    font-family: var(--sans); font-size: 10px;
  }
  .nav-btn.active { color: var(--accent); }
  .nav-btn svg { width: 22px; height: 22px; }
  .nav-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--danger);
    position: absolute; top: 8px; right: calc(50% - 12px);
  }

  /* --- CONTENT --- */
  .content {
    flex: 1;
    padding: 16px 16px 100px;
    overflow-y: auto;
    background: #0a0e1a;
  }

  .page { display: none; }
  .page.active { display: block; }

  /* --- CARDS --- */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    margin-bottom: 12px;
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .card.ok::before { background: var(--accent2); }
  .card.warn::before { background: var(--warn); }
  .card.danger::before { background: var(--danger); }
  .card.neutral::before { background: var(--border); }

  .card-header {
    display: flex; align-items: flex-start;
    justify-content: space-between; gap: 8px;
    margin-bottom: 8px;
  }
  .card-title { font-weight: 600; font-size: 14px; }
  .card-serial {
    font-family: var(--mono); font-size: 11px;
    color: var(--accent); background: rgba(0,212,255,0.1);
    padding: 2px 8px; border-radius: 4px; white-space: nowrap;
  }
  .card-meta { display: flex; gap: 12px; flex-wrap: wrap; }
  .meta-item {
    display: flex; flex-direction: column; gap: 1px;
  }
  .meta-label {
    font-size: 10px; color: var(--text2);
    font-family: var(--mono); letter-spacing: 0.5px; text-transform: uppercase;
  }
  .meta-value { font-size: 13px; font-weight: 500; }
  .meta-value.ok { color: var(--accent2); }
  .meta-value.warn { color: var(--warn); }
  .meta-value.danger { color: var(--danger); }

  .badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 600; font-family: var(--mono);
  }
  .badge.ok { background: rgba(0,255,157,0.1); color: var(--accent2); }
  .badge.warn { background: rgba(255,184,0,0.1); color: var(--warn); }
  .badge.danger { background: rgba(255,71,87,0.12); color: var(--danger); }
  .badge::before {
    content: ''; width: 6px; height: 6px;
    border-radius: 50%; background: currentColor;
  }

  .card-actions {
    display: flex; gap: 8px; margin-top: 12px;
    padding-top: 12px; border-top: 1px solid var(--border);
  }
  .btn {
    flex: 1; padding: 9px 12px;
    border: none; border-radius: 8px;
    font-family: var(--sans); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; justify-content: center; gap: 6px;
  }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:active { transform: scale(0.97); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-danger { background: rgba(255,71,87,0.12); color: var(--danger); border: 1px solid rgba(255,71,87,0.2); }
  .btn-ghost { background: none; color: var(--accent); font-size: 13px; border: 1px solid var(--accent); }
  .btn-icon { flex: none; width: 36px; height: 36px; padding: 0; }

  .btn-full { width: 100%; flex: none; margin-top: 12px; padding: 13px; border-radius: 10px; }

  /* --- FAB --- */
  .fab {
    position: fixed;
    bottom: 80px; right: 20px;
    width: 52px; height: 52px;
    border-radius: 16px;
    background: linear-gradient(135deg, var(--accent), #0066ff);
    border: none; color: #000;
    font-size: 24px; font-weight: 300;
    cursor: pointer; box-shadow: 0 4px 20px rgba(0,212,255,0.35);
    display: flex; align-items: center; justify-content: center;
    z-index: 90; transition: transform 0.15s, box-shadow 0.15s;
  }
  .fab:active { transform: scale(0.93); box-shadow: 0 2px 10px rgba(0,212,255,0.2); }

  /* --- SECTION HEADERS --- */
  .section-label {
    font-family: var(--mono); font-size: 10px; font-weight: 600;
    letter-spacing: 2px; text-transform: uppercase;
    color: var(--text2); margin-bottom: 10px; margin-top: 4px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-label::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  /* --- STAT GRID --- */
  .stat-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 10px; margin-bottom: 16px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
  }
  .stat-num {
    font-family: var(--mono); font-size: 28px; font-weight: 700;
    line-height: 1;
  }
  .stat-num.ok { color: var(--accent2); }
  .stat-num.warn { color: var(--warn); }
  .stat-num.danger { color: var(--danger); }
  .stat-num.accent { color: var(--accent); }
  .stat-desc { font-size: 12px; color: var(--text2); margin-top: 4px; }

  /* --- MODAL --- */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200; display: none;
    align-items: flex-end; justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border-radius: 20px 20px 0 0;
    border-top: 1px solid var(--border);
    padding: 20px 20px calc(20px + env(safe-area-inset-bottom));
    width: 100%; max-width: 480px;
    max-height: 90dvh;
    overflow-y: auto;
    animation: slideUp 0.3s cubic-bezier(0.32,0.72,0,1);
  }
  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }
  .modal-handle {
    width: 36px; height: 4px;
    background: var(--border); border-radius: 2px;
    margin: 0 auto 16px;
  }
  .modal-title {
    font-weight: 700; font-size: 16px;
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }

  /* --- FORMS --- */
  .form-group { margin-bottom: 14px; }
  .form-label {
    display: block; font-size: 11px; font-weight: 600;
    letter-spacing: 0.8px; text-transform: uppercase;
    color: var(--text2); font-family: var(--mono);
    margin-bottom: 6px;
  }
  .form-input {
    width: 100%; padding: 11px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: var(--sans); font-size: 14px;
    transition: border-color 0.2s;
    appearance: none;
  }
  .form-input:focus { outline: none; border-color: var(--accent); }
  select.form-input { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M0 0l6 8 6-8z' fill='%237a8fa8'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }
  textarea.form-input { resize: none; min-height: 80px; }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .form-divider { height: 1px; background: var(--border); margin: 16px 0; }

  /* --- RESULT FIELDS --- */
  .param-block {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
    position: relative;
  }
  .param-block-header {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 8px;
    margin-bottom: 8px;
    align-items: end;
  }
  .param-block-values {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 8px;
    align-items: end;
  }
  .param-remove {
    width: 30px; height: 30px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text2);
    font-size: 16px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    align-self: flex-end;
    transition: all 0.15s;
  }
  .param-remove:hover { border-color: var(--danger); color: var(--danger); }
  .result-status {
    width: 36px; height: 36px;
    border-radius: 8px; border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; cursor: pointer;
    transition: all 0.15s;
    background: var(--bg);
    align-self: flex-end;
  }
  .result-status.pass { border-color: var(--accent2); background: rgba(0,255,157,0.1); color: var(--accent2); }
  .result-status.fail { border-color: var(--danger); background: rgba(255,71,87,0.1); color: var(--danger); }

  /* --- TRACEABILITY --- */
  .timeline { position: relative; }
  .timeline-item {
    display: flex; gap: 12px;
    padding-bottom: 16px;
    position: relative;
  }
  .timeline-item::before {
    content: ''; position: absolute;
    left: 15px; top: 28px; bottom: 0;
    width: 1px; background: var(--border);
  }
  .timeline-item:last-child::before { display: none; }
  .timeline-dot {
    width: 30px; height: 30px; flex-shrink: 0;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    border: 2px solid;
  }
  .timeline-dot.calibracion { border-color: var(--accent); background: rgba(0,212,255,0.1); }
  .timeline-dot.verificacion_ok { border-color: var(--accent2); background: rgba(0,255,157,0.1); }
  .timeline-dot.verificacion_fail { border-color: var(--danger); background: rgba(255,71,87,0.1); }
  .timeline-body { flex: 1; padding-top: 4px; }
  .timeline-title { font-size: 13px; font-weight: 600; }
  .timeline-date { font-family: var(--mono); font-size: 11px; color: var(--text2); margin-top: 2px; }
  .timeline-note { font-size: 12px; color: var(--text2); margin-top: 4px; }

  /* --- EMPTY STATE --- */
  .empty {
    text-align: center; padding: 48px 20px;
    color: var(--text2);
  }
  .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.4; }
  .empty h3 { font-size: 15px; color: var(--text); margin-bottom: 6px; }
  .empty p { font-size: 13px; }

  /* --- CHIP FILTERS --- */
  .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 2px; margin-bottom: 14px; }
  .filter-row::-webkit-scrollbar { display: none; }
  .chip {
    padding: 5px 14px; border-radius: 20px; white-space: nowrap;
    font-size: 12px; font-weight: 600; cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface2); color: var(--text2);
    transition: all 0.15s; flex-shrink: 0;
    font-family: var(--mono);
  }
  .chip.active { background: var(--accent); color: #000; border-color: var(--accent); }

  /* --- ALERT BANNER --- */
  .alert-banner {
    background: rgba(255,71,87,0.12);
    border: 1px solid rgba(255,71,87,0.35);
    border-radius: 10px; padding: 12px 14px;
    margin-bottom: 12px; display: flex; align-items: flex-start; gap: 10px;
    font-size: 13px; color: var(--text);
  }
  .alert-banner strong { color: #fff; }
  .alert-banner span { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

  /* --- PHOTO UPLOAD AREA --- */
  .upload-area {
    border: 2px dashed var(--border);
    border-radius: 10px; padding: 20px;
    text-align: center; cursor: pointer;
    color: var(--text2); font-size: 13px;
    transition: border-color 0.2s;
  }
  .upload-area:hover { border-color: var(--accent); color: var(--accent); }
  .upload-area input { display: none; }
  .upload-preview {
    display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;
  }
  .upload-thumb {
    width: 64px; height: 64px; border-radius: 8px;
    object-fit: cover; border: 1px solid var(--border);
    cursor: pointer;
  }

  /* --- ALERT DOT --- */
  .nav-alert { position: relative; }

  /* --- CONFIRM DIALOG --- */
  .confirm-dialog {
    position: fixed; inset: 0;
    display: none; align-items: center; justify-content: center;
    z-index: 300; background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px); padding: 20px;
  }
  .confirm-dialog.open { display: flex; }
  .confirm-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px; padding: 24px;
    max-width: 300px; width: 100%;
    text-align: center;
  }
  .confirm-icon { font-size: 36px; margin-bottom: 12px; }
  .confirm-title { font-size: 15px; font-weight: 700; margin-bottom: 6px; }
  .confirm-msg { font-size: 13px; color: var(--text2); margin-bottom: 20px; }
  .confirm-btns { display: flex; gap: 10px; }

  /* SIDEBAR BRAND ‚Äî oculto en m√≥vil */
  .sidebar-brand { display: none; }

  /* ============================================================
     DESKTOP RESPONSIVE ‚Äî 768px+
     Transforma la app en un dashboard de escritorio completo
  ============================================================ */
  @media (min-width: 768px) {

    /* Layout ra√≠z: sidebar + contenido */
    body {
      max-width: 100% !important;
      flex-direction: row !important;
      height: 100vh;
      overflow: hidden;
    }

    /* SIDEBAR BRAND ‚Äî quitamos: el header ya tiene el logo */
    .sidebar-brand { display: none; }

    /* SIDEBAR ‚Äî reemplaza el bottom nav */
    .bottom-nav {
      position: fixed;
      top: 64px; left: 0; bottom: 0;
      width: 200px;
      flex-direction: column;
      justify-content: flex-start;
      border-top: none;
      border-right: 1px solid var(--border);
      padding: 0;
      padding-top: 16px;
      transform: none;
      max-width: none;
    }

    .nav-btn {
      flex: none;
      flex-direction: row;
      justify-content: flex-start;
      gap: 12px;
      padding: 14px 24px;
      font-size: 13px;
      text-align: left;
      border-radius: 0;
      transition: background 0.15s, color 0.2s;
    }
    .nav-btn:hover { background: rgba(255,255,255,0.04); }
    .nav-btn.active {
      background: rgba(0,212,255,0.08);
      border-right: 3px solid var(--accent);
    }
    .nav-btn svg { width: 18px; height: 18px; flex-shrink: 0; }

    /* HEADER ‚Äî full width, encima del sidebar */
    .header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 200;
      height: 64px;
      padding: 0 28px;
    }
    .app-name { font-size: 18px; }
    .app-sub { font-size: 11px; }
    .logo-icon { width: 38px; height: 38px; font-size: 20px; }

    /* CONTENT ‚Äî desplazado a la derecha del sidebar, debajo del header */
    .content {
      margin-left: 200px;
      margin-top: 64px;
      padding: 28px 32px 40px;
      overflow-y: auto;
      height: calc(100vh - 64px);
      flex: 1;
      background: #0a0e1a;
    }

    /* FAB ‚Äî reposicionado para PC */
    .fab {
      bottom: 32px;
      right: 36px;
      width: 56px; height: 56px;
      border-radius: 18px;
      font-size: 26px;
    }

    /* STAT GRID ‚Äî 4 columnas en PC */
    .stat-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      margin-bottom: 24px;
    }
    .stat-card {
      padding: 20px 18px;
    }
    .stat-num { font-size: 36px; }
    .stat-desc { font-size: 13px; }

    /* DEVICE CARDS ‚Äî grid de 2-3 columnas */
    #dashDevices,
    #devicesList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 14px;
    }
    #dashDevices .card,
    #devicesList .card {
      margin-bottom: 0;
    }

    /* VERIF LIST ‚Äî 2 columnas */
    #verifList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 14px;
    }
    #verifList .card { margin-bottom: 0; }

    /* ALERT BANNERS ‚Äî full width elegante */
    #dashAlerts {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .alert-banner { margin-bottom: 0; }

    /* SECTION LABEL ‚Äî m√°s espacio */
    .section-label {
      font-size: 11px;
      margin-bottom: 14px;
      margin-top: 8px;
    }

    /* TRAZABILIDAD ‚Äî m√°s ancha */
    #trazContent { max-width: 800px; }

    /* MODALES ‚Äî centrados y m√°s anchos */
    .modal-overlay {
      align-items: center;
    }
    .modal {
      border-radius: 16px !important;
      max-width: 600px;
      max-height: 88vh;
      animation: modalFadeIn 0.2s ease !important;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-16px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .modal-handle { display: none; }

    /* FAB MENU ‚Äî hacia arriba y a la derecha */
    .fab-menu {
      bottom: 100px;
      right: 36px;
    }

    /* FILTROS ‚Äî inline */
    .filter-row {
      margin-bottom: 18px;
    }

    /* EMPTY STATE ‚Äî centrado */
    .empty {
      padding: 60px 20px;
    }
  }

  /* EXTRA LARGE ‚Äî 1200px+ */
  @media (min-width: 1200px) {
    .bottom-nav { width: 220px; }
    .content { margin-left: 220px; padding: 32px 48px 40px; }
    #dashDevices,
    #devicesList {
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    }
    .stat-grid { gap: 18px; }
    .stat-num { font-size: 40px; }
  }
</style>
</head>
<body style="background:#0a0e1a!important;color:#e8edf5!important;margin:0!important;">
<!-- Bloque de seguridad: por si el editor pisa el <head> -->
<style>body,html{background:#0a0e1a!important;color:#e8edf5!important;}</style>

<!-- HEADER -->
<header class="header">
  <div class="header-title">
    <div class="logo-icon">üî¨</div>
    <div>
      <div class="app-name">FotoCalib</div>
      <div class="app-sub">RD 3/2023 ¬∑ RD 487/2022</div>
    </div>
  </div>
  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
    <div class="header-date" id="headerDate"></div>
    <div id="syncStatus" style="font-family:var(--mono);font-size:10px;cursor:pointer;" onclick="openSettings()"></div>
  </div>
</header>

<!-- CONTENT -->
<div class="content">

  <!-- ===== P√ÅGINA: DASHBOARD ===== -->
  <div class="page active" id="page-dashboard">
    <div id="dashAlerts"></div>
    <div class="stat-grid" id="statGrid"></div>
    <div class="section-label">Fot√≥metros activos</div>
    <div id="dashDevices"></div>
  </div>

  <!-- ===== P√ÅGINA: FOT√ìMETROS ===== -->
  <div class="page" id="page-dispositivos">
    <div class="filter-row">
      <div class="chip active" data-filter="all" onclick="filterDevices(this)">Todos</div>
      <div class="chip" data-filter="ok" onclick="filterDevices(this)">‚úì OK</div>
      <div class="chip" data-filter="warn" onclick="filterDevices(this)">‚ö† Pendiente</div>
      <div class="chip" data-filter="danger" onclick="filterDevices(this)">‚úó Vencido</div>
    </div>
    <div id="devicesList"></div>
  </div>

  <!-- ===== P√ÅGINA: VERIFICACIONES ===== -->
  <div class="page" id="page-verificaciones">
    <div class="filter-row">
      <div class="chip active" data-filter="all" onclick="filterVerif(this)">Todas</div>
      <div class="chip" data-filter="pass" onclick="filterVerif(this)">‚úì Pasa</div>
      <div class="chip" data-filter="fail" onclick="filterVerif(this)">‚úó Falla</div>
    </div>
    <div id="verifList"></div>
  </div>

  <!-- ===== P√ÅGINA: TRAZABILIDAD ===== -->
  <div class="page" id="page-trazabilidad">
    <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:14px;">
      <div class="form-group" style="flex:1;margin-bottom:0;">
        <select class="form-input" id="trazSelect" onchange="renderTrazabilidad()">
          <option value="">‚Äî Selecciona equipo ‚Äî</option>
          <option value="__all__">üìã Todos los equipos</option>
        </select>
      </div>
      <button class="btn btn-ghost" style="height:44px;padding:0 14px;white-space:nowrap;" onclick="printTrazabilidad()">üñ®Ô∏è Imprimir</button>
    </div>
    <div id="trazContent"></div>
  </div>

</div><!-- /content -->

<!-- FAB -->
<button class="fab" id="fabBtn" onclick="openFab()">+</button>

<!-- BOTTOM NAV / SIDEBAR -->
<nav class="bottom-nav">
  <!-- Logo visible solo en PC dentro del sidebar -->
  <div class="sidebar-brand">
    <div class="logo-icon" style="width:32px;height:32px;font-size:16px;background:linear-gradient(135deg,var(--accent),#0066ff);border-radius:8px;display:flex;align-items:center;justify-content:center;">üî¨</div>
    <div>
      <div style="font-weight:700;font-size:14px;">FotoCalib</div>
      <div style="font-family:var(--mono);font-size:9px;color:var(--accent);letter-spacing:1px;">RD 3/2023</div>
    </div>
  </div>
  <button class="nav-btn active" onclick="showPage('dashboard', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    Dashboard
  </button>
  <button class="nav-btn nav-alert" onclick="showPage('dispositivos', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v2m0 16v2M2 12h2m16 0h2m-3.5-6.5-1.4 1.4M6.9 17.1l-1.4 1.4m0-12.8 1.4 1.4m8.8 8.8 1.4 1.4"/></svg>
    Fot√≥metros
  </button>
  <button class="nav-btn" onclick="showPage('verificaciones', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    Registros
  </button>
  <button class="nav-btn" onclick="showPage('trazabilidad', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    Trazabilidad
  </button>
  <!-- Bot√≥n de settings en sidebar PC -->
  <button class="nav-btn" onclick="openSettings()" style="margin-top:auto;">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    Configuraci√≥n
  </button>
</nav>

<!-- MODAL: NUEVO FOT√ìMETRO -->
<div class="modal-overlay" id="modalFotometro">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üìü <span id="mFotoTitle">Nuevo Equipo</span></div>
    <input type="hidden" id="mFotoId">
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Tipo de equipo</label>
        <select class="form-input" id="mFotoTipo">
          <option value="fotometro">üìü Fot√≥metro</option>
          <option value="turbidimetro">üíß Turbid√≠metro</option>
          <option value="termometro">üå°Ô∏è Term√≥metro</option>
          <option value="otro">üîß Otro</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Estado</label>
        <select class="form-input" id="mFotoEstado">
          <option value="activo">Activo</option>
          <option value="baja">Baja</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Nombre / Modelo</label>
      <input type="text" class="form-input" id="mFotoNombre" placeholder="Ej: Lovibond MD 110, Hanna HI98703...">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">N¬∫ Serie</label>
        <input type="text" class="form-input" id="mFotoSerie" placeholder="SN-12345">
      </div>
      <div class="form-group">
        <label class="form-label">Par√°metro principal</label>
        <select class="form-input" id="mFotoParam">
          <option>Cloro libre</option>
          <option>Cloro total</option>
          <option>Cloro libre + Total</option>
          <option>pH</option>
          <option>Turbidez</option>
          <option>Temperatura</option>
          <option>Amonio</option>
          <option>Di√≥xido de cloro</option>
          <option>Multipar√°metro</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Ubicaci√≥n</label>
      <input type="text" class="form-input" id="mFotoUbic" placeholder="Dep√≥sito 1, ACS, Piscina...">
    </div>
    <div class="form-divider"></div>
    <div class="section-label" style="margin-top:0">Calibraci√≥n anual</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">√öltima calibraci√≥n</label>
        <input type="date" class="form-input" id="mFotoCalFecha">
      </div>
      <div class="form-group">
        <label class="form-label">Laboratorio</label>
        <input type="text" class="form-input" id="mFotoLab" placeholder="Nombre laboratorio">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">N¬∫ Certificado calibraci√≥n</label>
      <input type="text" class="form-input" id="mFotoCert" placeholder="CERT-2024-001">
    </div>
    <div class="form-group">
      <label class="form-label">Notas</label>
      <textarea class="form-input" id="mFotoNotas" placeholder="Observaciones..."></textarea>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-secondary" onclick="closeModal('modalFotometro')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveFotometro()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: VERIFICACI√ìN MENSUAL -->
<div class="modal-overlay" id="modalVerif">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üß™ Nueva Verificaci√≥n Mensual</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Equipo</label>
        <select class="form-input" id="mVerifFoto"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Fecha</label>
        <input type="date" class="form-input" id="mVerifFecha">
      </div>
    </div>
    <div class="form-divider"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div class="section-label" style="margin:0">Par√°metros verificados</div>
      <button class="btn btn-ghost" style="padding:4px 12px;font-size:12px;" onclick="addParamRow()">+ A√±adir</button>
    </div>
    <!-- datalist para sugerencias de nombre -->
    <datalist id="paramSuggestions">
      <option value="Cloro libre">
      <option value="Cloro total">
      <option value="pH">
      <option value="Turbidez">
      <option value="Temperatura">
      <option value="Amonio">
      <option value="Di√≥xido de cloro">
      <option value="Conductividad">
    </datalist>
    <div id="verifParams"></div>
    <div class="form-divider"></div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">T√©cnico</label>
        <input type="text" class="form-input" id="mVerifTecnico" placeholder="Nombre del t√©cnico">
      </div>
      <div class="form-group">
        <label class="form-label">Resultado global</label>
        <div id="globalStatus" style="padding:11px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg);font-size:13px;color:var(--text2);">Auto (seg√∫n par√°metros)</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Observaciones / Acciones correctoras</label>
      <textarea class="form-input" id="mVerifNotas" placeholder="Notas, acciones correctoras..."></textarea>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-secondary" onclick="closeModal('modalVerif')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveVerificacion()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL FAB SELECTOR -->
<div class="modal-overlay" id="modalFab">
  <div class="modal" style="padding-bottom:20px;">
    <div class="modal-handle"></div>
    <div class="modal-title">¬øQu√© quieres hacer?</div>
    <div class="section-label" style="margin-top:0">A√±adir registro</div>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); openFotometro()">üìü Nuevo Fot√≥metro</button>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); openVerif()">üß™ Verificaci√≥n Mensual</button>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); openCalAnual()">üìã Calibraci√≥n Anual (registro)</button>
    <div class="section-label">Exportar</div>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); exportCSV()">üìä Exportar CSV</button>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); exportPDF()">üñ®Ô∏è Generar PDF / Imprimir</button>
    <div class="section-label">Configuraci√≥n</div>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); openSettings()">‚öôÔ∏è Conexi√≥n GitHub</button>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); loadFromGitHub().then(()=>renderAll())">üîÑ Sincronizar ahora</button>
  </div>
</div>

<!-- MODAL: CALIBRACI√ìN ANUAL (registro adicional) -->
<div class="modal-overlay" id="modalCalAnual">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üìã Calibraci√≥n Anual</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Fot√≥metro</label>
        <select class="form-input" id="mCalFoto"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Fecha calibraci√≥n</label>
        <input type="date" class="form-input" id="mCalFecha">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Laboratorio acreditado</label>
        <input type="text" class="form-input" id="mCalLab" placeholder="Nombre laboratorio">
      </div>
      <div class="form-group">
        <label class="form-label">N¬∫ Certificado</label>
        <input type="text" class="form-input" id="mCalCert" placeholder="CERT-2024-001">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Incertidumbre / Resultado</label>
      <input type="text" class="form-input" id="mCalResultado" placeholder="Ej: ¬±0.02 mg/L, dentro de especificaci√≥n">
    </div>
    <div class="form-group">
      <label class="form-label">V√°lida hasta</label>
      <input type="date" class="form-input" id="mCalVigencia">
    </div>
    <div class="form-group">
      <label class="form-label">Observaciones</label>
      <textarea class="form-input" id="mCalNotas" placeholder=""></textarea>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-secondary" onclick="closeModal('modalCalAnual')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveCalAnual()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: DETALLE FOT√ìMETRO -->
<div class="modal-overlay" id="modalDetalle">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="detalleContent"></div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn btn-danger btn-icon" onclick="confirmDelete()" title="Eliminar">üóë</button>
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('modalDetalle')">Cerrar</button>
      <button class="btn btn-primary" style="flex:1" onclick="editFotometro()">Editar</button>
    </div>
  </div>
</div>

<!-- MODAL: CONFIGURACI√ìN GITHUB -->
<div class="modal-overlay" id="modalSettings">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">‚öôÔ∏è Conexi√≥n GitHub</div>
    <div style="background:rgba(0,212,255,0.07);border:1px solid rgba(0,212,255,0.2);border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--text2);line-height:1.6;">
      Los datos se guardan en <span style="color:var(--accent);font-family:var(--mono)">MikiMauZ/Pseudos/fotometro.json</span>.<br>
      Necesitas un <strong style="color:var(--text)">Personal Access Token</strong> de GitHub con permiso <span style="font-family:var(--mono);color:var(--accent2)">repo</span> para poder escribir.
    </div>
    <div id="sandboxWarning" style="display:none;background:rgba(255,184,0,0.1);border:1px solid rgba(255,184,0,0.3);border-radius:8px;padding:12px;margin-bottom:14px;font-size:12px;color:var(--warn);line-height:1.6;">
      ‚ö†Ô∏è <strong>Est√°s dentro de Claude.ai.</strong> Las llamadas a GitHub est√°n bloqueadas por seguridad.<br>
      <span style="color:var(--text2)">Guarda el token aqu√≠ y abre el archivo en <strong style="color:var(--text)">Safari</strong> o en <strong style="color:var(--text)">GitHub Pages</strong> para que funcione.</span>
    </div>
    <div class="form-group">
      <label class="form-label">GitHub Personal Access Token (PAT)</label>
      <input type="password" class="form-input" id="sToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
      <div style="font-size:11px;color:var(--text2);margin-top:5px;">Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic) ‚Üí scope: <code>repo</code></div>
    </div>
    <div id="settingsStatus" style="font-size:12px;margin-bottom:10px;"></div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-secondary" onclick="closeModal('modalSettings')">Cancelar</button>
      <button class="btn btn-ghost" onclick="testGitHub()">üîó Probar conexi√≥n</button>
      <button class="btn btn-primary" onclick="saveSettings()">Guardar</button>
    </div>
  </div>
</div>

<!-- CONFIRM DIALOG -->
<div class="confirm-dialog" id="confirmDialog">
  <div class="confirm-box">
    <div class="confirm-icon">‚ö†Ô∏è</div>
    <div class="confirm-title">¬øEliminar fot√≥metro?</div>
    <div class="confirm-msg">Se borrar√°n tambi√©n todas sus verificaciones y calibraciones. Esta acci√≥n no se puede deshacer.</div>
    <div class="confirm-btns">
      <button class="btn btn-secondary" style="flex:1" onclick="closeConfirm()">Cancelar</button>
      <button class="btn btn-danger" style="flex:1" onclick="doDelete()">Eliminar</button>
    </div>
  </div>
</div>

<script>
// ============================================================
//  CONFIG GITHUB
// ============================================================
const GH = {
  owner: 'MikiMauZ',
  repo: 'Pseudos',
  path: 'fotometro.json',
  branch: 'main',
  get token() { return localStorage.getItem('fc_gh_token') || ''; },
  get apiUrl() { return `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${this.path}`; },
  get rawUrl() { return `https://raw.githubusercontent.com/${this.owner}/${this.repo}/${this.branch}/${this.path}`; }
};

// SHA del archivo actual (necesario para escribir en GitHub)
let ghFileSha = null;

// Cache local de los datos
let localData = { version:'1.0', lastUpdated:'', fotometros:[], verificaciones:[], calibraciones:[] };

// ============================================================
//  ESTADO DE SYNC
// ============================================================
function setSyncStatus(state, msg) {
  try {
    const el = document.getElementById('syncStatus');
    if (!el) return;
    const icons = { ok:'üü¢', loading:'üîÑ', error:'üî¥', warn:'üü°', offline:'‚ö´' };
    el.innerHTML = `${icons[state]||'‚ö™'} ${msg}`;
    el.style.color = state==='ok'?'var(--accent2)':state==='error'?'var(--danger)':state==='warn'?'var(--warn)':'var(--text2)';
  } catch(e) {}
}

// ============================================================
//  CARGAR DATOS DESDE GITHUB
// ============================================================
async function loadFromGitHub() {
  setSyncStatus('loading', 'Cargando‚Ä¶');
  try {
    const headers = { 'Accept': 'application/vnd.github+json' };
    if (GH.token) headers['Authorization'] = `Bearer ${GH.token}`;

    const res = await fetch(GH.apiUrl, { headers });

    if (res.status === 404) {
      // Archivo no existe todav√≠a ‚Äî empezar con datos vac√≠os
      setSyncStatus('warn', 'JSON nuevo');
      return;
    }
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const meta = await res.json();
    if (!meta.content) throw new Error('Respuesta sin content');

    ghFileSha = meta.sha;
    // decodeURIComponent(escape(...)) convierte bytes UTF-8 a string correctamente
    const raw = decodeURIComponent(escape(atob(meta.content.replace(/\n/g, ''))));
    const parsed = JSON.parse(raw);

    // Merge seguro: si alguna clave falta, usa array vac√≠o
    localData = {
      version: '1.0',
      lastUpdated: '',
      fotometros: [],
      verificaciones: [],
      calibraciones: [],
      ...parsed
    };

    // Guardar copia local siempre
    localStorage.setItem('fc_localData', JSON.stringify(localData));
    setSyncStatus('ok', 'GitHub ‚úì');

  } catch(e) {
    console.warn('GitHub load failed:', e.message);
    // Fallback a copia local si existe
    try {
      const ls = localStorage.getItem('fc_localData');
      if (ls) {
        localData = JSON.parse(ls);
        setSyncStatus('warn', 'Offline (local)');
        return;
      }
    } catch(e2) {}
    // Sin datos en ning√∫n lado ‚Äî empezar vac√≠o
    setSyncStatus(GH.token ? 'error' : 'warn', GH.token ? 'Error GitHub' : 'Sin token ‚Üí');
  }
}

// ============================================================
//  GUARDAR DATOS EN GITHUB
// ============================================================
async function saveToGitHub() {
  // Siempre guardar localmente tambi√©n
  localStorage.setItem('fc_localData', JSON.stringify(localData));

  if (!GH.token) { setSyncStatus('warn', 'Sin token ‚Üí'); return; }

  setSyncStatus('loading', 'Guardando‚Ä¶');
  localData.lastUpdated = new Date().toISOString();

  const contentB64 = btoa(unescape(encodeURIComponent(JSON.stringify(localData, null, 2))));

  try {
    const body = {
      message: `FotoCalib update ${new Date().toLocaleString('es-ES')}`,
      content: contentB64,
      branch: GH.branch
    };
    if (ghFileSha) body.sha = ghFileSha;

    const res = await fetch(GH.apiUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${GH.token}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || `HTTP ${res.status}`);
    }

    const result = await res.json();
    ghFileSha = result.content.sha;
    setSyncStatus('ok', 'Guardado ‚úì');
  } catch(e) {
    setSyncStatus('error', 'Error al guardar');
    console.error('GitHub save error:', e);
  }
}

// ============================================================
//  ACCESSORS ‚Äî ahora usan localData en vez de localStorage
// ============================================================
const DB = { id: () => Date.now() + Math.random().toString(36).slice(2,6) };

const getFotos   = () => localData.fotometros    || [];
const getVerifs  = () => localData.verificaciones || [];
const getCals    = () => localData.calibraciones  || [];

function setFotos(v)  { localData.fotometros    = v; }
function setVerifs(v) { localData.verificaciones = v; }
function setCals(v)   { localData.calibraciones  = v; }

// ============================================================
//  UTILIDADES
// ============================================================
const today = () => new Date().toISOString().slice(0,10);

function daysUntil(dateStr) {
  if (!dateStr) return null;
  const diff = new Date(dateStr) - new Date(today());
  return Math.ceil(diff / (1000*60*60*24));
}

function nextCalDate(lastCalStr) {
  if (!lastCalStr) return null;
  const d = new Date(lastCalStr);
  d.setFullYear(d.getFullYear() + 1);
  return d.toISOString().slice(0,10);
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  const [y,m,day] = d.split('-');
  return `${day}/${m}/${y}`;
}

function getDeviceStatus(foto) {
  const fotos = getFotos();
  const verifs = getVerifs().filter(v => v.fotoId === foto.id);
  const cals = getCals().filter(c => c.fotoId === foto.id);

  // Calibraci√≥n anual
  const allCalDates = [];
  if (foto.calFecha) allCalDates.push(foto.calFecha);
  cals.forEach(c => allCalDates.push(c.fecha));
  const lastCal = allCalDates.sort().at(-1);
  const nextCal = nextCalDate(lastCal);
  const calDays = daysUntil(nextCal);

  // Verificaci√≥n mensual ‚Äî √∫ltima
  const lastVerif = verifs.sort((a,b) => a.fecha<b.fecha?1:-1)[0];
  const lastVerifDate = lastVerif?.fecha;
  const verifDays = lastVerifDate ? daysUntil(new Date(lastVerifDate).setMonth(new Date(lastVerifDate).getMonth()+1)) : null;

  let calStatus = 'ok', verifStatus = 'ok';

  if (!lastCal) calStatus = 'danger';
  else if (calDays !== null && calDays < 0) calStatus = 'danger';
  else if (calDays !== null && calDays < 30) calStatus = 'warn';

  if (!lastVerifDate) verifStatus = 'danger';
  else {
    const verifDaysNum = typeof verifDays === 'object' ? Math.ceil((verifDays - new Date()) / 86400000) : verifDays;
    if (verifDaysNum !== null && verifDaysNum < 0) verifStatus = 'danger';
    else if (verifDaysNum !== null && verifDaysNum < 7) verifStatus = 'warn';
  }

  const overall = (calStatus === 'danger' || verifStatus === 'danger') ? 'danger'
                : (calStatus === 'warn' || verifStatus === 'warn') ? 'warn' : 'ok';

  const lastVerifFail = lastVerif && lastVerif.params && lastVerif.params.some(p => p.status === 'fail');

  return { overall, calStatus, verifStatus, lastCal, nextCal, calDays, lastVerifDate, lastVerifFail };
}

// ============================================================
//  INIT
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
  // Fecha en header
  try {
    const d = new Date();
    document.getElementById('headerDate').innerHTML =
      d.toLocaleDateString('es-ES', {weekday:'short',day:'2-digit',month:'short'}).replace('.','')+'<br>'+
      d.getFullYear();
  } catch(e) {}

  // Cargar datos ‚Äî renderAll se ejecuta SIEMPRE aunque falle todo
  try {
    setSyncStatus('loading', 'Conectando‚Ä¶');
    await loadFromGitHub();
  } catch(e) {
    console.error('Init load error:', e);
    setSyncStatus('error', 'Error inicio');
  } finally {
    renderAll();
    // Abrir config si no hay token (con delay para que el UI ya est√© pintado)
    if (!GH.token) {
      setSyncStatus('warn', 'Sin token ‚Üí');
      setTimeout(() => { try { openSettings(); } catch(e) {} }, 800);
    }
  }
});

// ============================================================
//  RENDER PRINCIPAL
// ============================================================
function renderAll() {
  try { renderDashboard(); } catch(e) { console.error('renderDashboard:', e); }
  try { renderDevices(); } catch(e) { console.error('renderDevices:', e); }
  try { renderVerifications(); } catch(e) { console.error('renderVerifications:', e); }
  try { renderTrazSelector(); } catch(e) { console.error('renderTrazSelector:', e); }
}

// ============================================================
//  DASHBOARD
// ============================================================
function renderDashboard() {
  const fotos = getFotos().filter(f => f.estado === 'activo');
  const verifs = getVerifs();
  const cals = getCals();

  let alerts = 0, warns = 0, oks = 0;
  const alertHtml = [];

  fotos.forEach(f => {
    const s = getDeviceStatus(f);
    if (s.overall === 'danger') {
      alerts++;
      alertHtml.push(`<div class="alert-banner"><span>üö®</span><div><strong>${f.nombre}</strong> ‚Äî ${s.calStatus==='danger'?'Calibraci√≥n anual vencida/pendiente':''} ${s.verifStatus==='danger'?'Verificaci√≥n mensual vencida/pendiente':''}</div></div>`);
    } else if (s.overall === 'warn') warns++;
    else oks++;
  });

  document.getElementById('dashAlerts').innerHTML = alertHtml.join('');

  document.getElementById('statGrid').innerHTML = `
    <div class="stat-card">
      <div class="stat-num accent">${fotos.length}</div>
      <div class="stat-desc">Fot√≥metros activos</div>
    </div>
    <div class="stat-card">
      <div class="stat-num ${alerts>0?'danger':oks===fotos.length?'ok':'warn'}">${alerts>0?alerts:oks}</div>
      <div class="stat-desc">${alerts>0?'Con alertas':'Sin alertas'}</div>
    </div>
    <div class="stat-card">
      <div class="stat-num accent">${verifs.length}</div>
      <div class="stat-desc">Verificaciones registradas</div>
    </div>
    <div class="stat-card">
      <div class="stat-num accent">${verifs.filter(v=>v.global==='fail').length}</div>
      <div class="stat-desc">Fallos detectados</div>
    </div>
  `;

  // √öltimos 5 dispositivos
  const html = fotos.length === 0
    ? '<div class="empty"><div class="empty-icon">üìü</div><h3>Sin fot√≥metros</h3><p>A√±ade tu primer fot√≥metro con el bot√≥n +</p></div>'
    : fotos.map(f => renderDeviceCard(f, true)).join('');
  document.getElementById('dashDevices').innerHTML = html;
}

// ============================================================
//  DISPOSITIVOS
// ============================================================
let deviceFilter = 'all';
function filterDevices(el) {
  document.querySelectorAll('.filter-row .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  deviceFilter = el.dataset.filter;
  renderDevices();
}

function renderDevices() {
  const fotos = getFotos();
  const filtered = fotos.filter(f => {
    if (deviceFilter === 'all') return true;
    const s = getDeviceStatus(f);
    return s.overall === deviceFilter;
  });
  const html = filtered.length === 0
    ? '<div class="empty"><div class="empty-icon">üî≠</div><h3>Sin resultados</h3><p>No hay fot√≥metros en este estado</p></div>'
    : filtered.map(f => renderDeviceCard(f, false)).join('');
  document.getElementById('devicesList').innerHTML = html;
}

function renderDeviceCard(foto, compact) {
  const s = getDeviceStatus(foto);
  const statusLabels = {ok:'CORRECTO', warn:'ATENCI√ìN', danger:'VENCIDO'};
  const tipoIcons = { fotometro:'üìü', turbidimetro:'üíß', termometro:'üå°Ô∏è', otro:'üîß' };
  const icon = tipoIcons[foto.tipo] || 'üìü';

  return `<div class="card ${s.overall}" onclick="showDetalle('${foto.id}')">
    <div class="card-header">
      <div>
        <div class="card-title">${icon} ${foto.nombre}</div>
        <div style="margin-top:4px;font-size:12px;color:var(--text2)">${foto.param} ¬∑ ${foto.ubicacion}</div>
      </div>
      <div class="card-serial">${foto.serie}</div>
    </div>
    <div class="card-meta">
      <div class="meta-item">
        <div class="meta-label">Cal. anual</div>
        <div class="meta-value ${s.calStatus}">${fmtDate(s.lastCal)}</div>
      </div>
      <div class="meta-item">
        <div class="meta-label">Pr√≥x. cal.</div>
        <div class="meta-value ${s.calStatus}">${fmtDate(s.nextCal)}${s.calDays!==null?` (${s.calDays}d)`:''}</div>
      </div>
      <div class="meta-item">
        <div class="meta-label">√ölt. verif.</div>
        <div class="meta-value ${s.verifStatus}">${fmtDate(s.lastVerifDate)}</div>
      </div>
      <div class="meta-item">
        <div class="meta-label">Estado</div>
        <span class="badge ${s.overall}">${statusLabels[s.overall]}</span>
      </div>
    </div>
    ${s.lastVerifFail ? `<div style="margin-top:8px;font-size:12px;color:var(--danger)">‚ö† √öltima verificaci√≥n con fallos</div>` : ''}
  </div>`;
}

// ============================================================
//  VERIFICACIONES
// ============================================================
let verifFilter = 'all';
function filterVerif(el) {
  document.querySelectorAll('#page-verificaciones .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  verifFilter = el.dataset.filter;
  renderVerifications();
}

function renderVerifications() {
  const verifs = getVerifs().sort((a,b) => a.fecha<b.fecha?1:-1);
  const fotos = getFotos();
  const filtered = verifs.filter(v => verifFilter === 'all' ? true : v.global === verifFilter);

  if (filtered.length === 0) {
    document.getElementById('verifList').innerHTML = '<div class="empty"><div class="empty-icon">üß™</div><h3>Sin verificaciones</h3><p>Registra la primera verificaci√≥n mensual</p></div>';
    return;
  }

  const html = filtered.map(v => {
    const foto = fotos.find(f => f.id === v.fotoId);
    const passFail = v.global === 'pass';
    // Soporte para params nuevo (patron/obtenido separados) y legacy (valor)
    const paramsHtml = v.params && v.params.length ? `<div style="display:flex;flex-direction:column;gap:4px;margin-top:8px;">
      ${v.params.map(p => {
        const valorDisplay = p.patron && p.obtenido
          ? `<span style="font-family:var(--mono);font-size:11px">Patr√≥n: ${p.patron}</span> <span style="color:var(--text2)">‚Üí</span> <span style="font-family:var(--mono);font-size:11px">Obtenido: ${p.obtenido}</span>`
          : `<span style="font-family:var(--mono);font-size:11px;color:var(--text2)">${p.valor||''}</span>`;
        return `<div style="display:flex;justify-content:space-between;align-items:center;font-size:12px;background:var(--bg);padding:6px 10px;border-radius:6px;gap:8px;">
          <div style="flex:1;min-width:0;">
            <span style="font-weight:600">${p.nombre}</span>
            ${p.kit ? `<span style="color:var(--text2);margin-left:6px;font-size:11px">[${p.kit}]</span>` : ''}
            <div style="margin-top:2px">${valorDisplay}</div>
          </div>
          <span style="color:${p.status==='pass'?'var(--accent2)':'var(--danger)'};font-size:16px;flex-shrink:0">${p.status==='pass'?'‚úì':'‚úó'}</span>
        </div>`;
      }).join('')}
    </div>` : '';

    return `<div class="card ${passFail?'ok':'danger'}">
      <div class="card-header">
        <div>
          <div class="card-title">${foto?.nombre ?? 'Equipo eliminado'}</div>
          <div style="font-size:12px;color:var(--text2);margin-top:3px">T√©cnico: ${v.tecnico || '‚Äî'}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
          <span class="badge ${passFail?'ok':'danger'}">${passFail?'PASA':'FALLA'}</span>
          <span style="font-family:var(--mono);font-size:11px;color:var(--text2)">${fmtDate(v.fecha)}</span>
        </div>
      </div>
      ${paramsHtml}
      ${v.notas ? `<div style="margin-top:8px;font-size:12px;color:var(--text2);padding:6px 10px;background:var(--bg);border-radius:6px;">üí¨ ${v.notas}</div>` : ''}
      <div style="margin-top:10px;display:flex;justify-content:flex-end;">
        <button class="btn btn-ghost" style="padding:4px 12px;font-size:12px;" onclick="printVerif('${v.id}')">üñ®Ô∏è Imprimir</button>
      </div>
    </div>`;
  }).join('');
  document.getElementById('verifList').innerHTML = html;
}

// ============================================================
//  TRAZABILIDAD
// ============================================================
function renderTrazSelector() {
  const fotos = getFotos();
  const tipoIcons = { fotometro:'üìü', turbidimetro:'üíß', termometro:'üå°Ô∏è', otro:'üîß' };
  const sel = document.getElementById('trazSelect');
  const current = sel.value;
  sel.innerHTML = '<option value="">‚Äî Selecciona equipo ‚Äî</option><option value="__all__">üìã Todos los equipos</option>' +
    fotos.map(f => `<option value="${f.id}" ${f.id===current?'selected':''}>${tipoIcons[f.tipo]||'üìü'} ${f.nombre} (${f.serie})</option>`).join('');
}

function renderTrazabilidad() {
  const fotoId = document.getElementById('trazSelect').value;
  if (!fotoId) { document.getElementById('trazContent').innerHTML = ''; return; }

  if (fotoId === '__all__') {
    renderTrazabilidadAll();
    return;
  }

  const verifs = getVerifs().filter(v => v.fotoId === fotoId).sort((a,b) => a.fecha<b.fecha?1:-1);
  const cals = getCals().filter(c => c.fotoId === fotoId).sort((a,b) => a.fecha<b.fecha?1:-1);
  const foto = getFotos().find(f => f.id === fotoId);

  const events = [];
  if (foto?.calFecha) {
    events.push({ tipo: 'calibracion', fecha: foto.calFecha, titulo: 'Calibraci√≥n anual (inicial)', lab: foto.calLab, cert: foto.calCert, notas: foto.notas });
  }
  cals.forEach(c => events.push({ tipo: 'calibracion', fecha: c.fecha, titulo: 'Calibraci√≥n anual', lab: c.lab, cert: c.cert, notas: c.notas, resultado: c.resultado, vigencia: c.vigencia }));
  verifs.forEach(v => events.push({ tipo: v.global === 'fail' ? 'verificacion_fail' : 'verificacion_ok', fecha: v.fecha, titulo: `Verificaci√≥n mensual ‚Äî ${v.global==='pass'?'PASA':'FALLA'}`, patron: v.patron, tecnico: v.tecnico, params: v.params, notas: v.notas }));
  events.sort((a,b) => a.fecha < b.fecha ? 1 : -1);

  if (events.length === 0) {
    document.getElementById('trazContent').innerHTML = '<div class="empty"><div class="empty-icon">üìà</div><h3>Sin registros</h3><p>No hay historial para este equipo</p></div>';
    return;
  }

  document.getElementById('trazContent').innerHTML = buildTimeline(events);
}

function renderTrazabilidadAll() {
  const fotos = getFotos();
  const tipoIcons = { fotometro:'üìü', turbidimetro:'üíß', termometro:'üå°Ô∏è', otro:'üîß' };

  if (fotos.length === 0) {
    document.getElementById('trazContent').innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><h3>Sin equipos</h3></div>';
    return;
  }

  const html = fotos.map(foto => {
    const verifs = getVerifs().filter(v => v.fotoId === foto.id).sort((a,b) => a.fecha<b.fecha?1:-1);
    const cals = getCals().filter(c => c.fotoId === foto.id).sort((a,b) => a.fecha<b.fecha?1:-1);
    const events = [];
    if (foto.calFecha) events.push({ tipo: 'calibracion', fecha: foto.calFecha, titulo: 'Calibraci√≥n anual (inicial)', lab: foto.calLab, cert: foto.calCert });
    cals.forEach(c => events.push({ tipo: 'calibracion', fecha: c.fecha, titulo: 'Calibraci√≥n anual', lab: c.lab, cert: c.cert, resultado: c.resultado, vigencia: c.vigencia }));
    verifs.forEach(v => events.push({ tipo: v.global==='fail'?'verificacion_fail':'verificacion_ok', fecha: v.fecha, titulo: `Verificaci√≥n ‚Äî ${v.global==='pass'?'PASA':'FALLA'}`, patron: v.patron, tecnico: v.tecnico, params: v.params, notas: v.notas }));
    events.sort((a,b) => a.fecha<b.fecha?1:-1);

    return `<div class="card" style="margin-bottom:20px;">
      <div class="card-header" style="margin-bottom:12px;">
        <div>
          <div class="card-title">${tipoIcons[foto.tipo]||'üìü'} ${foto.nombre}</div>
          <div style="font-size:12px;color:var(--text2);margin-top:2px">${foto.param} ¬∑ ${foto.ubicacion}</div>
        </div>
        <span class="card-serial">${foto.serie}</span>
      </div>
      ${events.length ? buildTimeline(events) : '<div style="font-size:13px;color:var(--text2);padding:8px 0">Sin registros</div>'}
    </div>`;
  }).join('');

  document.getElementById('trazContent').innerHTML = html;
}

function buildTimeline(events) {
  const icons = { calibracion:'üîß', verificacion_ok:'‚úÖ', verificacion_fail:'‚ùå' };
  return '<div class="timeline">' + events.map(e => `
    <div class="timeline-item">
      <div class="timeline-dot ${e.tipo}">${icons[e.tipo]}</div>
      <div class="timeline-body">
        <div class="timeline-title">${e.titulo}</div>
        <div class="timeline-date">${fmtDate(e.fecha)}</div>
        ${e.lab ? `<div class="timeline-note">üè¢ ${e.lab}${e.cert?` ¬∑ Cert: ${e.cert}`:''}</div>` : ''}
        ${e.resultado ? `<div class="timeline-note">üìä ${e.resultado}</div>` : ''}
        ${e.vigencia ? `<div class="timeline-note">üìÖ V√°lida hasta: ${fmtDate(e.vigencia)}</div>` : ''}
        ${e.tecnico ? `<div class="timeline-note">üë§ T√©cnico: ${e.tecnico}</div>` : ''}
        ${e.params && e.params.length ? `<div style="margin-top:4px;display:flex;flex-direction:column;gap:2px;">
          ${e.params.map(p => {
            const v = p.patron && p.obtenido ? `${p.patron} ‚Üí ${p.obtenido}` : (p.valor||'');
            return `<div style="font-size:12px;color:var(--text2)">‚Ä¢ ${p.nombre}${p.kit?` [${p.kit}]`:''}: <span style="font-family:var(--mono)">${v}</span> <span style="color:${p.status==='pass'?'var(--accent2)':'var(--danger)'}">${p.status==='pass'?'‚úì':'‚úó'}</span></div>`;
          }).join('')}
        </div>` : ''}
        ${e.notas ? `<div class="timeline-note" style="font-style:italic">üí¨ ${e.notas}</div>` : ''}
      </div>
    </div>
  `).join('') + '</div>';
}

// ============================================================
//  MODALS
// ============================================================
function openFab() { openModal('modalFab'); }

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
function openModal(id) {
  document.getElementById(id).classList.add('open');
}

// Cerrar al clic en overlay
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

function openFotometro(id = null) {
  document.getElementById('mFotoId').value = id || '';
  if (id) {
    const f = getFotos().find(x => x.id === id);
    document.getElementById('mFotoTitle').textContent = 'Editar Equipo';
    document.getElementById('mFotoTipo').value = f.tipo || 'fotometro';
    document.getElementById('mFotoNombre').value = f.nombre;
    document.getElementById('mFotoSerie').value = f.serie;
    document.getElementById('mFotoParam').value = f.param;
    document.getElementById('mFotoUbic').value = f.ubicacion;
    document.getElementById('mFotoEstado').value = f.estado;
    document.getElementById('mFotoCalFecha').value = f.calFecha || '';
    document.getElementById('mFotoLab').value = f.calLab || '';
    document.getElementById('mFotoCert').value = f.calCert || '';
    document.getElementById('mFotoNotas').value = f.notas || '';
  } else {
    document.getElementById('mFotoTitle').textContent = 'Nuevo Equipo';
    document.getElementById('mFotoTipo').value = 'fotometro';
    document.getElementById('mFotoNombre').value = '';
    document.getElementById('mFotoSerie').value = '';
    document.getElementById('mFotoUbic').value = '';
    document.getElementById('mFotoCalFecha').value = today();
    document.getElementById('mFotoLab').value = '';
    document.getElementById('mFotoCert').value = '';
    document.getElementById('mFotoNotas').value = '';
  }
  openModal('modalFotometro');
}

function saveFotometro() {
  const id = document.getElementById('mFotoId').value;
  const nombre = document.getElementById('mFotoNombre').value.trim();
  if (!nombre) { alert('El nombre es obligatorio'); return; }
  const tipoIcons = { fotometro:'üìü', turbidimetro:'üíß', termometro:'üå°Ô∏è', otro:'üîß' };
  const tipo = document.getElementById('mFotoTipo').value;
  const obj = {
    id: id || DB.id(),
    tipo,
    nombre,
    serie: document.getElementById('mFotoSerie').value.trim(),
    param: document.getElementById('mFotoParam').value,
    ubicacion: document.getElementById('mFotoUbic').value.trim(),
    estado: document.getElementById('mFotoEstado').value,
    calFecha: document.getElementById('mFotoCalFecha').value,
    calLab: document.getElementById('mFotoLab').value.trim(),
    calCert: document.getElementById('mFotoCert').value.trim(),
    notas: document.getElementById('mFotoNotas').value.trim(),
  };
  const fotos = getFotos();
  if (id) {
    const idx = fotos.findIndex(f => f.id === id);
    fotos[idx] = obj;
  } else {
    fotos.push(obj);
  }
  setFotos(fotos);
  closeModal('modalFotometro');
  saveToGitHub();
  renderAll();
}

function makeParamBlock(n = 1) {
  return `<div class="param-block" data-param>
    <div class="param-block-header">
      <div class="form-group" style="margin:0">
        <label class="form-label">Par√°metro</label>
        <input list="paramSuggestions" class="form-input param-name" placeholder="Cloro libre, pH..." value="">
      </div>
      <div class="form-group" style="margin:0">
        <label class="form-label">Kit / Referencia patr√≥n</label>
        <input type="text" class="form-input param-kit" placeholder="HI97701-11, lote 24B03...">
      </div>
      <button class="param-remove" onclick="removeParamBlock(this)" title="Eliminar par√°metro">‚úï</button>
    </div>
    <div class="param-block-values">
      <div class="form-group" style="margin:0">
        <label class="form-label">Valor patr√≥n</label>
        <input type="text" class="form-input param-patron" placeholder="1.00 mg/L">
      </div>
      <div class="form-group" style="margin:0">
        <label class="form-label">Valor obtenido</label>
        <input type="text" class="form-input param-obtenido" placeholder="1.02 mg/L">
      </div>
      <div>
        <label class="form-label">OK</label>
        <div class="result-status" onclick="toggleStatus(this)" title="Toca para cambiar">‚Äî</div>
      </div>
    </div>
  </div>`;
}

function openVerif(fotoId = null) {
  const fotos = getFotos().filter(f => f.estado === 'activo');
  const tipoIcons = { fotometro:'üìü', turbidimetro:'üíß', termometro:'üå°Ô∏è', otro:'üîß' };
  const sel = document.getElementById('mVerifFoto');
  sel.innerHTML = fotos.map(f => `<option value="${f.id}" ${f.id===fotoId?'selected':''}>${tipoIcons[f.tipo]||'üìü'} ${f.nombre}</option>`).join('');
  document.getElementById('mVerifFecha').value = today();
  document.getElementById('mVerifTecnico').value = '';
  document.getElementById('mVerifNotas').value = '';
  document.getElementById('verifParams').innerHTML = makeParamBlock(1);
  openModal('modalVerif');
}

function addParamRow() {
  const container = document.getElementById('verifParams');
  const n = container.querySelectorAll('[data-param]').length + 1;
  container.insertAdjacentHTML('beforeend', makeParamBlock(n));
}

function removeParamBlock(btn) {
  const container = document.getElementById('verifParams');
  if (container.querySelectorAll('[data-param]').length <= 1) return; // m√≠nimo 1
  btn.closest('[data-param]').remove();
}

function toggleStatus(el) {
  if (!el.classList.contains('pass') && !el.classList.contains('fail')) {
    el.classList.add('pass'); el.textContent = '‚úì';
  } else if (el.classList.contains('pass')) {
    el.classList.remove('pass'); el.classList.add('fail'); el.textContent = '‚úó';
  } else {
    el.classList.remove('fail'); el.textContent = '‚Äî';
  }
}

function saveVerificacion() {
  const fotoId = document.getElementById('mVerifFoto').value;
  const fecha = document.getElementById('mVerifFecha').value;
  if (!fotoId || !fecha) { alert('Selecciona equipo y fecha'); return; }

  const blocks = [...document.querySelectorAll('[data-param]')];
  const params = blocks.map(b => {
    const nombre = b.querySelector('.param-name').value.trim();
    const kit = b.querySelector('.param-kit').value.trim();
    const patron = b.querySelector('.param-patron').value.trim();
    const obtenido = b.querySelector('.param-obtenido').value.trim();
    const statusEl = b.querySelector('.result-status');
    const status = statusEl.classList.contains('pass') ? 'pass'
                 : statusEl.classList.contains('fail') ? 'fail' : 'pass';
    return { nombre: nombre || `Par√°metro`, kit, patron, obtenido, status };
  });

  const global = params.some(p => p.status === 'fail') ? 'fail' : 'pass';

  const obj = {
    id: DB.id(), fotoId, fecha,
    patron: params.map(p => p.kit).filter(Boolean).join('; '), // campo legado
    tecnico: document.getElementById('mVerifTecnico').value.trim(),
    params, global,
    notas: document.getElementById('mVerifNotas').value.trim(),
  };

  const all = getVerifs();
  all.push(obj);
  setVerifs(all);
  closeModal('modalVerif');
  saveToGitHub();
  renderAll();
}

function openCalAnual() {
  const fotos = getFotos().filter(f => f.estado === 'activo');
  document.getElementById('mCalFoto').innerHTML = fotos.map(f => `<option value="${f.id}">${f.nombre}</option>`).join('');
  document.getElementById('mCalFecha').value = today();
  document.getElementById('mCalLab').value = '';
  document.getElementById('mCalCert').value = '';
  document.getElementById('mCalResultado').value = '';
  document.getElementById('mCalNotas').value = '';
  // Auto vigencia = 1 a√±o
  const vig = new Date(); vig.setFullYear(vig.getFullYear()+1);
  document.getElementById('mCalVigencia').value = vig.toISOString().slice(0,10);
  openModal('modalCalAnual');
}

function saveCalAnual() {
  const fotoId = document.getElementById('mCalFoto').value;
  const fecha = document.getElementById('mCalFecha').value;
  if (!fotoId || !fecha) { alert('Selecciona fot√≥metro y fecha'); return; }
  const obj = {
    id: DB.id(), fotoId, fecha,
    lab: document.getElementById('mCalLab').value.trim(),
    cert: document.getElementById('mCalCert').value.trim(),
    resultado: document.getElementById('mCalResultado').value.trim(),
    vigencia: document.getElementById('mCalVigencia').value,
    notas: document.getElementById('mCalNotas').value.trim(),
  };
  // Actualizar tambi√©n la fecha en el fot√≥metro
  const fotos = getFotos();
  const idx = fotos.findIndex(f => f.id === fotoId);
  if (idx >= 0 && (!fotos[idx].calFecha || obj.fecha > fotos[idx].calFecha)) {
    fotos[idx].calFecha = obj.fecha;
    fotos[idx].calLab = obj.lab;
    fotos[idx].calCert = obj.cert;
    setFotos(fotos);
  }
  const all = getCals();
  all.push(obj);
  setCals(all);
  closeModal('modalCalAnual');
  saveToGitHub();
  renderAll();
}

// ============================================================
//  DETALLE FOT√ìMETRO
// ============================================================
let detalleFotoId = null;
function showDetalle(id) {
  detalleFotoId = id;
  const foto = getFotos().find(f => f.id === id);
  const s = getDeviceStatus(foto);
  const verifs = getVerifs().filter(v => v.fotoId === id).sort((a,b)=>a.fecha<b.fecha?1:-1);
  const lastV = verifs[0];

  document.getElementById('detalleContent').innerHTML = `
    <div style="margin-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:6px;">
        <div style="font-size:17px;font-weight:700;">${foto.nombre}</div>
        <span class="card-serial">${foto.serie}</span>
      </div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:12px">${foto.param} ¬∑ ${foto.ubicacion}</div>
      <span class="badge ${s.overall}">${{ok:'CORRECTO',warn:'ATENCI√ìN',danger:'VENCIDO'}[s.overall]}</span>
    </div>
    <div class="form-divider"></div>
    <div class="section-label" style="margin-top:12px;">Calibraci√≥n anual</div>
    <div class="card-meta" style="margin-bottom:12px;">
      <div class="meta-item"><div class="meta-label">√öltima</div><div class="meta-value ${s.calStatus}">${fmtDate(s.lastCal)}</div></div>
      <div class="meta-item"><div class="meta-label">Pr√≥xima</div><div class="meta-value ${s.calStatus}">${fmtDate(s.nextCal)}</div></div>
      <div class="meta-item"><div class="meta-label">Laboratorio</div><div class="meta-value" style="font-size:12px">${foto.calLab||'‚Äî'}</div></div>
      <div class="meta-item"><div class="meta-label">Certificado</div><div class="meta-value" style="font-size:12px;color:var(--accent)">${foto.calCert||'‚Äî'}</div></div>
    </div>
    <div class="section-label">√öltima verificaci√≥n mensual</div>
    ${lastV ? `<div class="card-meta">
      <div class="meta-item"><div class="meta-label">Fecha</div><div class="meta-value ${s.verifStatus}">${fmtDate(lastV.fecha)}</div></div>
      <div class="meta-item"><div class="meta-label">Resultado</div><span class="badge ${lastV.global==='pass'?'ok':'danger'}">${lastV.global==='pass'?'PASA':'FALLA'}</span></div>
      <div class="meta-item"><div class="meta-label">T√©cnico</div><div class="meta-value" style="font-size:12px">${lastV.tecnico||'‚Äî'}</div></div>
      <div class="meta-item"><div class="meta-label">Patr√≥n</div><div class="meta-value" style="font-size:12px">${lastV.patron||'‚Äî'}</div></div>
    </div>` : '<div style="font-size:13px;color:var(--text2)">Sin verificaciones registradas</div>'}
    <div style="display:flex;gap:8px;margin-top:14px;">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('modalDetalle');openVerif('${foto.id}')">üß™ Nueva verificaci√≥n</button>
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('modalDetalle');openCalAnual()">üìã Nueva calibraci√≥n</button>
    </div>
    ${foto.notas ? `<div style="margin-top:12px;font-size:12px;color:var(--text2);padding:10px;background:var(--bg);border-radius:8px;">${foto.notas}</div>` : ''}
  `;
  openModal('modalDetalle');
}

function editFotometro() {
  closeModal('modalDetalle');
  openFotometro(detalleFotoId);
}

function confirmDelete() {
  openModal('confirmDialog');
}
function closeConfirm() { closeModal('confirmDialog'); }
function doDelete() {
  setFotos(getFotos().filter(f => f.id !== detalleFotoId));
  setVerifs(getVerifs().filter(v => v.fotoId !== detalleFotoId));
  setCals(getCals().filter(c => c.fotoId !== detalleFotoId));
  closeModal('confirmDialog');
  closeModal('modalDetalle');
  saveToGitHub();
  renderAll();
}

// Fix confirm dialog close
document.getElementById('confirmDialog').addEventListener('click', e => {
  if (e.target === document.getElementById('confirmDialog')) closeConfirm();
});

// ============================================================
//  NAVEGACI√ìN
// ============================================================
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'trazabilidad') renderTrazSelector();
}

// ============================================================
//  EXPORTAR CSV
// ============================================================
function exportCSV() {
  const fotos = getFotos();
  const verifs = getVerifs();
  const cals = getCals();

  // --- Hoja 1: Fot√≥metros ---
  let csv = 'FOT√ìMETROS\n';
  csv += 'Nombre,N¬∫ Serie,Par√°metro,Ubicaci√≥n,Estado,√ölt. Cal. Anual,Laboratorio,N¬∫ Certificado,Notas\n';
  fotos.forEach(f => {
    csv += [f.nombre, f.serie, f.param, f.ubicacion, f.estado, f.calFecha||'', f.calLab||'', f.calCert||'', (f.notas||'').replace(/,/g,' ')].map(v => `"${v}"`).join(',') + '\n';
  });

  csv += '\nVERIFICACIONES MENSUALES\n';
  csv += 'Fot√≥metro,N¬∫ Serie,Fecha,Patr√≥n/Kit,Par√°metros,T√©cnico,Resultado Global,Observaciones\n';
  verifs.sort((a,b)=>a.fecha<b.fecha?1:-1).forEach(v => {
    const foto = fotos.find(f => f.id === v.fotoId);
    const paramsStr = (v.params||[]).map(p=>`${p.nombre}: ${p.valor} [${p.status==='pass'?'OK':'FALLO'}]`).join(' | ');
    csv += [foto?.nombre||'‚Äî', foto?.serie||'‚Äî', v.fecha, v.patron||'', paramsStr, v.tecnico||'', v.global==='pass'?'PASA':'FALLA', (v.notas||'').replace(/,/g,' ')].map(v=>`"${v}"`).join(',') + '\n';
  });

  csv += '\nCALIBRACIONES ANUALES (ADICIONALES)\n';
  csv += 'Fot√≥metro,N¬∫ Serie,Fecha,Laboratorio,N¬∫ Certificado,Resultado/Incertidumbre,V√°lida hasta,Observaciones\n';
  cals.sort((a,b)=>a.fecha<b.fecha?1:-1).forEach(c => {
    const foto = fotos.find(f => f.id === c.fotoId);
    csv += [foto?.nombre||'‚Äî', foto?.serie||'‚Äî', c.fecha, c.lab||'', c.cert||'', c.resultado||'', c.vigencia||'', (c.notas||'').replace(/,/g,' ')].map(v=>`"${v}"`).join(',') + '\n';
  });

  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `FotoCalib_${today()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ============================================================
//  EXPORTAR PDF (ventana de impresi√≥n con estilos propios)
// ============================================================
function exportPDF() {
  const fotos = getFotos();
  const verifs = getVerifs().sort((a,b)=>a.fecha<b.fecha?1:-1);
  const cals = getCals().sort((a,b)=>a.fecha<b.fecha?1:-1);
  const nowStr = new Date().toLocaleDateString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric'});

  const statusBadge = (s, label) => {
    const colors = {ok:'#00a86b', warn:'#cc8800', danger:'#cc2233', pass:'#00a86b', fail:'#cc2233'};
    const labels = {ok:'CORRECTO', warn:'ATENCI√ìN', danger:'VENCIDO', pass:'PASA', fail:'FALLA'};
    const c = colors[s] || '#666';
    return `<span style="background:${c}20;color:${c};border:1px solid ${c}40;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">${label||labels[s]||s.toUpperCase()}</span>`;
  };

  let html = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">
<title>FotoCalib ‚Äî Informe ${nowStr}</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, sans-serif; font-size: 12px; color: #111; background: #fff; padding: 20px; }
  h1 { font-size: 20px; color: #003366; margin-bottom: 4px; }
  .subtitle { font-size: 11px; color: #555; margin-bottom: 20px; }
  h2 { font-size: 14px; color: #003366; border-bottom: 2px solid #003366; padding-bottom: 4px; margin: 20px 0 10px; }
  h3 { font-size: 13px; color: #333; margin: 14px 0 6px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 12px; font-size: 11px; }
  th { background: #003366; color: #fff; padding: 6px 8px; text-align: left; }
  td { padding: 5px 8px; border-bottom: 1px solid #dde; vertical-align: top; }
  tr:nth-child(even) td { background: #f5f8ff; }
  .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; }
  .ok { background: #e6f9f0; color: #006633; }
  .danger { background: #fde8ea; color: #cc2233; }
  .warn { background: #fff5cc; color: #886600; }
  .mono { font-family: 'Courier New', monospace; }
  .page-break { page-break-after: always; }
  .header-bar { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #003366; padding-bottom: 12px; margin-bottom: 16px; }
  .logo-text { font-size: 24px; font-weight: 900; color: #003366; letter-spacing: -1px; }
  .logo-sub { font-size: 10px; color: #666; }
  footer { margin-top: 24px; border-top: 1px solid #dde; padding-top: 8px; font-size: 10px; color: #888; display: flex; justify-content: space-between; }
  @media print {
    body { padding: 10px; }
    .no-print { display: none; }
    @page { margin: 15mm; size: A4; }
  }
</style></head><body>`;

  html += `<div class="header-bar">
    <div><div class="logo-text">FotoCalib</div><div class="logo-sub">Gesti√≥n de calibraciones de fot√≥metros ¬∑ RD 3/2023 ¬∑ RD 487/2022</div></div>
    <div style="text-align:right;font-size:11px;color:#555;">Fecha de informe: <strong>${nowStr}</strong><br>Total fot√≥metros: <strong>${fotos.length}</strong></div>
  </div>`;

  // --- SECCI√ìN FOT√ìMETROS ---
  html += `<h2>üìü Fot√≥metros registrados</h2>
  <table>
    <thead><tr><th>Nombre / Modelo</th><th>N¬∫ Serie</th><th>Par√°metro</th><th>Ubicaci√≥n</th><th>√ölt. Calibraci√≥n</th><th>Laboratorio</th><th>Certificado</th><th>Estado</th></tr></thead>
    <tbody>`;
  fotos.forEach(f => {
    const s = getDeviceStatus(f);
    html += `<tr>
      <td><strong>${f.nombre}</strong></td>
      <td class="mono">${f.serie||'‚Äî'}</td>
      <td>${f.param}</td>
      <td>${f.ubicacion||'‚Äî'}</td>
      <td class="mono">${fmtDate(f.calFecha)}</td>
      <td>${f.calLab||'‚Äî'}</td>
      <td class="mono">${f.calCert||'‚Äî'}</td>
      <td><span class="badge ${s.overall}">${{ok:'CORRECTO',warn:'ATENCI√ìN',danger:'VENCIDO'}[s.overall]}</span></td>
    </tr>`;
  });
  html += `</tbody></table>`;

  // --- SECCI√ìN CALIBRACIONES ANUALES ---
  const allCals = [];
  fotos.forEach(f => { if(f.calFecha) allCals.push({...f, fecha: f.calFecha, lab: f.calLab, cert: f.calCert, resultado: '', vigencia: nextCalDate(f.calFecha), notas: f.notas, _type:'inicial'}); });
  cals.forEach(c => { const f = fotos.find(x=>x.id===c.fotoId); allCals.push({...c, nombre: f?.nombre||'‚Äî', serie: f?.serie||'‚Äî', _type:'adicional'}); });
  allCals.sort((a,b)=>a.fecha<b.fecha?1:-1);

  html += `<h2>üìã Calibraciones anuales</h2>
  <table>
    <thead><tr><th>Fot√≥metro</th><th>N¬∫ Serie</th><th>Fecha</th><th>Laboratorio</th><th>Certificado</th><th>Resultado</th><th>V√°lida hasta</th></tr></thead>
    <tbody>`;
  allCals.forEach(c => {
    html += `<tr>
      <td><strong>${c.nombre||c.nombre}</strong></td>
      <td class="mono">${c.serie||'‚Äî'}</td>
      <td class="mono">${fmtDate(c.fecha)}</td>
      <td>${c.lab||c.calLab||'‚Äî'}</td>
      <td class="mono">${c.cert||c.calCert||'‚Äî'}</td>
      <td>${c.resultado||'‚Äî'}</td>
      <td class="mono">${fmtDate(c.vigencia)}</td>
    </tr>`;
  });
  html += `</tbody></table>`;

  // --- SECCI√ìN VERIFICACIONES ---
  html += `<h2>üß™ Verificaciones mensuales (historial completo)</h2>`;

  fotos.forEach(f => {
    const fv = verifs.filter(v => v.fotoId === f.id);
    if (!fv.length) return;
    html += `<h3>${f.nombre} <span class="mono" style="font-weight:400;color:#666;">(${f.serie})</span></h3>
    <table>
      <thead><tr><th>Fecha</th><th>Patr√≥n / Kit</th><th>Par√°metros verificados</th><th>T√©cnico</th><th>Resultado</th><th>Observaciones</th></tr></thead>
      <tbody>`;
    fv.forEach(v => {
      const paramsStr = (v.params||[]).map(p=>{
        const v2 = p.patron && p.obtenido ? `Patr√≥n: ${p.patron} ‚Üí Obtenido: ${p.obtenido}` : (p.valor||'');
        return `${p.nombre}${p.kit?` [${p.kit}]`:''}: ${v2} [${p.status==='pass'?'OK':'FALLO'}]`;
      }).join('<br>');
      html += `<tr>
        <td class="mono">${fmtDate(v.fecha)}</td>
        <td>${v.patron||'‚Äî'}</td>
        <td>${paramsStr}</td>
        <td>${v.tecnico||'‚Äî'}</td>
        <td><span class="badge ${v.global==='pass'?'ok':'danger'}">${v.global==='pass'?'PASA':'FALLA'}</span></td>
        <td style="font-style:italic;color:#666;">${v.notas||''}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
  });

  html += `<footer>
    <span>FotoCalib ¬∑ RD 3/2023 ¬∑ RD 487/2022 ‚Äî Informe generado el ${nowStr}</span>
    <span>Documento de trazabilidad de fot√≥metros</span>
  </footer>
  <div class="no-print" style="text-align:center;margin:20px;">
    <button onclick="window.print()" style="padding:10px 24px;background:#003366;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;">üñ®Ô∏è Imprimir / Guardar PDF</button>
    <button onclick="window.close()" style="padding:10px 24px;background:#eee;color:#333;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-left:8px;">Cerrar</button>
  </div>
  </body></html>`;

  const w = window.open('', '_blank', 'width=900,height=700');
  w.document.write(html);
  w.document.close();
}

// ============================================================
//  IMPRIMIR VERIFICACI√ìN INDIVIDUAL
// ============================================================
function printVerif(verifId) {
  const v = getVerifs().find(x => x.id === verifId);
  if (!v) return;
  const foto = getFotos().find(f => f.id === v.fotoId);
  const nowStr = new Date().toLocaleDateString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric'});
  const passFail = v.global === 'pass';

  const paramsTable = (v.params||[]).map(p => {
    const patron = p.patron || (p.valor ? p.valor.split('‚Üí')[0]?.trim() : '‚Äî');
    const obtenido = p.obtenido || (p.valor ? p.valor.split('‚Üí')[1]?.trim() : '‚Äî');
    return `<tr>
      <td><strong>${p.nombre}</strong></td>
      <td>${p.kit||'‚Äî'}</td>
      <td class="mono">${patron||'‚Äî'}</td>
      <td class="mono">${obtenido||'‚Äî'}</td>
      <td style="text-align:center;font-size:16px;color:${p.status==='pass'?'#006633':'#cc2233'}">${p.status==='pass'?'‚úì':'‚úó'}</td>
    </tr>`;
  }).join('');

  const html = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">
<title>Verificaci√≥n ${fmtDate(v.fecha)} ‚Äî ${foto?.nombre||'Equipo'}</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, sans-serif; font-size: 12px; color: #111; padding: 20px; }
  .header { display:flex;justify-content:space-between;align-items:flex-start;border-bottom:3px solid #003366;padding-bottom:12px;margin-bottom:16px; }
  .logo { font-size:22px;font-weight:900;color:#003366; }
  .logo-sub { font-size:10px;color:#666;margin-top:2px; }
  h2 { font-size:14px;color:#003366;border-bottom:1px solid #dde;padding-bottom:4px;margin:16px 0 10px; }
  table { width:100%;border-collapse:collapse;font-size:11px; }
  th { background:#003366;color:#fff;padding:6px 8px;text-align:left; }
  td { padding:5px 8px;border-bottom:1px solid #dde; }
  tr:nth-child(even) td { background:#f5f8ff; }
  .info-grid { display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px; }
  .info-box { background:#f5f8ff;border:1px solid #dde;border-radius:4px;padding:10px; }
  .info-label { font-size:10px;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px; }
  .info-val { font-size:13px;font-weight:700; }
  .mono { font-family:'Courier New',monospace; }
  .badge { display:inline-block;padding:4px 12px;border-radius:4px;font-size:12px;font-weight:700; }
  .pass { background:#e6f9f0;color:#006633;border:1px solid #00a86b40; }
  .fail { background:#fde8ea;color:#cc2233;border:1px solid #cc223340; }
  footer { margin-top:24px;border-top:1px solid #dde;padding-top:8px;font-size:10px;color:#888;display:flex;justify-content:space-between; }
  .sign-box { display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px; }
  .sign-line { border-top:1px solid #333;margin-top:32px;padding-top:4px;font-size:10px;color:#666; }
  @media print { .no-print { display:none; } @page { margin:15mm;size:A4; } }
</style></head><body>
<div class="header">
  <div><div class="logo">FotoCalib</div><div class="logo-sub">Verificaci√≥n de equipo de medida ¬∑ RD 3/2023 ¬∑ RD 487/2022</div></div>
  <div style="text-align:right;font-size:11px;color:#555;">Fecha: <strong>${fmtDate(v.fecha)}</strong><br>Informe: <strong>${nowStr}</strong></div>
</div>

<div class="info-grid">
  <div class="info-box">
    <div class="info-label">Equipo</div>
    <div class="info-val">${foto?.nombre||'‚Äî'}</div>
    <div style="font-size:11px;color:#666;margin-top:2px">${foto?.param||''} ¬∑ ${foto?.ubicacion||''}</div>
  </div>
  <div class="info-box">
    <div class="info-label">N¬∫ Serie</div>
    <div class="info-val mono">${foto?.serie||'‚Äî'}</div>
  </div>
  <div class="info-box">
    <div class="info-label">T√©cnico responsable</div>
    <div class="info-val">${v.tecnico||'‚Äî'}</div>
  </div>
  <div class="info-box">
    <div class="info-label">Resultado global</div>
    <div><span class="badge ${passFail?'pass':'fail'}">${passFail?'‚úì PASA':'‚úó FALLA'}</span></div>
  </div>
</div>

<h2>Resultados por par√°metro</h2>
<table>
  <thead><tr><th>Par√°metro</th><th>Kit / Referencia patr√≥n</th><th>Valor patr√≥n</th><th>Valor obtenido</th><th style="text-align:center">Resultado</th></tr></thead>
  <tbody>${paramsTable}</tbody>
</table>

${v.notas ? `<div style="margin-top:14px;background:#fff8dc;border:1px solid #ddc;padding:10px;border-radius:4px;font-size:12px;"><strong>Observaciones / Acciones correctoras:</strong><br>${v.notas}</div>` : ''}

<div class="sign-box">
  <div><div class="sign-line">Firma del t√©cnico responsable</div></div>
  <div><div class="sign-line">Visto bueno / Responsable instalaci√≥n</div></div>
</div>

<footer>
  <span>FotoCalib ¬∑ RD 3/2023 ¬∑ RD 487/2022 ‚Äî Verificaci√≥n mensual de equipo de medida</span>
  <span>Generado: ${nowStr}</span>
</footer>

<div class="no-print" style="text-align:center;margin:20px;">
  <button onclick="window.print()" style="padding:10px 24px;background:#003366;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;">üñ®Ô∏è Imprimir / Guardar PDF</button>
  <button onclick="window.close()" style="padding:10px 24px;background:#eee;color:#333;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-left:8px;">Cerrar</button>
</div>
</body></html>`;

  const w = window.open('', '_blank', 'width=900,height=700');
  w.document.write(html);
  w.document.close();
}

// ============================================================
//  IMPRIMIR TRAZABILIDAD
// ============================================================
function printTrazabilidad() {
  const fotoId = document.getElementById('trazSelect').value;
  if (!fotoId) { alert('Selecciona un equipo primero'); return; }

  const fotos = fotoId === '__all__' ? getFotos() : getFotos().filter(f => f.id === fotoId);
  const nowStr = new Date().toLocaleDateString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric'});
  const tipoIcons = { fotometro:'üìü', turbidimetro:'üíß', termometro:'üå°Ô∏è', otro:'üîß' };

  let body = '';
  fotos.forEach(foto => {
    const verifs = getVerifs().filter(v => v.fotoId === foto.id).sort((a,b)=>a.fecha<b.fecha?1:-1);
    const cals = getCals().filter(c => c.fotoId === foto.id).sort((a,b)=>a.fecha<b.fecha?1:-1);

    const allEvents = [];
    if (foto.calFecha) allEvents.push({ tipo:'CAL', fecha: foto.calFecha, titulo:'Calibraci√≥n anual (inicial)', detalle: `Lab: ${foto.calLab||'‚Äî'} ¬∑ Cert: ${foto.calCert||'‚Äî'}`, resultado: '' });
    cals.forEach(c => allEvents.push({ tipo:'CAL', fecha: c.fecha, titulo:'Calibraci√≥n anual', detalle:`Lab: ${c.lab||'‚Äî'} ¬∑ Cert: ${c.cert||'‚Äî'}`, resultado: c.resultado||'', vigencia: c.vigencia }));
    verifs.forEach(v => {
      const paramsStr = (v.params||[]).map(p=>{
        const pval = p.patron && p.obtenido ? `${p.patron} ‚Üí ${p.obtenido}` : (p.valor||'');
        return `${p.nombre}: ${pval} (${p.status==='pass'?'OK':'FALLO'})`;
      }).join(' | ');
      allEvents.push({ tipo: v.global==='pass'?'OK':'FALLO', fecha: v.fecha, titulo:`Verificaci√≥n mensual`, detalle: `T√©cnico: ${v.tecnico||'‚Äî'}`, params: paramsStr, notas: v.notas });
    });
    allEvents.sort((a,b)=>a.fecha<b.fecha?1:-1);

    body += `<h2>${tipoIcons[foto.tipo]||'üìü'} ${foto.nombre} <span class="mono" style="font-size:11px;font-weight:400;color:#666;">(${foto.serie})</span></h2>
    <p style="font-size:11px;color:#666;margin-bottom:8px;">${foto.param} ¬∑ ${foto.ubicacion}</p>
    <table>
      <thead><tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Resultado/Par√°metros</th><th>Observaciones</th></tr></thead>
      <tbody>
    ${allEvents.map(e => `<tr>
      <td class="mono">${fmtDate(e.fecha)}</td>
      <td><span class="badge ${e.tipo==='CAL'?'cal':e.tipo==='OK'?'pass':'fail'}">${e.tipo}</span></td>
      <td>${e.titulo}<br><span style="color:#666;font-size:11px">${e.detalle}</span>${e.vigencia?`<br><span style="color:#666;font-size:11px">V√°lida hasta: ${fmtDate(e.vigencia)}</span>`:''}</td>
      <td style="font-size:11px">${e.resultado||e.params||'‚Äî'}</td>
      <td style="font-size:11px;font-style:italic;color:#666">${e.notas||''}</td>
    </tr>`).join('')}
      </tbody>
    </table>`;
  });

  const html = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">
<title>Trazabilidad ‚Äî FotoCalib</title>
<style>
  * { box-sizing:border-box;margin:0;padding:0; }
  body { font-family:Arial,sans-serif;font-size:12px;color:#111;padding:20px; }
  .header { display:flex;justify-content:space-between;align-items:flex-start;border-bottom:3px solid #003366;padding-bottom:12px;margin-bottom:16px; }
  .logo { font-size:22px;font-weight:900;color:#003366; }
  .logo-sub { font-size:10px;color:#666;margin-top:2px; }
  h2 { font-size:13px;color:#003366;border-bottom:2px solid #003366;padding-bottom:4px;margin:18px 0 6px; }
  table { width:100%;border-collapse:collapse;font-size:11px;margin-bottom:12px; }
  th { background:#003366;color:#fff;padding:5px 8px;text-align:left; }
  td { padding:5px 8px;border-bottom:1px solid #dde;vertical-align:top; }
  tr:nth-child(even) td { background:#f5f8ff; }
  .mono { font-family:'Courier New',monospace; }
  .badge { display:inline-block;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:700; }
  .pass { background:#e6f9f0;color:#006633; }
  .fail { background:#fde8ea;color:#cc2233; }
  .cal { background:#e8f0ff;color:#003366; }
  footer { margin-top:24px;border-top:1px solid #dde;padding-top:8px;font-size:10px;color:#888;display:flex;justify-content:space-between; }
  @media print { .no-print { display:none; } @page { margin:15mm;size:A4; } }
</style></head><body>
<div class="header">
  <div><div class="logo">FotoCalib</div><div class="logo-sub">Trazabilidad de equipos de medida ¬∑ RD 3/2023 ¬∑ RD 487/2022</div></div>
  <div style="text-align:right;font-size:11px;color:#555;">Informe generado: <strong>${nowStr}</strong></div>
</div>
${body}
<footer>
  <span>FotoCalib ¬∑ RD 3/2023 ¬∑ RD 487/2022 ‚Äî Registro de trazabilidad</span>
  <span>Generado: ${nowStr}</span>
</footer>
<div class="no-print" style="text-align:center;margin:20px;">
  <button onclick="window.print()" style="padding:10px 24px;background:#003366;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;">üñ®Ô∏è Imprimir / Guardar PDF</button>
  <button onclick="window.close()" style="padding:10px 24px;background:#eee;color:#333;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-left:8px;">Cerrar</button>
</div>
</body></html>`;

  const w = window.open('', '_blank', 'width=900,height=700');
  w.document.write(html);
  w.document.close();
}

// ============================================================
//  SETTINGS
// ============================================================
function openSettings() {
  document.getElementById('sToken').value = GH.token;
  document.getElementById('settingsStatus').textContent = '';
  // Mostrar aviso si estamos dentro de Claude.ai u otro sandbox
  const isSandboxed = window.location.hostname.includes('claude.ai')
    || window.location.hostname.includes('anthropic')
    || window.location.hostname === '';
  document.getElementById('sandboxWarning').style.display = isSandboxed ? 'block' : 'none';
  openModal('modalSettings');
}

function saveSettings() {
  const token = document.getElementById('sToken').value.trim();
  if (token) localStorage.setItem('fc_gh_token', token);
  else localStorage.removeItem('fc_gh_token');
  closeModal('modalSettings');
  // Recargar desde GitHub con el nuevo token
  loadFromGitHub().then(() => renderAll());
}

async function testGitHub() {
  const token = document.getElementById('sToken').value.trim();
  const el = document.getElementById('settingsStatus');
  el.style.color = 'var(--text2)';
  el.textContent = '‚è≥ Probando‚Ä¶';
  try {
    const res = await fetch(GH.apiUrl, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github+json'
      }
    });
    if (res.ok) {
      el.style.color = 'var(--accent2)';
      el.textContent = '‚úÖ Conexi√≥n correcta. El archivo existe y es accesible.';
    } else if (res.status === 404) {
      el.style.color = 'var(--warn)';
      el.textContent = '‚ö†Ô∏è Token OK pero el archivo no existe a√∫n. Se crear√° al guardar.';
    } else if (res.status === 401) {
      el.style.color = 'var(--danger)';
      el.textContent = '‚ùå Token inv√°lido o sin permisos suficientes.';
    } else {
      el.style.color = 'var(--danger)';
      el.textContent = `‚ùå Error HTTP ${res.status}`;
    }
  } catch(e) {
    // Detectar si es un bloqueo de sandbox (CSP) o error de red real
    const isSandboxed = window.location.hostname.includes('claude.ai')
      || window.location.hostname.includes('anthropic')
      || window.location.hostname === '';
    el.style.color = 'var(--warn)';
    if (isSandboxed) {
      el.innerHTML = '‚ö†Ô∏è <strong style="color:var(--text)">Est√°s dentro de Claude.ai</strong>, que bloquea llamadas externas.<br>Abre el archivo en Safari o en GitHub Pages y funcionar√° perfectamente.';
    } else {
      el.style.color = 'var(--danger)';
      el.textContent = '‚ùå Error de red. ¬øTienes conexi√≥n a internet?';
    }
  }
}

</script>
</body>
</html>