<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tratamientos Pseudomonas</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 40px 30px;
            margin-bottom: 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-content {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .nav-tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 2px solid #bdc3c7;
        }

        .nav-tab {
            flex: 1;
            padding: 18px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: none;
            font-size: 1.1em;
            font-weight: 500;
            color: #34495e;
            border-right: 1px solid #bdc3c7;
        }

        .nav-tab:last-child {
            border-right: none;
        }

        .nav-tab.active {
            background: white;
            color: #e74c3c;
            border-bottom: 3px solid #e74c3c;
            font-weight: 600;
        }

        .nav-tab:hover:not(.active) {
            background: #d5dbdb;
            color: #2c3e50;
        }

        .tab-content {
            display: none;
            padding: 35px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
            border-left: 4px solid #e74c3c;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 1em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #d5dbdb;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px 8px 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .protocol-step {
            background: #f8f9fa;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #27ae60;
            border: 1px solid #e8e8e8;
        }

        .protocol-step.completed {
            background: #d4edda;
            border-left-color: #155724;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: #e74c3c;
            color: white;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .photo-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border: 2px dashed #bdc3c7;
        }

        .photo-section h4 {
            color: #34495e;
            margin-bottom: 10px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e8e8e8;
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .photo-item .delete-photo {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #e74c3c;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            background: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 25px;
            width: 15px;
            height: 15px;
            background: #e74c3c;
            border: 4px solid white;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #ecf0f1;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #ecf0f1;
            overflow: hidden;
            margin: 25px 0;
            border: 1px solid #bdc3c7;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }

        .alert {
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid transparent;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .export-section {
            background: #f8f9fa;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid #e8e8e8;
        }

        .export-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .measurement-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }

        .measurement-table th,
        .measurement-table td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #e8e8e8;
        }

        .measurement-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .measurement-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 25px 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                border-right: none;
                border-bottom: 1px solid #bdc3c7;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }

            .step-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü¶† GESTOR PSEUDOMONAS</h1>
            <p>Sistema de Seguimiento y Documentaci√≥n de Tratamientos</p>
        </div>

        <div class="main-content">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('incident')">üìã Nueva Incidencia</button>
                <button class="nav-tab" onclick="switchTab('protocol')">üî¨ Protocolo</button>
                <button class="nav-tab" onclick="switchTab('tracking')">üìä Seguimiento</button>
                <button class="nav-tab" onclick="switchTab('report')">üìÑ Informe</button>
            </div>

            <!-- Tab 1: Nueva Incidencia -->
            <div id="incident" class="tab-content active">
                <div class="card">
                    <h2>üìã Registro de Nueva Incidencia</h2>
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è IMPORTANTE:</strong> La piscina debe ser cerrada al p√∫blico hasta finalizar el tratamiento seg√∫n protocolo oficial.
                    </div>
                    
                    <form id="incidentForm">
                        <div class="form-group">
                            <label for="poolName">Piscina Afectada:</label>
                            <input type="text" id="poolName" name="poolName" required placeholder="Ej: Piscina Principal, Piscina Infantil...">
                        </div>
                        
                        <div class="form-group">
                            <label for="detectionDate">Fecha y Hora de Detecci√≥n:</label>
                            <input type="datetime-local" id="detectionDate" name="detectionDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="responsible">Responsable del Tratamiento:</label>
                            <input type="text" id="responsible" name="responsible" required placeholder="Nombre completo del responsable">
                        </div>
                        
                        <div class="form-group">
                            <label for="initialPh">pH Inicial:</label>
                            <input type="number" id="initialPh" name="initialPh" step="0.1" min="0" max="14" placeholder="7.2">
                        </div>
                        
                        <div class="form-group">
                            <label for="initialFreeChlorine">Cloro Libre Inicial (ppm):</label>
                            <input type="number" id="initialFreeChlorine" name="initialFreeChlorine" step="0.1" min="0" placeholder="1.0">
                        </div>
                        
                        <div class="form-group">
                            <label for="initialCombinedChlorine">Cloro Combinado Inicial (ppm):</label>
                            <input type="number" id="initialCombinedChlorine" name="initialCombinedChlorine" step="0.1" min="0" placeholder="0.2">
                        </div>
                        
                        <div class="form-group">
                            <label for="temperature">Temperatura del Agua (¬∞C):</label>
                            <input type="number" id="temperature" name="temperature" step="0.1" placeholder="26.5">
                        </div>
                        
                        <div class="form-group">
                            <label for="observations">Observaciones Iniciales:</label>
                            <textarea id="observations" name="observations" rows="4" placeholder="Describe el estado de la piscina, presencia de algas, color del agua, etc."></textarea>
                        </div>

                        <div class="photo-section">
                            <h4>üì∏ Fotograf√≠as Iniciales</h4>
                            <p>Documenta el estado inicial de la piscina, presencia de algas, equipos de medici√≥n, etc.</p>
                            <input type="file" id="incidentPhotos" accept="image/*" multiple style="margin: 10px 0;">
                            <div id="incidentPhotoGrid" class="photo-grid"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">üíæ Registrar Incidencia y Comenzar Protocolo</button>
                    </form>
                </div>
            </div>

            <!-- Tab 2: Protocolo -->
            <div id="protocol" class="tab-content">
                <div class="card">
                    <h2>üî¨ Protocolo de Actuaci√≥n Oficial</h2>
                    <div class="progress-bar">
                        <div class="progress-fill" id="protocolProgress" style="width: 0%"></div>
                    </div>
                    <p><strong><span id="progressText">0</span> de 6 pasos completados</strong> | Progreso del tratamiento</p>
                </div>

                <div class="protocol-step" id="step1">
                    <div class="step-header">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="step-number">1</div>
                            <div>
                                <h3>Limpieza General Completa</h3>
                                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9em;">Preparaci√≥n del √°rea para el tratamiento</p>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="completeStep(1)">‚úÖ Marcar Completado</button>
                    </div>
                    <div style="background: white; padding: 15px; margin: 15px 0; border: 1px solid #e8e8e8;">
                        <p><strong>Procedimiento:</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Limpiar fondo de la piscina completamente</li>
                            <li>Limpiar alrededores y rebosadero perimetral</li>
                            <li>Limpiar skimmers y pre-filtros de part√≠culas</li>
                            <li>Vaciar y limpiar todas las cestillas</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label>Fecha y Hora de Realizaci√≥n:</label>
                        <input type="datetime-local" id="step1Date">
                    </div>
                    <div class="form-group">
                        <label>Observaciones del Proceso:</label>
                        <textarea id="step1Notes" rows="3" placeholder="Detalla el estado encontrado, dificultades, materiales utilizados..."></textarea>
                    </div>
                    <div class="photo-section">
                        <h4>üì∏ Documentaci√≥n Fotogr√°fica</h4>
                        <p>Documenta el antes y despu√©s de la limpieza</p>
                        <input type="file" id="step1Photos" accept="image/*" multiple>
                        <div id="step1PhotoGrid" class="photo-grid"></div>
                    </div>
                </div>

                <div class="protocol-step" id="step2">
                    <div class="step-header">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="step-number">2</div>
                            <div>
                                <h3>Contra-lavado de Filtros</h3>
                                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9em;">Preparaci√≥n del sistema de filtraci√≥n</p>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="completeStep(2)">‚úÖ Marcar Completado</button>
                    </div>
                    <div style="background: white; padding: 15px; margin: 15px 0; border: 1px solid #e8e8e8;">
                        <p><strong>Procedimiento:</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Realizar contra-lavado completo de todos los filtros</li>
                            <li>Verificar el correcto funcionamiento del sistema</li>
                            <li>Asegurar la eliminaci√≥n de residuos acumulados</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label>Fecha y Hora de Realizaci√≥n:</label>
                        <input type="datetime-local" id="step2Date">
                    </div>
                    <div class="form-group">
                        <label>Observaciones del Proceso:</label>
                        <textarea id="step2Notes" rows="3" placeholder="Estado de los filtros, tiempo de contra-lavado, calidad del agua de salida..."></textarea>
                    </div>
                    <div class="photo-section">
                        <h4>üì∏ Documentaci√≥n Fotogr√°fica</h4>
                        <p>Documenta el proceso de contra-lavado y estado de filtros</p>
                        <input type="file" id="step2Photos" accept="image/*" multiple>
                        <div id="step2PhotoGrid" class="photo-grid"></div>
                    </div>
                </div>

                <div class="protocol-step" id="step3">
                    <div class="step-header">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="step-number">3</div>
                            <div>
                                <h3>Tratamiento de Choque</h3>
                                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9em;">Hipercloraci√≥n inicial - CT = 3.600</p>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="completeStep(3)">‚úÖ Marcar Completado</button>
                    </div>
                    <div style="background: white; padding: 15px; margin: 15px 0; border: 1px solid #e8e8e8;">
                        <p><strong>Par√°metros Obligatorios:</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>Cloro libre residual:</strong> 20-30 ppm</li>
                            <li><strong>Tiempo de contacto:</strong> 2-3 horas</li>
                            <li><strong>pH:</strong> mantener entre 7.2-7.5</li>
                            <li><strong>Valor CT requerido:</strong> 3.600</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label>Fecha y Hora de Inicio:</label>
                        <input type="datetime-local" id="step3DateStart">
                    </div>
                    <div class="form-group">
                        <label>Fecha y Hora de Finalizaci√≥n:</label>
                        <input type="datetime-local" id="step3DateEnd">
                    </div>
                    <div class="form-group">
                        <label>Cloro Libre Alcanzado (ppm):</label>
                        <input type="number" id="step3Chlorine" step="0.1" min="20" max="30" placeholder="25.0">
                    </div>
                    <div class="form-group">
                        <label>pH Final:</label>
                        <input type="number" id="step3Ph" step="0.1" min="7.2" max="7.5" placeholder="7.3">
                    </div>
                    <div class="form-group">
                        <label>Observaciones del Proceso:</label>
                        <textarea id="step3Notes" rows="3" placeholder="Cantidad de producto utilizado, m√©todo de aplicaci√≥n, mediciones intermedias..."></textarea>
                    </div>
                    <div class="photo-section">
                        <h4>üì∏ Documentaci√≥n Fotogr√°fica</h4>
                        <p>Documenta las mediciones, equipos utilizados y estado del agua</p>
                        <input type="file" id="step3Photos" accept="image/*" multiple>
                        <div id="step3PhotoGrid" class="photo-grid"></div>
                    </div>
                </div>

                <div class="protocol-step" id="step4">
                    <div class="step-header">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="step-number">4</div>
                            <div>
                                <h3>Hipercloraci√≥n del Sistema</h3>
                                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9em;">Tratamiento de toda la instalaci√≥n</p>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="completeStep(4)">‚úÖ Marcar Completado</button>
                    </div>
                    <div style="background: white; padding: 15px; margin: 15px 0; border: 1px solid #e8e8e8;">
                        <p><strong>Procedimiento Cr√≠tico:</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Asegurar que el agua hiperclorada pase por todo el sistema de filtraci√≥n</li>
                            <li>Abrir by-pass y conectar sistemas auxiliares si existen</li>
                            <li>Poner en marcha cascadas, jets y soplantes</li>
                            <li>Permitir que todos los componentes se inunden con la soluci√≥n</li>
                            <li><strong>‚ö†Ô∏è CR√çTICO:</strong> Los filtros parados son puntos de riesgo</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label>Fecha y Hora de Realizaci√≥n:</label>
                        <input type="datetime-local" id="step4Date">
                    </div>
                    <div class="form-group">
                        <label>Sistemas Activados:</label>
                        <textarea id="step4Systems" rows="2" placeholder="Lista todos los sistemas activados: cascadas, jets, soplantes, by-pass..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Observaciones del Proceso:</label>
                        <textarea id="step4Notes" rows="3" placeholder="Tiempo necesario para inundaci√≥n completa, verificaciones realizadas..."></textarea>
                    </div>
                    <div class="photo-section">
                        <h4>üì∏ Documentaci√≥n Fotogr√°fica</h4>
                        <p>Documenta todos los sistemas en funcionamiento</p>
                        <input type="file" id="step4Photos" accept="image/*" multiple>
                        <div id="step4PhotoGrid" class="photo-grid"></div>
                    </div>
                </div>

                <div class="protocol-step" id="step5">
                    <div class="step-header">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="step-number">5</div>
                            <div>
                                <h3>Segundo Contra-lavado</h3>
                                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9em;">Limpieza post-tratamiento</p>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="completeStep(5)">‚úÖ Marcar Completado</button>
                    </div>
                    <div style="background: white; padding: 15px; margin: 15px 0; border: 1px solid #e8e8e8;">
                        <p><strong>Procedimiento:</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Realizar contra-lavado completo tras el per√≠odo de contacto</li>
                            <li>Eliminar residuos del tratamiento de choque</li>
                            <li>Preparar el sistema para la normalizaci√≥n</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label>Fecha y Hora de Realizaci√≥n:</label>
                        <input type="datetime-local" id="step5Date">
                    </div>
                    <div class="form-group">
                        <label>Observaciones del Proceso:</label>
                        <textarea id="step5Notes" rows="3" placeholder="Calidad del agua de salida, tiempo de contra-lavado, estado final..."></textarea>
                    </div>
                    <div class="photo-section">
                        <h4>üì∏ Documentaci√≥n Fotogr√°fica</h4>
                        <p>Documenta el proceso final de limpieza</p>
                        <input type="file" id="step5Photos" accept="image/*" multiple>
                        <div id="step5PhotoGrid" class="photo-grid"></div>
                    </div>
                </div>

                <div class="protocol-step" id="step6">
                    <div class="step-header">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="step-number">6</div>
                            <div>
                                <h3>Normalizaci√≥n</h3>
                                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9em;">Vuelta a par√°metros normales</p>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="completeStep(6)">‚úÖ Marcar Completado</button>
                    </div>
                    <div style="background: white; padding: 15px; margin: 15px 0; border: 1px solid #e8e8e8;">
                        <p><strong>Par√°metros Finales:</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Reducir cloro libre a valores habituales (1-3 ppm)</li>
                            <li>Verificar pH en rango normal (7.2-7.6)</li>
                            <li>Confirmar que todos los par√°metros son seguros</li>
                            <li><strong>Solo entonces</strong> reabrir al p√∫blico</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label>Fecha y Hora de Normalizaci√≥n:</label>
                        <input type="datetime-local" id="step6Date">
                    </div>
                    <div class="form-group">
                        <label>Cloro Libre Final (ppm):</label>
                        <input type="number" id="step6Chlorine" step="0.1" min="1" max="3" placeholder="1.5">
                    </div>
                    <div class="form-group">
                        <label>pH Final:</label>
                        <input type="number" id="step6Ph" step="0.1" min="7.2" max="7.6" placeholder="7.4">
                    </div>
                    <div class="form-group">
                        <label>Fecha y Hora de Reapertura:</label>
                        <input type="datetime-local" id="step6Reopening">
                    </div>
                    <div class="form-group">
                        <label>Observaciones Finales:</label>
                        <textarea id="step6Notes" rows="3" placeholder="Verificaciones finales, estado del agua, medidas adicionales..."></textarea>
                    </div>
                    <div class="photo-section">
                        <h4>üì∏ Documentaci√≥n Fotogr√°fica</h4>
                        <p>Documenta las mediciones finales y estado final de la piscina</p>
                        <input type="file" id="step6Photos" accept="image/*" multiple>
                        <div id="step6PhotoGrid" class="photo-grid"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Seguimiento -->
            <div id="tracking" class="tab-content">
                <div class="card">
                    <h2>üìä Seguimiento del Tratamiento</h2>
                    <div id="trackingContent">
                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Registra las mediciones peri√≥dicas durante el tratamiento para un seguimiento completo.
                        </div>

                        <div style="margin-bottom: 30px;">
                            <h3>Mediciones Peri√≥dicas</h3>
                            <table class="measurement-table">
                                <thead>
                                    <tr>
                                        <th>Fecha/Hora</th>
                                        <th>pH</th>
                                        <th>Cloro Libre (ppm)</th>
                                        <th>Cloro Combinado (ppm)</th>
                                        <th>Temperatura (¬∞C)</th>
                                        <th>Observaciones</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="measurementTableBody">
                                    <!-- Las mediciones se a√±adir√°n din√°micamente -->
                                </tbody>
                            </table>
                            
                            <button class="btn btn-primary" onclick="addMeasurement()">‚ûï A√±adir Medici√≥n</button>
                        </div>

                        <div class="timeline" id="treatmentTimeline">
                            <!-- Timeline items se a√±adir√°n din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Informe -->
            <div id="report" class="tab-content">
                <div class="card">
                    <h2>üìÑ Generaci√≥n de Informes</h2>
                    
                    <div class="alert alert-success">
                        <strong>‚úÖ Listo para Exportar:</strong> Los informes incluir√°n todas las fotograf√≠as y documentaci√≥n del tratamiento.
                    </div>

                    <div class="export-section">
                        <h3>Opciones de Exportaci√≥n</h3>
                        <div class="export-buttons">
                            <button class="btn btn-danger" onclick="exportToPDF()">üìÑ Generar Informe PDF Completo</button>
                            <button class="btn btn-info" onclick="exportToWord()">üìù Generar Documento Word</button>
                            <button class="btn btn-warning" onclick="exportData()">üíæ Exportar Datos JSON</button>
                        </div>
                    </div>

                    <div class="loading" id="exportLoading">
                        <div class="spinner"></div>
                        <p>Generando documento... Por favor espere.</p>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3>Resumen del Tratamiento</h3>
                        <div id="treatmentSummary">
                            <!-- El resumen se generar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para a√±adir mediciones -->
    <div id="measurementModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3>‚ûï Nueva Medici√≥n</h3>
            <form id="measurementForm">
                <div class="form-group">
                    <label>Fecha y Hora:</label>
                    <input type="datetime-local" id="measurementDateTime" required>
                </div>
                <div class="form-group">
                    <label>pH:</label>
                    <input type="number" id="measurementPh" step="0.1" min="0" max="14" required>
                </div>
                <div class="form-group">
                    <label>Cloro Libre (ppm):</label>
                    <input type="number" id="measurementFreeChlorine" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label>Cloro Combinado (ppm):</label>
                    <input type="number" id="measurementCombinedChlorine" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label>Temperatura (¬∞C):</label>
                    <input type="number" id="measurementTemperature" step="0.1">
                </div>
                <div class="form-group">
                    <label>Observaciones:</label>
                    <textarea id="measurementObservations" rows="2"></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-warning" onclick="closeMeasurementModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar Medici√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales para almacenar datos
        let treatmentData = {
            incident: {},
            protocol: {
                steps: [],
                photos: {}
            },
            measurements: [],
            startDate: null,
            endDate: null
        };

        let completedSteps = 0;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredData();
            setupPhotoHandlers();
            updateProgress();
            generateTreatmentSummary();
            updateTimeline();
        });

        // Funci√≥n para cambiar entre tabs
        function switchTab(tabName) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remover clase active de todos los tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar el contenido seleccionado
            document.getElementById(tabName).classList.add('active');
            
            // Marcar el tab como activo
            event.target.classList.add('active');
        }

        // Manejo del formulario de incidencia
        document.getElementById('incidentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Verificar que los campos obligatorios est√©n completos
            const poolName = document.getElementById('poolName').value.trim();
            const detectionDate = document.getElementById('detectionDate').value;
            const responsible = document.getElementById('responsible').value.trim();
            
            if (!poolName || !detectionDate || !responsible) {
                alert('‚ö†Ô∏è Por favor, completa todos los campos obligatorios.');
                return;
            }
            
            // Capturar todos los datos del formulario
            treatmentData.incident = {
                poolName: poolName,
                detectionDate: detectionDate,
                responsible: responsible,
                initialPh: document.getElementById('initialPh').value,
                initialFreeChlorine: document.getElementById('initialFreeChlorine').value,
                initialCombinedChlorine: document.getElementById('initialCombinedChlorine').value,
                temperature: document.getElementById('temperature').value,
                observations: document.getElementById('observations').value
            };
            
            treatmentData.startDate = new Date();
            saveData();
            
            alert('‚úÖ Incidencia registrada correctamente. Procede con el protocolo de tratamiento.');
            switchTab('protocol');
        });

        // Configurar manejadores de fotos
        function setupPhotoHandlers() {
            // Fotos de incidencia
            document.getElementById('incidentPhotos').addEventListener('change', function(e) {
                handlePhotoUpload(e, 'incidentPhotoGrid');
            });

            // Fotos de pasos del protocolo
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`step${i}Photos`).addEventListener('change', function(e) {
                    handlePhotoUpload(e, `step${i}PhotoGrid`, `step${i}`);
                });
            }
        }

        // Manejo de subida de fotos
        function handlePhotoUpload(event, gridId, stepId = null) {
            const files = event.target.files;
            const grid = document.getElementById(gridId);
            
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Foto del tratamiento';
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-photo';
                        deleteBtn.innerHTML = '√ó';
                        deleteBtn.onclick = function() {
                            photoItem.remove();
                            if (stepId) {
                                saveStepPhotos(stepId);
                            }
                        };
                        
                        photoItem.appendChild(img);
                        photoItem.appendChild(deleteBtn);
                        grid.appendChild(photoItem);
                        
                        // Guardar en datos del tratamiento
                        if (stepId) {
                            if (!treatmentData.protocol.photos[stepId]) {
                                treatmentData.protocol.photos[stepId] = [];
                            }
                            treatmentData.protocol.photos[stepId].push(e.target.result);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Completar paso del protocolo
        function completeStep(stepNumber) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            let dateInput = document.getElementById(`step${stepNumber}Date`);
            const notesInput = document.getElementById(`step${stepNumber}Notes`);
            
            // Para el paso 3, usar la fecha de inicio como referencia principal
            if (stepNumber === 3) {
                const startDateInput = document.getElementById('step3DateStart');
                const endDateInput = document.getElementById('step3DateEnd');
                const chlorineInput = document.getElementById('step3Chlorine');
                const phInput = document.getElementById('step3Ph');
                
                if (!startDateInput.value) {
                    alert('‚ö†Ô∏è Por favor, ingresa la fecha y hora de inicio del tratamiento de choque.');
                    startDateInput.focus();
                    return;
                }
                if (!endDateInput.value) {
                    alert('‚ö†Ô∏è Por favor, ingresa la fecha y hora de finalizaci√≥n del tratamiento de choque.');
                    endDateInput.focus();
                    return;
                }
                if (!chlorineInput.value || chlorineInput.value < 20 || chlorineInput.value > 30) {
                    alert('‚ö†Ô∏è Por favor, ingresa el nivel de cloro libre alcanzado (debe estar entre 20-30 ppm).');
                    chlorineInput.focus();
                    return;
                }
                if (!phInput.value || phInput.value < 7.2 || phInput.value > 7.5) {
                    alert('‚ö†Ô∏è Por favor, ingresa el pH final (debe estar entre 7.2-7.5).');
                    phInput.focus();
                    return;
                }
                dateInput = startDateInput; // Usar fecha de inicio como referencia
            } else if (!dateInput.value) {
                alert('‚ö†Ô∏è Por favor, ingresa la fecha y hora de realizaci√≥n del paso.');
                dateInput.focus();
                return;
            }
            
            stepElement.classList.add('completed');
            
            // Guardar datos del paso
            const stepData = {
                number: stepNumber,
                completed: true,
                date: dateInput.value,
                notes: notesInput.value,
                timestamp: new Date()
            };
            
            // Si es el paso 3, guardar mediciones adicionales
            if (stepNumber === 3) {
                stepData.chlorine = document.getElementById('step3Chlorine').value;
                stepData.ph = document.getElementById('step3Ph').value;
                stepData.startDate = document.getElementById('step3DateStart').value;
                stepData.endDate = document.getElementById('step3DateEnd').value;
            }
            
            // Si es el paso 4, guardar sistemas activados
            if (stepNumber === 4) {
                stepData.systems = document.getElementById('step4Systems').value;
            }
            
            // Si es el paso 6, guardar datos finales
            if (stepNumber === 6) {
                stepData.finalChlorine = document.getElementById('step6Chlorine').value;
                stepData.finalPh = document.getElementById('step6Ph').value;
                stepData.reopeningDate = document.getElementById('step6Reopening').value;
                treatmentData.endDate = new Date();
            }
            
            // Actualizar array de pasos
            const existingStepIndex = treatmentData.protocol.steps.findIndex(s => s.number === stepNumber);
            if (existingStepIndex >= 0) {
                treatmentData.protocol.steps[existingStepIndex] = stepData;
            } else {
                treatmentData.protocol.steps.push(stepData);
            }
            
            // Actualizar progreso
            completedSteps = treatmentData.protocol.steps.filter(s => s.completed).length;
            updateProgress();
            
            // Guardar datos
            saveData();
            
            // Actualizar timeline
            updateTimeline();
            
            alert(`‚úÖ Paso ${stepNumber} completado correctamente.`);
        }

        // Actualizar barra de progreso
        function updateProgress() {
            const progressFill = document.getElementById('protocolProgress');
            const progressText = document.getElementById('progressText');
            
            const percentage = (completedSteps / 6) * 100;
            progressFill.style.width = percentage + '%';
            progressText.textContent = completedSteps;
        }

        // A√±adir medici√≥n
        function addMeasurement() {
            document.getElementById('measurementModal').style.display = 'block';
            document.getElementById('measurementDateTime').value = new Date().toISOString().slice(0, 16);
        }

        // Cerrar modal de medici√≥n
        function closeMeasurementModal() {
            const modal = document.getElementById('measurementModal');
            const form = document.getElementById('measurementForm');
            
            modal.style.display = 'none';
            form.reset();
            
            // Limpiar campos espec√≠ficos por si hay problemas con reset()
            document.getElementById('measurementDateTime').value = '';
            document.getElementById('measurementPh').value = '';
            document.getElementById('measurementFreeChlorine').value = '';
            document.getElementById('measurementCombinedChlorine').value = '';
            document.getElementById('measurementTemperature').value = '';
            document.getElementById('measurementObservations').value = '';
        }

        // Manejo del formulario de medici√≥n
        document.getElementById('measurementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Validar campos obligatorios
            const datetime = document.getElementById('measurementDateTime').value;
            const ph = document.getElementById('measurementPh').value;
            const freeChlorine = document.getElementById('measurementFreeChlorine').value;
            
            if (!datetime || !ph || !freeChlorine) {
                alert('‚ö†Ô∏è Por favor, completa los campos obligatorios: Fecha/Hora, pH y Cloro Libre.');
                return;
            }
            
            const measurement = {
                datetime: datetime,
                ph: parseFloat(ph),
                freeChlorine: parseFloat(freeChlorine),
                combinedChlorine: document.getElementById('measurementCombinedChlorine').value ? parseFloat(document.getElementById('measurementCombinedChlorine').value) : null,
                temperature: document.getElementById('measurementTemperature').value ? parseFloat(document.getElementById('measurementTemperature').value) : null,
                observations: document.getElementById('measurementObservations').value || '',
                timestamp: new Date()
            };
            
            treatmentData.measurements.push(measurement);
            saveData();
            updateMeasurementTable();
            updateTimeline();
            
            // Cerrar modal y limpiar formulario
            closeMeasurementModal();
            
            alert('‚úÖ Medici√≥n a√±adida correctamente.');
        });

        // Actualizar tabla de mediciones
        function updateMeasurementTable() {
            const tbody = document.getElementById('measurementTableBody');
            tbody.innerHTML = '';
            
            treatmentData.measurements.forEach((measurement, index) => {
                const row = tbody.insertRow();
                
                const date = new Date(measurement.datetime);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${measurement.ph}</td>
                    <td>${measurement.freeChlorine}</td>
                    <td>${measurement.combinedChlorine || '-'}</td>
                    <td>${measurement.temperature || '-'}</td>
                    <td>${measurement.observations || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteMeasurement(${index})" style="padding: 5px 10px; font-size: 0.8em;">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        // Eliminar medici√≥n
        function deleteMeasurement(index) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta medici√≥n?')) {
                treatmentData.measurements.splice(index, 1);
                saveData();
                updateMeasurementTable();
                updateTimeline();
            }
        }

        // Actualizar timeline
        function updateTimeline() {
            const timeline = document.getElementById('treatmentTimeline');
            timeline.innerHTML = '';
            
            // Combinar eventos del protocolo y mediciones
            const events = [];
            
            // Eventos del protocolo
            treatmentData.protocol.steps.forEach(step => {
                if (step.completed) {
                    events.push({
                        type: 'protocol',
                        date: new Date(step.date),
                        title: `Paso ${step.number} completado`,
                        description: step.notes || 'Sin observaciones adicionales'
                    });
                }
            });
            
            // Eventos de mediciones
            treatmentData.measurements.forEach(measurement => {
                events.push({
                    type: 'measurement',
                    date: new Date(measurement.datetime),
                    title: 'Medici√≥n registrada',
                    description: `pH: ${measurement.ph}, Cloro: ${measurement.freeChlorine} ppm`
                });
            });
            
            // Ordenar eventos por fecha
            events.sort((a, b) => a.date - b.date);
            
            // Generar timeline
            events.forEach(event => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                
                const formattedDate = event.date.toLocaleDateString() + ' ' + event.date.toLocaleTimeString();
                
                timelineItem.innerHTML = `
                    <h4>${event.title}</h4>
                    <p><strong>Fecha:</strong> ${formattedDate}</p>
                    <p>${event.description}</p>
                `;
                
                timeline.appendChild(timelineItem);
            });
        }

        // Generar resumen del tratamiento
        function generateTreatmentSummary() {
            const summary = document.getElementById('treatmentSummary');
            
            const totalSteps = treatmentData.protocol.steps.length;
            const totalMeasurements = treatmentData.measurements.length;
            const totalPhotos = Object.values(treatmentData.protocol.photos).reduce((total, photos) => total + photos.length, 0);
            
            let duration = 'En curso';
            if (treatmentData.startDate && treatmentData.endDate) {
                const diff = new Date(treatmentData.endDate) - new Date(treatmentData.startDate);
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                duration = `${hours}h ${minutes}m`;
            }
            
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="card" style="text-align: center; margin: 0;">
                        <h4>Pasos Completados</h4>
                        <p style="font-size: 2em; color: #27ae60; margin: 10px 0;">${completedSteps}/6</p>
                    </div>
                    <div class="card" style="text-align: center; margin: 0;">
                        <h4>Mediciones</h4>
                        <p style="font-size: 2em; color: #3498db; margin: 10px 0;">${totalMeasurements}</p>
                    </div>
                    <div class="card" style="text-align: center; margin: 0;">
                        <h4>Fotograf√≠as</h4>
                        <p style="font-size: 2em; color: #f39c12; margin: 10px 0;">${totalPhotos}</p>
                    </div>
                    <div class="card" style="text-align: center; margin: 0;">
                        <h4>Duraci√≥n</h4>
                        <p style="font-size: 2em; color: #e74c3c; margin: 10px 0;">${duration}</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>Estado del Protocolo:</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(completedSteps / 6) * 100}%"></div>
                    </div>
                    <p>${completedSteps === 6 ? '‚úÖ Protocolo completado' : `‚è≥ ${6 - completedSteps} pasos pendientes`}</p>
                </div>
            `;
        }

        // Exportar a PDF
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            showLoading();
            
            try {
                // Configuraci√≥n inicial
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                
                // Funci√≥n para a√±adir nueva p√°gina si es necesario
                function checkPageBreak(neededHeight = 20) {
                    if (yPosition + neededHeight > pageHeight - margin) {
                        doc.addPage();
                        yPosition = 20;
                        return true;
                    }
                    return false;
                }
                
                // Funci√≥n para a√±adir texto con control de p√°ginas
                function addTextWithPageBreak(text, x, y, maxWidth = 170, lineHeight = 5) {
                    const lines = doc.splitTextToSize(text, maxWidth);
                    const totalHeight = lines.length * lineHeight;
                    
                    // Verificar si necesitamos nueva p√°gina
                    if (checkPageBreak(totalHeight)) {
                        y = yPosition;
                    } else {
                        yPosition = y;
                    }
                    
                    doc.text(lines, x, yPosition);
                    yPosition += totalHeight;
                    return yPosition;
                }
                
                // Encabezado del documento
                doc.setFontSize(22);
                doc.setTextColor(44, 62, 80);
                doc.text('MEMORIA T√âCNICA', 20, yPosition);
                yPosition += 10;
                doc.text('TRATAMIENTO DE PSEUDOMONAS AERUGINOSA', 20, yPosition);
                yPosition += 15;
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Fecha de elaboraci√≥n: ${new Date().toLocaleDateString()}`, 20, yPosition);
                yPosition += 8;
                doc.text(`Instalaci√≥n: ${treatmentData.incident.poolName || 'No especificada'}`, 20, yPosition);
                yPosition += 8;
                doc.text(`Responsable: ${treatmentData.incident.responsible || 'No especificado'}`, 20, yPosition);
                yPosition += 25;
                
                // RESUMEN EJECUTIVO
                checkPageBreak(40);
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('RESUMEN EJECUTIVO', 20, yPosition);
                yPosition += 12;
                
                doc.setFontSize(11);
                const detectionDate = treatmentData.incident.detectionDate ? new Date(treatmentData.incident.detectionDate).toLocaleDateString() : 'No especificada';
                const currentCompletedSteps = treatmentData.protocol.steps.filter(s => s.completed).length;
                const protocolStatus = currentCompletedSteps === 6 ? 'completado exitosamente' : `en curso (${currentCompletedSteps}/6 pasos completados)`;
                
                const executiveSummary = `El presente documento constituye la memoria t√©cnica del tratamiento de desinfecci√≥n aplicado contra Pseudomonas aeruginosa en la instalaci√≥n ${treatmentData.incident.poolName || 'especificada'}. La detecci√≥n de la bacteria pat√≥gena se produjo el ${detectionDate}, procedi√©ndose inmediatamente al cierre de la instalaci√≥n seg√∫n normativa vigente.

El protocolo de actuaci√≥n ha sido ${protocolStatus}, siguiendo estrictamente las directrices establecidas para la eliminaci√≥n de Pseudomonas aeruginosa. Todos los procedimientos han sido documentados detalladamente, incluyendo mediciones de par√°metros fisicoqu√≠micos y registros fotogr√°ficos del proceso.

${currentCompletedSteps === 6 ? 'La instalaci√≥n ha sido normalizada y se encuentra en condiciones √≥ptimas para su reapertura al p√∫blico.' : 'El tratamiento se encuentra en fase de ejecuci√≥n, manteni√©ndose la instalaci√≥n cerrada hasta completar todos los pasos del protocolo.'}`;
                
                yPosition = addTextWithPageBreak(executiveSummary, 20, yPosition) + 15;
                
                // 1. ANTECEDENTES Y DETECCI√ìN
                checkPageBreak(40);
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('1. ANTECEDENTES Y DETECCI√ìN', 20, yPosition);
                yPosition += 12;
                
                doc.setFontSize(11);
                const detectionText = `La presencia de Pseudomonas aeruginosa fue detectada el ${treatmentData.incident.detectionDate ? new Date(treatmentData.incident.detectionDate).toLocaleDateString() : 'fecha no especificada'} en la instalaci√≥n ${treatmentData.incident.poolName || 'objeto del presente informe'}. 

Seg√∫n establece la normativa vigente, se procedi√≥ inmediatamente al cierre de la instalaci√≥n al p√∫blicos y se inici√≥ el protocolo de desinfecci√≥n correspondiente bajo la supervisi√≥n de ${treatmentData.incident.responsible || 'personal cualificado'}.

Los par√°metros fisicoqu√≠micos registrados en el momento de la detecci√≥n fueron los siguientes:
- pH del agua: ${treatmentData.incident.initialPh || 'No medido'}
- Cloro libre residual: ${treatmentData.incident.initialFreeChlorine || 'No medido'} ppm
- Cloro combinado: ${treatmentData.incident.initialCombinedChlorine || 'No medido'} ppm
- Temperatura del agua: ${treatmentData.incident.temperature || 'No medida'}¬∞C

${treatmentData.incident.observations ? `Observaciones adicionales del estado inicial: ${treatmentData.incident.observations}` : ''}`;
                
                yPosition = addTextWithPageBreak(detectionText, 20, yPosition) + 15;
                
                // 2. METODOLOG√çA Y PROCEDIMIENTOS APLICADOS
                checkPageBreak(40);
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('2. METODOLOG√çA Y PROCEDIMIENTOS APLICADOS', 20, yPosition);
                yPosition += 12;
                
                doc.setFontSize(11);
                const methodologyText = `El tratamiento aplicado sigue estrictamente el protocolo oficial establecido para la eliminaci√≥n de Pseudomonas aeruginosa en instalaciones acu√°ticas. Este protocolo consta de seis etapas diferenciadas, cada una de ellas cr√≠tica para garantizar la completa desinfecci√≥n de la instalaci√≥n y la seguridad de los usuarios.

La metodolog√≠a implementada se basa en la aplicaci√≥n de un tratamiento de choque con hipoclorito, manteniendo un valor CT (concentraci√≥n √ó tiempo) de 3.600, seguido de procedimientos de limpieza y normalizaci√≥n que aseguran la eliminaci√≥n total del pat√≥geno tanto del agua como de todas las superficies y sistemas de la instalaci√≥n.`;
                
                yPosition = addTextWithPageBreak(methodologyText, 20, yPosition) + 15;
                
                // Descripci√≥n detallada de cada paso
                const stepDescriptions = [
                    {
                        name: 'Limpieza General Completa',
                        description: 'Se procedi√≥ a la limpieza exhaustiva de todas las superficies de la instalaci√≥n, incluyendo fondo de piscina, rebosaderos perimetrales, skimmers y sistema de prefiltrado. Esta etapa es fundamental para eliminar la materia org√°nica que pueda interferir en la eficacia del tratamiento de desinfecci√≥n posterior.'
                    },
                    {
                        name: 'Contra-lavado de Filtros',
                        description: 'Se realiz√≥ un contra-lavado completo del sistema de filtraci√≥n con el objetivo de eliminar los residuos acumulados y preparar el sistema para el tratamiento de choque. Este procedimiento garantiza la m√°xima eficiencia del sistema durante la fase de hipercloraci√≥n.'
                    },
                    {
                        name: 'Tratamiento de Choque - Hipercloraci√≥n',
                        description: 'Se elev√≥ la concentraci√≥n de cloro libre residual hasta 20-30 ppm, manteniendo este nivel durante un per√≠odo de 2-3 horas para alcanzar el valor CT requerido de 3.600. Durante todo el proceso se control√≥ que el pH se mantuviera en el rango √≥ptimo de 7,2-7,5 para maximizar la eficacia del desinfectante.'
                    },
                    {
                        name: 'Hipercloraci√≥n del Sistema Completo',
                        description: 'Se asegur√≥ que el agua hiperclorada circulara por todo el sistema de tratamiento, incluyendo la activaci√≥n de by-pass, cascadas, jets y soplantes cuando exist√≠an. Este procedimiento cr√≠tico garantiza que todas las partes del sistema, incluidas aquellas normalmente paradas, queden expuestas a la soluci√≥n desinfectante.'
                    },
                    {
                        name: 'Segundo Contra-lavado',
                        description: 'Una vez transcurrido el tiempo de contacto necesario, se procedi√≥ a un nuevo contra-lavado del sistema de filtraci√≥n para eliminar los residuos generados durante el tratamiento de choque y preparar la instalaci√≥n para la fase de normalizaci√≥n.'
                    },
                    {
                        name: 'Normalizaci√≥n y Puesta en Servicio',
                        description: 'Finalmente, se procedi√≥ a la normalizaci√≥n de los par√°metros del agua, reduciendo gradualmente la concentraci√≥n de cloro libre hasta los valores habituales de operaci√≥n (1-3 ppm) y verificando que todos los par√°metros fisicoqu√≠micos se encontraran dentro de los rangos establecidos antes de proceder a la reapertura de la instalaci√≥n.'
                    }
                ];
                
                treatmentData.protocol.steps.forEach((step, index) => {
                    const stepDesc = stepDescriptions[step.number - 1];
                    
                    checkPageBreak(50);
                    
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`2.${step.number}. ${stepDesc.name}`, 20, yPosition);
                    yPosition += 10;
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    yPosition = addTextWithPageBreak(stepDesc.description, 20, yPosition) + 8;
                    
                    if (step.completed) {
                        doc.setFont(undefined, 'bold');
                        doc.text(`Estado: COMPLETADO`, 25, yPosition);
                        yPosition += 6;
                        doc.setFont(undefined, 'normal');
                        
                        if (step.date) {
                            doc.text(`Fecha de ejecuci√≥n: ${new Date(step.date).toLocaleString()}`, 25, yPosition);
                            yPosition += 6;
                        }
                        
                        // Datos espec√≠ficos del paso 3
                        if (step.number === 3) {
                            if (step.chlorine) {
                                doc.text(`Concentraci√≥n de cloro libre alcanzada: ${step.chlorine} ppm`, 25, yPosition);
                                yPosition += 6;
                            }
                            if (step.ph) {
                                doc.text(`pH mantenido durante el tratamiento: ${step.ph}`, 25, yPosition);
                                yPosition += 6;
                            }
                            if (step.startDate && step.endDate) {
                                const duration = (new Date(step.endDate) - new Date(step.startDate)) / (1000 * 60 * 60);
                                doc.text(`Duraci√≥n del tratamiento: ${duration.toFixed(1)} horas`, 25, yPosition);
                                yPosition += 6;
                            }
                        }
                        
                        // Datos espec√≠ficos del paso 6
                        if (step.number === 6) {
                            if (step.finalChlorine) {
                                doc.text(`Cloro libre residual final: ${step.finalChlorine} ppm`, 25, yPosition);
                                yPosition += 6;
                            }
                            if (step.finalPh) {
                                doc.text(`pH final tras normalizaci√≥n: ${step.finalPh}`, 25, yPosition);
                                yPosition += 6;
                            }
                            if (step.reopeningDate) {
                                doc.text(`Fecha de reapertura autorizada: ${new Date(step.reopeningDate).toLocaleString()}`, 25, yPosition);
                                yPosition += 6;
                            }
                        }
                        
                        if (step.notes) {
                            doc.text('Observaciones t√©cnicas:', 25, yPosition);
                            yPosition += 6;
                            yPosition = addTextWithPageBreak(step.notes, 25, yPosition, 165);
                        }
                    } else {
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(200, 0, 0);
                        doc.text(`Estado: PENDIENTE DE EJECUCI√ìN`, 25, yPosition);
                        doc.setTextColor(0, 0, 0);
                        yPosition += 6;
                    }
                    
                    yPosition += 12;
                });
                
                // 3. CONTROL Y SEGUIMIENTO ANAL√çTICO
                if (treatmentData.measurements.length > 0) {
                    checkPageBreak(40);
                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    doc.text('3. CONTROL Y SEGUIMIENTO ANAL√çTICO', 20, yPosition);
                    yPosition += 12;
                    
                    doc.setFontSize(11);
                    const monitoringText = `Durante el desarrollo del tratamiento se han realizado ${treatmentData.measurements.length} controles anal√≠ticos para verificar la eficacia del proceso y asegurar el cumplimiento de los par√°metros establecidos. Estas mediciones han permitido realizar un seguimiento continuo de la evoluci√≥n de los par√°metros fisicoqu√≠micos y ajustar el tratamiento seg√∫n las necesidades detectadas.

Los controles realizados han abarcado la medici√≥n de pH, concentraci√≥n de cloro libre residual, cloro combinado y temperatura del agua, par√°metros cr√≠ticos para evaluar tanto la eficacia del desinfectante como las condiciones de seguridad para los usuarios una vez finalizado el tratamiento.`;
                    
                    yPosition = addTextWithPageBreak(monitoringText, 20, yPosition) + 15;
                }
                
                // 4. CONCLUSIONES Y RESULTADOS
                checkPageBreak(40);
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('4. CONCLUSIONES Y RESULTADOS', 20, yPosition);
                yPosition += 12;
                
                doc.setFontSize(11);
                const currentStepCount = treatmentData.protocol.steps.filter(s => s.completed).length;
                const conclusionsText = currentStepCount === 6 ? 
                    `El tratamiento de desinfecci√≥n contra Pseudomonas aeruginosa ha sido ejecutado completamente y con √©xito, habiendo completado las seis etapas establecidas en el protocolo oficial. 

Todos los procedimientos se han realizado conforme a la normativa vigente, manteniendo los par√°metros fisicoqu√≠micos dentro de los rangos establecidos y documentando exhaustivamente cada fase del proceso. La instalaci√≥n ha sido normalizada y se encuentra en condiciones √≥ptimas para su reapertura al p√∫blico.

Se ha verificado la eficacia del tratamiento mediante controles anal√≠ticos que confirman la eliminaci√≥n del pat√≥geno y la seguridad del agua para el uso por parte de los usuarios. El valor CT (concentraci√≥n √ó tiempo) requerido de 3.600 ha sido alcanzado y mantenido durante el tiempo necesario.

La documentaci√≥n fotogr√°fica adjunta proporciona evidencia visual del proceso realizado y del estado de la instalaci√≥n en las diferentes fases del tratamiento.` :
                    `El tratamiento de desinfecci√≥n contra Pseudomonas aeruginosa se encuentra actualmente en fase de ejecuci√≥n, habiendo completado ${currentStepCount} de las 6 etapas establecidas en el protocolo oficial.

La instalaci√≥n permanece cerrada al p√∫blico hasta la finalizaci√≥n completa del protocolo de actuaci√≥n. Los procedimientos ejecutados hasta la fecha se han realizado conforme a la normativa vigente, manteniendo un registro detallado de todas las actuaciones y controles realizados.

Una vez completadas las etapas restantes del protocolo, se proceder√° a la normalizaci√≥n de la instalaci√≥n y se emitir√° el informe final de conformidad para autorizar la reapertura al p√∫blico.`;
                
                yPosition = addTextWithPageBreak(conclusionsText, 20, yPosition) + 20;
                
                // ANEXO: DATOS T√âCNICOS TABULADOS
                doc.addPage();
                yPosition = 20;
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('ANEXO - DATOS T√âCNICOS', 20, yPosition);
                yPosition += 15;
                
                // Tabla de datos de incidencia
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('A.1. DATOS DE LA INCIDENCIA', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const incidentData = [
                    ['Par√°metro', 'Valor'],
                    ['Piscina Afectada', treatmentData.incident.poolName || 'No especificada'],
                    ['Fecha de Detecci√≥n', treatmentData.incident.detectionDate ? new Date(treatmentData.incident.detectionDate).toLocaleString() : 'No especificada'],
                    ['Responsable', treatmentData.incident.responsible || 'No especificado'],
                    ['pH Inicial', treatmentData.incident.initialPh || 'No medido'],
                    ['Cloro Libre Inicial (ppm)', treatmentData.incident.initialFreeChlorine || 'No medido'],
                    ['Cloro Combinado Inicial (ppm)', treatmentData.incident.initialCombinedChlorine || 'No medido'],
                    ['Temperatura (¬∞C)', treatmentData.incident.temperature || 'No medida']
                ];
                
                incidentData.forEach((row, index) => {
                    checkPageBreak(8);
                    if (index === 0) {
                        doc.setFont(undefined, 'bold');
                        doc.rect(20, yPosition - 3, 170, 8);
                    } else {
                        doc.setFont(undefined, 'normal');
                    }
                    doc.text(row[0], 25, yPosition);
                    doc.text(row[1], 100, yPosition);
                    if (index === 0) doc.setFont(undefined, 'normal');
                    yPosition += 8;
                });
                
                yPosition += 10;
                
                // Tabla de pasos del protocolo
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('A.2. ESTADO DEL PROTOCOLO', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const protocolHeaders = ['Paso', 'Descripci√≥n', 'Estado', 'Fecha'];
                
                // Encabezados
                doc.setFont(undefined, 'bold');
                doc.rect(20, yPosition - 3, 170, 8);
                doc.text('Paso', 25, yPosition);
                doc.text('Descripci√≥n', 45, yPosition);
                doc.text('Estado', 120, yPosition);
                doc.text('Fecha', 150, yPosition);
                yPosition += 8;
                
                const stepNames = [
                    'Limpieza General',
                    'Contra-lavado',
                    'Tratamiento Choque',
                    'Hipercloraci√≥n',
                    'Segundo Contra-lavado',
                    'Normalizaci√≥n'
                ];
                
                for (let i = 1; i <= 6; i++) {
                    checkPageBreak(8);
                    const step = treatmentData.protocol.steps.find(s => s.number === i);
                    doc.setFont(undefined, 'normal');
                    doc.text(i.toString(), 25, yPosition);
                    doc.text(stepNames[i-1], 45, yPosition);
                    doc.text(step && step.completed ? 'COMPLETADO' : 'PENDIENTE', 120, yPosition);
                    doc.text(step && step.date ? new Date(step.date).toLocaleDateString() : '-', 150, yPosition);
                    yPosition += 8;
                }
                
                // Tabla de mediciones si existen
                if (treatmentData.measurements.length > 0) {
                    yPosition += 10;
                    checkPageBreak(30);
                    
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('A.3. REGISTRO DE MEDICIONES', 20, yPosition);
                    yPosition += 10;
                    
                    doc.setFontSize(9);
                    // Encabezados de mediciones
                    doc.setFont(undefined, 'bold');
                    doc.rect(20, yPosition - 3, 170, 8);
                    doc.text('Fecha/Hora', 25, yPosition);
                    doc.text('pH', 80, yPosition);
                    doc.text('Cl Libre', 95, yPosition);
                    doc.text('Cl Comb.', 120, yPosition);
                    doc.text('Temp.', 145, yPosition);
                    doc.text('Obs.', 165, yPosition);
                    yPosition += 8;
                    
                    treatmentData.measurements.forEach((measurement, index) => {
                        checkPageBreak(8);
                        doc.setFont(undefined, 'normal');
                        doc.text(new Date(measurement.datetime).toLocaleDateString(), 25, yPosition);
                        doc.text(measurement.ph || '-', 80, yPosition);
                        doc.text(measurement.freeChlorine || '-', 95, yPosition);
                        doc.text(measurement.combinedChlorine || '-', 120, yPosition);
                        doc.text(measurement.temperature || '-', 145, yPosition);
                        doc.text(measurement.observations ? 'S√≠' : '-', 165, yPosition);
                        yPosition += 8;
                    });
                }
                
                // A√±adir fotograf√≠as si existen
                let hasPhotos = false;
                for (const stepId in treatmentData.protocol.photos) {
                    if (treatmentData.protocol.photos[stepId].length > 0) {
                        hasPhotos = true;
                        break;
                    }
                }
                
                if (hasPhotos) {
                    doc.addPage();
                    yPosition = 20;
                    
                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    doc.text('ANEXO B - DOCUMENTACI√ìN FOTOGR√ÅFICA', 20, yPosition);
                    yPosition += 20;
                    
                    const photoStepNames = [
                        'Limpieza General',
                        'Contra-lavado',
                        'Tratamiento Choque',
                        'Hipercloraci√≥n',
                        'Segundo Contra-lavado',
                        'Normalizaci√≥n'
                    ];
                    
                    for (const stepId in treatmentData.protocol.photos) {
                        const photos = treatmentData.protocol.photos[stepId];
                        if (photos.length > 0) {
                            checkPageBreak(30);
                            
                            doc.setFontSize(12);
                            doc.setFont(undefined, 'bold');
                            const stepNumber = parseInt(stepId.replace('step', ''));
                            doc.text(`B.${stepNumber}. ${photoStepNames[stepNumber - 1]}:`, 25, yPosition);
                            yPosition += 15;
                            
                            for (let i = 0; i < photos.length; i++) {
                                checkPageBreak(80);
                                
                                try {
                                    const imgWidth = 80;
                                    const imgHeight = 60;
                                    
                                    doc.addImage(photos[i], 'JPEG', 25, yPosition, imgWidth, imgHeight);
                                    yPosition += imgHeight + 10;
                                } catch (error) {
                                    console.warn('Error al a√±adir imagen:', error);
                                    doc.setFontSize(10);
                                    doc.text('(Imagen no disponible)', 25, yPosition);
                                    yPosition += 10;
                                }
                            }
                            yPosition += 10;
                        }
                    }
                }
                
                // Pie de p√°gina
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`P√°gina ${i} de ${totalPages}`, 20, pageHeight - 10);
                    doc.text('Informe generado por Sistema Gestor Pseudomonas', 120, pageHeight - 10);
                }
                
                // Guardar el PDF
                const fileName = `Tratamiento_Pseudomonas_${treatmentData.incident.poolName || 'Piscina'}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                hideLoading();
                alert('‚úÖ Informe PDF generado correctamente.');
                
            } catch (error) {
                hideLoading();
                console.error('Error al generar PDF:', error);
                alert('‚ùå Error al generar el PDF. Por favor, int√©ntalo de nuevo.');
            }
        }

        // Exportar a Word
        async function exportToWord() {
            showLoading();
            
            try {
                const { Document, Packer, Paragraph, TextRun, HeadingLevel, Table, TableRow, TableCell, WidthType, AlignmentType } = docx;
                
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            // T√≠tulo
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "INFORME DE TRATAMIENTO PSEUDOMONAS",
                                        bold: true,
                                        size: 28,
                                        color: "2C3E50"
                                    })
                                ],
                                heading: HeadingLevel.TITLE,
                                alignment: AlignmentType.CENTER
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `Generado el: ${new Date().toLocaleString()}`,
                                        italics: true,
                                        size: 20
                                    })
                                ],
                                alignment: AlignmentType.CENTER
                            }),
                            
                            new Paragraph({ text: "" }), // Espacio
                            
                            // Secci√≥n 1: Datos de la incidencia
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "1. DATOS DE LA INCIDENCIA",
                                        bold: true,
                                        size: 24
                                    })
                                ],
                                heading: HeadingLevel.HEADING_1
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "Piscina Afectada: ", bold: true }),
                                    new TextRun({ text: treatmentData.incident.poolName || 'No especificada' })
                                ]
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "Fecha de Detecci√≥n: ", bold: true }),
                                    new TextRun({ text: treatmentData.incident.detectionDate ? new Date(treatmentData.incident.detectionDate).toLocaleString() : 'No especificada' })
                                ]
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "Responsable: ", bold: true }),
                                    new TextRun({ text: treatmentData.incident.responsible || 'No especificado' })
                                ]
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "pH Inicial: ", bold: true }),
                                    new TextRun({ text: treatmentData.incident.initialPh || 'No medido' })
                                ]
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "Cloro Libre Inicial (ppm): ", bold: true }),
                                    new TextRun({ text: treatmentData.incident.initialFreeChlorine || 'No medido' })
                                ]
                            }),
                            
                            new Paragraph({ text: "" }), // Espacio
                            
                            // Secci√≥n 2: Protocolo
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "2. PROTOCOLO DE ACTUACI√ìN",
                                        bold: true,
                                        size: 24
                                    })
                                ],
                                heading: HeadingLevel.HEADING_1
                            })
                        ]
                    }]
                });
                
                // A√±adir pasos del protocolo
                const stepNames = [
                    'Limpieza General Completa',
                    'Contra-lavado de Filtros',
                    'Tratamiento de Choque',
                    'Hipercloraci√≥n del Sistema',
                    'Segundo Contra-lavado',
                    'Normalizaci√≥n'
                ];
                
                treatmentData.protocol.steps.forEach(step => {
                    doc.addSection({
                        children: [
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `Paso ${step.number}: ${stepNames[step.number - 1]}`,
                                        bold: true,
                                        size: 22
                                    })
                                ]
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "Estado: ", bold: true }),
                                    new TextRun({ 
                                        text: step.completed ? '‚úì Completado' : '‚è≥ Pendiente',
                                        color: step.completed ? "27AE60" : "F39C12"
                                    })
                                ]
                            }),
                            
                            ...(step.date ? [new Paragraph({
                                children: [
                                    new TextRun({ text: "Fecha: ", bold: true }),
                                    new TextRun({ text: new Date(step.date).toLocaleString() })
                                ]
                            })] : []),
                            
                            ...(step.notes ? [new Paragraph({
                                children: [
                                    new TextRun({ text: "Observaciones: ", bold: true }),
                                    new TextRun({ text: step.notes })
                                ]
                            })] : [])
                        ]
                    });
                });
                
                // Generar y descargar el documento
                const buffer = await Packer.toBuffer(doc);
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                
                const fileName = `Tratamiento_Pseudomonas_${treatmentData.incident.poolName || 'Piscina'}_${new Date().toISOString().split('T')[0]}.docx`;
                saveAs(blob, fileName);
                
                hideLoading();
                alert('‚úÖ Documento Word generado correctamente.');
                
            } catch (error) {
                hideLoading();
                console.error('Error al generar Word:', error);
                alert('‚ùå Error al generar el documento Word. Por favor, int√©ntalo de nuevo.');
            }
        }

        // Exportar datos JSON
        function exportData() {
            const dataToExport = {
                ...treatmentData,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const fileName = `Datos_Tratamiento_Pseudomonas_${new Date().toISOString().split('T')[0]}.json`;
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Datos exportados correctamente en formato JSON.');
        }

        // Mostrar/ocultar indicador de carga
        function showLoading() {
            document.getElementById('exportLoading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('exportLoading').classList.remove('active');
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('pseudomonasTreatment', JSON.stringify(treatmentData));
        }

        // Cargar datos guardados
        function loadStoredData() {
            const stored = localStorage.getItem('pseudomonasTreatment');
            if (stored) {
                treatmentData = JSON.parse(stored);
                
                // Restaurar formulario de incidencia
                if (treatmentData.incident) {
                    Object.keys(treatmentData.incident).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = treatmentData.incident[key];
                        }
                    });
                }
                
                // Restaurar pasos completados
                if (treatmentData.protocol.steps) {
                    treatmentData.protocol.steps.forEach(step => {
                        if (step.completed) {
                            const stepElement = document.getElementById(`step${step.number}`);
                            if (stepElement) {
                                stepElement.classList.add('completed');
                            }
                            
                            // Restaurar datos del paso
                            const dateInput = document.getElementById(`step${step.number}Date`);
                            const notesInput = document.getElementById(`step${step.number}Notes`);
                            
                            if (dateInput && step.date) dateInput.value = step.date;
                            if (notesInput && step.notes) notesInput.value = step.notes;
                            
                            // Restaurar datos espec√≠ficos
                            if (step.number === 3) {
                                if (step.chlorine) document.getElementById('step3Chlorine').value = step.chlorine;
                                if (step.ph) document.getElementById('step3Ph').value = step.ph;
                                if (step.startDate) document.getElementById('step3DateStart').value = step.startDate;
                                if (step.endDate) document.getElementById('step3DateEnd').value = step.endDate;
                            }
                            
                            if (step.number === 4 && step.systems) {
                                document.getElementById('step4Systems').value = step.systems;
                            }
                            
                            if (step.number === 6) {
                                if (step.finalChlorine) document.getElementById('step6Chlorine').value = step.finalChlorine;
                                if (step.finalPh) document.getElementById('step6Ph').value = step.finalPh;
                                if (step.reopeningDate) document.getElementById('step6Reopening').value = step.reopeningDate;
                            }
                        }
                    });
                    
                    completedSteps = treatmentData.protocol.steps.filter(s => s.completed).length;
                }
                
                updateMeasurementTable();
                updateProgress();
                updateTimeline();
                generateTreatmentSummary();
            }
        }

        // Funci√≥n para limpiar todos los datos (para testing)
        function clearAllData() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar todos los datos? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem('pseudomonasTreatment');
                location.reload();
            }
        }

        // Funci√≥n para guardar fotos de paso espec√≠fico
        function saveStepPhotos(stepId) {
            const grid = document.getElementById(`${stepId}PhotoGrid`);
            const photos = [];
            
            grid.querySelectorAll('img').forEach(img => {
                photos.push(img.src);
            });
            
            treatmentData.protocol.photos[stepId] = photos;
            saveData();
        }

        // Actualizar resumen peri√≥dicamente
        setInterval(() => {
            generateTreatmentSummary();
        }, 30000); // Cada 30 segundos
    </script>
</body>
</html>
