<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0e1a">
<title>FotoCalib Â· RD 3/2023</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --accent: #00d4ff;
    --accent2: #00ff9d;
    --warn: #ffb800;
    --danger: #ff4757;
    --text: #e8edf5;
    --text2: #9aadbe;
    --mono: 'JetBrains Mono', 'Courier New', Courier, monospace;
    --sans: 'Sora', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --radius: 12px;
  }

*, *::before, *::after {
box-sizing: border-box !important;
margin: 0;
padding: 0;
-webkit-tap-highlight-color: transparent;
}

html {
background: #0a0e1a !important;
min-height: 100% !important;
}

body {
font-family: var(â€“sans) !important;
background: #0a0e1a !important;
color: #e8edf5 !important;
min-height: 100vh;
display: flex !important;
flex-direction: column !important;
max-width: 480px;
margin: 0 auto !important;
position: relative;
overflow-x: hidden;
}

/* â€” HEADER â€” */
.header {
padding: 16px 20px 12px;
background: var(â€“surface);
border-bottom: 1px solid var(â€“border);
display: flex;
align-items: center;
justify-content: space-between;
position: sticky;
top: 0;
z-index: 100;
}
.header-title {
display: flex;
align-items: center;
gap: 10px;
}
.logo-icon {
width: 32px; height: 32px;
background: linear-gradient(135deg, var(â€“accent), #0066ff);
border-radius: 8px;
display: flex; align-items: center; justify-content: center;
font-size: 16px;
}
.app-name { font-weight: 700; font-size: 16px; letter-spacing: 0.5px; }
.app-sub { font-family: var(â€“mono); font-size: 10px; color: var(â€“accent); letter-spacing: 1px; }
.header-date {
font-family: var(â€“mono);
font-size: 11px;
color: var(â€“text2);
text-align: right;
}

/* â€” NAV â€” */
.bottom-nav {
position: fixed;
bottom: 0; left: 50%;
transform: translateX(-50%);
width: 100%; max-width: 480px;
background: var(â€“surface);
border-top: 1px solid var(â€“border);
display: flex;
z-index: 100;
padding-bottom: env(safe-area-inset-bottom);
}
.nav-btn {
flex: 1;
display: flex; flex-direction: column; align-items: center;
gap: 3px; padding: 10px 4px 8px;
background: none; border: none; color: var(â€“text2);
cursor: pointer; transition: color 0.2s;
font-family: var(â€“sans); font-size: 10px;
}
.nav-btn.active { color: var(â€“accent); }
.nav-btn svg { width: 22px; height: 22px; }
.nav-dot {
width: 5px; height: 5px;
border-radius: 50%;
background: var(â€“danger);
position: absolute; top: 8px; right: calc(50% - 12px);
}

/* â€” CONTENT â€” */
.content {
flex: 1;
padding: 16px 16px 100px;
overflow-y: auto;
background: #0a0e1a;
}

.page { display: none; }
.page.active { display: block; }

/* â€” CARDS â€” */
.card {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 14px 16px;
margin-bottom: 12px;
position: relative;
overflow: hidden;
}
.card::before {
content: â€˜â€™;
position: absolute;
top: 0; left: 0; right: 0;
height: 2px;
}
.card.ok::before { background: var(â€“accent2); }
.card.warn::before { background: var(â€“warn); }
.card.danger::before { background: var(â€“danger); }
.card.neutral::before { background: var(â€“border); }

.card-header {
display: flex; align-items: flex-start;
justify-content: space-between; gap: 8px;
margin-bottom: 8px;
}
.card-title { font-weight: 600; font-size: 14px; }
.card-serial {
font-family: var(â€“mono); font-size: 11px;
color: var(â€“accent); background: rgba(0,212,255,0.1);
padding: 2px 8px; border-radius: 4px; white-space: nowrap;
}
.card-meta { display: flex; gap: 12px; flex-wrap: wrap; }
.meta-item {
display: flex; flex-direction: column; gap: 1px;
}
.meta-label {
font-size: 10px; color: var(â€“text2);
font-family: var(â€“mono); letter-spacing: 0.5px; text-transform: uppercase;
}
.meta-value { font-size: 13px; font-weight: 500; }
.meta-value.ok { color: var(â€“accent2); }
.meta-value.warn { color: var(â€“warn); }
.meta-value.danger { color: var(â€“danger); }

.badge {
display: inline-flex; align-items: center; gap: 4px;
padding: 3px 10px; border-radius: 20px;
font-size: 11px; font-weight: 600; font-family: var(â€“mono);
}
.badge.ok { background: rgba(0,255,157,0.1); color: var(â€“accent2); }
.badge.warn { background: rgba(255,184,0,0.1); color: var(â€“warn); }
.badge.danger { background: rgba(255,71,87,0.12); color: var(â€“danger); }
.badge::before {
content: â€˜â€™; width: 6px; height: 6px;
border-radius: 50%; background: currentColor;
}

.card-actions {
display: flex; gap: 8px; margin-top: 12px;
padding-top: 12px; border-top: 1px solid var(â€“border);
}
.btn {
flex: 1; padding: 9px 12px;
border: none; border-radius: 8px;
font-family: var(â€“sans); font-size: 13px; font-weight: 600;
cursor: pointer; transition: all 0.15s;
display: flex; align-items: center; justify-content: center; gap: 6px;
}
.btn-primary { background: var(â€“accent); color: #000; }
.btn-primary:active { transform: scale(0.97); }
.btn-secondary { background: var(â€“surface2); color: var(â€“text); border: 1px solid var(â€“border); }
.btn-danger { background: rgba(255,71,87,0.12); color: var(â€“danger); border: 1px solid rgba(255,71,87,0.2); }
.btn-ghost { background: none; color: var(â€“accent); font-size: 13px; border: 1px solid var(â€“accent); }
.btn-icon { flex: none; width: 36px; height: 36px; padding: 0; }

.btn-full { width: 100%; flex: none; margin-top: 12px; padding: 13px; border-radius: 10px; }

/* â€” FAB â€” */
.fab {
position: fixed;
bottom: 80px; right: 20px;
width: 52px; height: 52px;
border-radius: 16px;
background: linear-gradient(135deg, var(â€“accent), #0066ff);
border: none; color: #000;
font-size: 24px; font-weight: 300;
cursor: pointer; box-shadow: 0 4px 20px rgba(0,212,255,0.35);
display: flex; align-items: center; justify-content: center;
z-index: 90; transition: transform 0.15s, box-shadow 0.15s;
}
.fab:active { transform: scale(0.93); box-shadow: 0 2px 10px rgba(0,212,255,0.2); }

/* â€” SECTION HEADERS â€” */
.section-label {
font-family: var(â€“mono); font-size: 10px; font-weight: 600;
letter-spacing: 2px; text-transform: uppercase;
color: var(â€“text2); margin-bottom: 10px; margin-top: 4px;
display: flex; align-items: center; gap: 8px;
}
.section-label::after {
content: â€˜â€™; flex: 1; height: 1px; background: var(â€“border);
}

/* â€” STAT GRID â€” */
.stat-grid {
display: grid; grid-template-columns: 1fr 1fr;
gap: 10px; margin-bottom: 16px;
}
.stat-card {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 14px;
}
.stat-num {
font-family: var(â€“mono); font-size: 28px; font-weight: 700;
line-height: 1;
}
.stat-num.ok { color: var(â€“accent2); }
.stat-num.warn { color: var(â€“warn); }
.stat-num.danger { color: var(â€“danger); }
.stat-num.accent { color: var(â€“accent); }
.stat-desc { font-size: 12px; color: var(â€“text2); margin-top: 4px; }

/* â€” MODAL â€” */
.modal-overlay {
position: fixed; inset: 0;
background: rgba(0,0,0,0.7);
z-index: 200; display: none;
align-items: flex-end; justify-content: center;
backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal {
background: var(â€“surface);
border-radius: 20px 20px 0 0;
border-top: 1px solid var(â€“border);
padding: 20px 20px calc(20px + env(safe-area-inset-bottom));
width: 100%; max-width: 480px;
max-height: 90dvh;
overflow-y: auto;
animation: slideUp 0.3s cubic-bezier(0.32,0.72,0,1);
}
@keyframes slideUp {
from { transform: translateY(100%); }
to { transform: translateY(0); }
}
.modal-handle {
width: 36px; height: 4px;
background: var(â€“border); border-radius: 2px;
margin: 0 auto 16px;
}
.modal-title {
font-weight: 700; font-size: 16px;
margin-bottom: 16px;
display: flex; align-items: center; gap: 8px;
}

/* â€” FORMS â€” */
.form-group { margin-bottom: 14px; }
.form-label {
display: block; font-size: 11px; font-weight: 600;
letter-spacing: 0.8px; text-transform: uppercase;
color: var(â€“text2); font-family: var(â€“mono);
margin-bottom: 6px;
}
.form-input {
width: 100%; padding: 11px 14px;
background: var(â€“bg);
border: 1px solid var(â€“border);
border-radius: 8px;
color: var(â€“text);
font-family: var(â€“sans); font-size: 14px;
transition: border-color 0.2s;
appearance: none;
}
.form-input:focus { outline: none; border-color: var(â€“accent); }
select.form-input { background-image: url(â€œdata:image/svg+xml,%3Csvg xmlns=â€˜http://www.w3.org/2000/svgâ€™ width=â€˜12â€™ height=â€˜8â€™%3E%3Cpath d=â€˜M0 0l6 8 6-8zâ€™ fill=â€™%237a8fa8â€™/%3E%3C/svg%3Eâ€); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }
textarea.form-input { resize: none; min-height: 80px; }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.form-divider { height: 1px; background: var(â€“border); margin: 16px 0; }

/* â€” RESULT FIELDS â€” */
.result-row {
display: grid; grid-template-columns: 1fr 1fr 60px;
gap: 8px; align-items: end; margin-bottom: 10px;
}
.result-status {
width: 36px; height: 36px;
border-radius: 8px; border: 2px solid var(â€“border);
display: flex; align-items: center; justify-content: center;
font-size: 18px; cursor: pointer;
transition: all 0.15s;
background: var(â€“bg);
align-self: flex-end;
}
.result-status.pass { border-color: var(â€“accent2); background: rgba(0,255,157,0.1); }
.result-status.fail { border-color: var(â€“danger); background: rgba(255,71,87,0.1); }

/* â€” TRACEABILITY â€” */
.timeline { position: relative; }
.timeline-item {
display: flex; gap: 12px;
padding-bottom: 16px;
position: relative;
}
.timeline-item::before {
content: â€˜â€™; position: absolute;
left: 15px; top: 28px; bottom: 0;
width: 1px; background: var(â€“border);
}
.timeline-item:last-child::before { display: none; }
.timeline-dot {
width: 30px; height: 30px; flex-shrink: 0;
border-radius: 50%;
display: flex; align-items: center; justify-content: center;
font-size: 13px;
border: 2px solid;
}
.timeline-dot.calibracion { border-color: var(â€“accent); background: rgba(0,212,255,0.1); }
.timeline-dot.verificacion_ok { border-color: var(â€“accent2); background: rgba(0,255,157,0.1); }
.timeline-dot.verificacion_fail { border-color: var(â€“danger); background: rgba(255,71,87,0.1); }
.timeline-body { flex: 1; padding-top: 4px; }
.timeline-title { font-size: 13px; font-weight: 600; }
.timeline-date { font-family: var(â€“mono); font-size: 11px; color: var(â€“text2); margin-top: 2px; }
.timeline-note { font-size: 12px; color: var(â€“text2); margin-top: 4px; }

/* â€” EMPTY STATE â€” */
.empty {
text-align: center; padding: 48px 20px;
color: var(â€“text2);
}
.empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.4; }
.empty h3 { font-size: 15px; color: var(â€“text); margin-bottom: 6px; }
.empty p { font-size: 13px; }

/* â€” CHIP FILTERS â€” */
.filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 2px; margin-bottom: 14px; }
.filter-row::-webkit-scrollbar { display: none; }
.chip {
padding: 5px 14px; border-radius: 20px; white-space: nowrap;
font-size: 12px; font-weight: 600; cursor: pointer;
border: 1px solid var(â€“border);
background: var(â€“surface2); color: var(â€“text2);
transition: all 0.15s; flex-shrink: 0;
font-family: var(â€“mono);
}
.chip.active { background: var(â€“accent); color: #000; border-color: var(â€“accent); }

/* â€” ALERT BANNER â€” */
.alert-banner {
background: rgba(255,71,87,0.12);
border: 1px solid rgba(255,71,87,0.35);
border-radius: 10px; padding: 12px 14px;
margin-bottom: 12px; display: flex; align-items: flex-start; gap: 10px;
font-size: 13px; color: var(â€“text);
}
.alert-banner strong { color: #fff; }
.alert-banner span { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

/* â€” PHOTO UPLOAD AREA â€” */
.upload-area {
border: 2px dashed var(â€“border);
border-radius: 10px; padding: 20px;
text-align: center; cursor: pointer;
color: var(â€“text2); font-size: 13px;
transition: border-color 0.2s;
}
.upload-area:hover { border-color: var(â€“accent); color: var(â€“accent); }
.upload-area input { display: none; }
.upload-preview {
display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;
}
.upload-thumb {
width: 64px; height: 64px; border-radius: 8px;
object-fit: cover; border: 1px solid var(â€“border);
cursor: pointer;
}

/* â€” ALERT DOT â€” */
.nav-alert { position: relative; }

/* â€” CONFIRM DIALOG â€” */
.confirm-dialog {
position: fixed; inset: 0;
display: none; align-items: center; justify-content: center;
z-index: 300; background: rgba(0,0,0,0.7);
backdrop-filter: blur(4px); padding: 20px;
}
.confirm-dialog.open { display: flex; }
.confirm-box {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: 16px; padding: 24px;
max-width: 300px; width: 100%;
text-align: center;
}
.confirm-icon { font-size: 36px; margin-bottom: 12px; }
.confirm-title { font-size: 15px; font-weight: 700; margin-bottom: 6px; }
.confirm-msg { font-size: 13px; color: var(â€“text2); margin-bottom: 20px; }
.confirm-btns { display: flex; gap: 10px; }
</style>

</head>
<body style="background:#0a0e1a!important;color:#e8edf5!important;margin:0!important;">
<!-- Bloque de seguridad: por si el editor pisa el <head> -->
<style>body,html{background:#0a0e1a!important;color:#e8edf5!important;}</style>

<!-- HEADER -->

<header class="header">
  <div class="header-title">
    <div class="logo-icon">ğŸ”¬</div>
    <div>
      <div class="app-name">FotoCalib</div>
      <div class="app-sub">RD 3/2023 Â· RD 487/2022</div>
    </div>
  </div>
  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
    <div class="header-date" id="headerDate"></div>
    <div id="syncStatus" style="font-family:var(--mono);font-size:10px;cursor:pointer;" onclick="openSettings()"></div>
  </div>
</header>

<!-- CONTENT -->

<div class="content">

  <!-- ===== PÃGINA: DASHBOARD ===== -->

  <div class="page active" id="page-dashboard">
    <div id="dashAlerts"></div>
    <div class="stat-grid" id="statGrid"></div>
    <div class="section-label">FotÃ³metros activos</div>
    <div id="dashDevices"></div>
  </div>

  <!-- ===== PÃGINA: FOTÃ“METROS ===== -->

  <div class="page" id="page-dispositivos">
    <div class="filter-row">
      <div class="chip active" data-filter="all" onclick="filterDevices(this)">Todos</div>
      <div class="chip" data-filter="ok" onclick="filterDevices(this)">âœ“ OK</div>
      <div class="chip" data-filter="warn" onclick="filterDevices(this)">âš  Pendiente</div>
      <div class="chip" data-filter="danger" onclick="filterDevices(this)">âœ— Vencido</div>
    </div>
    <div id="devicesList"></div>
  </div>

  <!-- ===== PÃGINA: VERIFICACIONES ===== -->

  <div class="page" id="page-verificaciones">
    <div class="filter-row">
      <div class="chip active" data-filter="all" onclick="filterVerif(this)">Todas</div>
      <div class="chip" data-filter="pass" onclick="filterVerif(this)">âœ“ Pasa</div>
      <div class="chip" data-filter="fail" onclick="filterVerif(this)">âœ— Falla</div>
    </div>
    <div id="verifList"></div>
  </div>

  <!-- ===== PÃGINA: TRAZABILIDAD ===== -->

  <div class="page" id="page-trazabilidad">
    <div class="form-group" style="margin-bottom:14px;">
      <select class="form-input" id="trazSelect" onchange="renderTrazabilidad()">
        <option value="">â€” Selecciona fotÃ³metro â€”</option>
      </select>
    </div>
    <div id="trazContent"></div>
  </div>

</div><!-- /content -->

<!-- FAB -->

<button class="fab" id="fabBtn" onclick="openFab()">+</button>

<!-- BOTTOM NAV -->

<nav class="bottom-nav">
  <button class="nav-btn active" onclick="showPage('dashboard', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    Dashboard
  </button>
  <button class="nav-btn nav-alert" onclick="showPage('dispositivos', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v2m0 16v2M2 12h2m16 0h2m-3.5-6.5-1.4 1.4M6.9 17.1l-1.4 1.4m0-12.8 1.4 1.4m8.8 8.8 1.4 1.4"/></svg>
    FotÃ³metros
  </button>
  <button class="nav-btn" onclick="showPage('verificaciones', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    Registros
  </button>
  <button class="nav-btn" onclick="showPage('trazabilidad', this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    Trazab.
  </button>
</nav>

<!-- MODAL: NUEVO FOTÃ“METRO -->

<div class="modal-overlay" id="modalFotometro">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“Ÿ <span id="mFotoTitle">Nuevo FotÃ³metro</span></div>
    <input type="hidden" id="mFotoId">
    <div class="form-group">
      <label class="form-label">Nombre / Modelo</label>
      <input type="text" class="form-input" id="mFotoNombre" placeholder="Ej: Hanna HI97701 #1">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">NÂº Serie</label>
        <input type="text" class="form-input" id="mFotoSerie" placeholder="SN-12345">
      </div>
      <div class="form-group">
        <label class="form-label">ParÃ¡metro</label>
        <select class="form-input" id="mFotoParam">
          <option>Cloro libre</option>
          <option>Cloro total</option>
          <option>Cloro libre + Total</option>
          <option>pH</option>
          <option>Turbidez</option>
          <option>Amonio</option>
          <option>DiÃ³xido de cloro</option>
          <option>MultiparÃ¡metro</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">UbicaciÃ³n</label>
        <input type="text" class="form-input" id="mFotoUbic" placeholder="DepÃ³sito 1, ACS...">
      </div>
      <div class="form-group">
        <label class="form-label">Estado</label>
        <select class="form-input" id="mFotoEstado">
          <option value="activo">Activo</option>
          <option value="baja">Baja</option>
        </select>
      </div>
    </div>
    <div class="form-divider"></div>
    <div class="section-label" style="margin-top:0">CalibraciÃ³n anual</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Ãšltima calibraciÃ³n</label>
        <input type="date" class="form-input" id="mFotoCalFecha">
      </div>
      <div class="form-group">
        <label class="form-label">Laboratorio</label>
        <input type="text" class="form-input" id="mFotoLab" placeholder="Nombre laboratorio">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">NÂº Certificado calibraciÃ³n</label>
      <input type="text" class="form-input" id="mFotoCert" placeholder="CERT-2024-001">
    </div>
    <div class="form-group">
      <label class="form-label">Notas</label>
      <textarea class="form-input" id="mFotoNotas" placeholder="Observaciones..."></textarea>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-secondary" onclick="closeModal('modalFotometro')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveFotometro()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: VERIFICACIÃ“N MENSUAL -->

<div class="modal-overlay" id="modalVerif">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ§ª Nueva VerificaciÃ³n Mensual</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">FotÃ³metro</label>
        <select class="form-input" id="mVerifFoto"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Fecha</label>
        <input type="date" class="form-input" id="mVerifFecha">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Referencia patrÃ³n / Kit CAL CHECK</label>
      <input type="text" class="form-input" id="mVerifPatron" placeholder="Ej: HI97701-11, lote 24B03">
    </div>
    <div class="form-divider"></div>
    <div class="section-label" style="margin-top:0">Resultados por parÃ¡metro</div>
    <div id="verifParams">
      <div class="form-group">
        <label class="form-label">ParÃ¡metro 1</label>
        <div class="result-row">
          <div>
            <label class="form-label">Nombre</label>
            <input type="text" class="form-input param-name" placeholder="Ej: Cloro libre">
          </div>
          <div>
            <label class="form-label">Valor patrÃ³n â†’ obtenido</label>
            <input type="text" class="form-input param-val" placeholder="1.00 â†’ 1.02 mg/L">
          </div>
          <div>
            <label class="form-label">OK</label>
            <div class="result-status" onclick="toggleStatus(this)" title="Toca para cambiar">â€”</div>
          </div>
        </div>
      </div>
    </div>
    <button class="btn btn-ghost" style="width:100%;margin-bottom:10px;" onclick="addParamRow()">+ ParÃ¡metro</button>
    <div class="form-group">
      <label class="form-label">TÃ©cnico</label>
      <input type="text" class="form-input" id="mVerifTecnico" placeholder="Nombre del tÃ©cnico">
    </div>
    <div class="form-group">
      <label class="form-label">Observaciones</label>
      <textarea class="form-input" id="mVerifNotas" placeholder="Notas, acciones correctoras..."></textarea>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-secondary" onclick="closeModal('modalVerif')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveVerificacion()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL FAB SELECTOR -->

<div class="modal-overlay" id="modalFab">
  <div class="modal" style="padding-bottom:20px;">
    <div class="modal-handle"></div>
    <div class="modal-title">Â¿QuÃ© quieres hacer?</div>
    <div class="section-label" style="margin-top:0">AÃ±adir registro</div>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); openFotometro()">ğŸ“Ÿ Nuevo FotÃ³metro</button>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); openVerif()">ğŸ§ª VerificaciÃ³n Mensual</button>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); openCalAnual()">ğŸ“‹ CalibraciÃ³n Anual (registro)</button>
    <div class="section-label">Exportar</div>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); exportCSV()">ğŸ“Š Exportar CSV</button>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); exportPDF()">ğŸ–¨ï¸ Generar PDF / Imprimir</button>
    <div class="section-label">ConfiguraciÃ³n</div>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); openSettings()">âš™ï¸ ConexiÃ³n GitHub</button>
    <button class="btn btn-secondary btn-full" onclick="closeModal('modalFab'); loadFromGitHub().then(()=>renderAll())">ğŸ”„ Sincronizar ahora</button>
  </div>
</div>

<!-- MODAL: CALIBRACIÃ“N ANUAL (registro adicional) -->

<div class="modal-overlay" id="modalCalAnual">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“‹ CalibraciÃ³n Anual</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">FotÃ³metro</label>
        <select class="form-input" id="mCalFoto"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Fecha calibraciÃ³n</label>
        <input type="date" class="form-input" id="mCalFecha">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Laboratorio acreditado</label>
        <input type="text" class="form-input" id="mCalLab" placeholder="Nombre laboratorio">
      </div>
      <div class="form-group">
        <label class="form-label">NÂº Certificado</label>
        <input type="text" class="form-input" id="mCalCert" placeholder="CERT-2024-001">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Incertidumbre / Resultado</label>
      <input type="text" class="form-input" id="mCalResultado" placeholder="Ej: Â±0.02 mg/L, dentro de especificaciÃ³n">
    </div>
    <div class="form-group">
      <label class="form-label">VÃ¡lida hasta</label>
      <input type="date" class="form-input" id="mCalVigencia">
    </div>
    <div class="form-group">
      <label class="form-label">Observaciones</label>
      <textarea class="form-input" id="mCalNotas" placeholder=""></textarea>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-secondary" onclick="closeModal('modalCalAnual')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveCalAnual()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: DETALLE FOTÃ“METRO -->

<div class="modal-overlay" id="modalDetalle">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="detalleContent"></div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn btn-danger btn-icon" onclick="confirmDelete()" title="Eliminar">ğŸ—‘</button>
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('modalDetalle')">Cerrar</button>
      <button class="btn btn-primary" style="flex:1" onclick="editFotometro()">Editar</button>
    </div>
  </div>
</div>

<!-- MODAL: CONFIGURACIÃ“N GITHUB -->

<div class="modal-overlay" id="modalSettings">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">âš™ï¸ ConexiÃ³n GitHub</div>
    <div style="background:rgba(0,212,255,0.07);border:1px solid rgba(0,212,255,0.2);border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--text2);line-height:1.6;">
      Los datos se guardan en <span style="color:var(--accent);font-family:var(--mono)">MikiMauZ/Pseudos/fotometro.json</span>.<br>
      Necesitas un <strong style="color:var(--text)">Personal Access Token</strong> de GitHub con permiso <span style="font-family:var(--mono);color:var(--accent2)">repo</span> para poder escribir.
    </div>
    <div id="sandboxWarning" style="display:none;background:rgba(255,184,0,0.1);border:1px solid rgba(255,184,0,0.3);border-radius:8px;padding:12px;margin-bottom:14px;font-size:12px;color:var(--warn);line-height:1.6;">
      âš ï¸ <strong>EstÃ¡s dentro de Claude.ai.</strong> Las llamadas a GitHub estÃ¡n bloqueadas por seguridad.<br>
      <span style="color:var(--text2)">Guarda el token aquÃ­ y abre el archivo en <strong style="color:var(--text)">Safari</strong> o en <strong style="color:var(--text)">GitHub Pages</strong> para que funcione.</span>
    </div>
    <div class="form-group">
      <label class="form-label">GitHub Personal Access Token (PAT)</label>
      <input type="password" class="form-input" id="sToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
      <div style="font-size:11px;color:var(--text2);margin-top:5px;">Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic) â†’ scope: <code>repo</code></div>
    </div>
    <div id="settingsStatus" style="font-size:12px;margin-bottom:10px;"></div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-secondary" onclick="closeModal('modalSettings')">Cancelar</button>
      <button class="btn btn-ghost" onclick="testGitHub()">ğŸ”— Probar conexiÃ³n</button>
      <button class="btn btn-primary" onclick="saveSettings()">Guardar</button>
    </div>
  </div>
</div>

<!-- CONFIRM DIALOG -->

<div class="confirm-dialog" id="confirmDialog">
  <div class="confirm-box">
    <div class="confirm-icon">âš ï¸</div>
    <div class="confirm-title">Â¿Eliminar fotÃ³metro?</div>
    <div class="confirm-msg">Se borrarÃ¡n tambiÃ©n todas sus verificaciones y calibraciones. Esta acciÃ³n no se puede deshacer.</div>
    <div class="confirm-btns">
      <button class="btn btn-secondary" style="flex:1" onclick="closeConfirm()">Cancelar</button>
      <button class="btn btn-danger" style="flex:1" onclick="doDelete()">Eliminar</button>
    </div>
  </div>
</div>

<script>
// ============================================================
//  CONFIG GITHUB
// ============================================================
const GH = {
  owner: 'MikiMauZ',
  repo: 'Pseudos',
  path: 'fotometro.json',
  branch: 'main',
  get token() { return localStorage.getItem('fc_gh_token') || ''; },
  get apiUrl() { return `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${this.path}`; },
  get rawUrl() { return `https://raw.githubusercontent.com/${this.owner}/${this.repo}/${this.branch}/${this.path}`; }
};

// SHA del archivo actual (necesario para escribir en GitHub)
let ghFileSha = null;

// Cache local de los datos
let localData = { version:'1.0', lastUpdated:'', fotometros:[], verificaciones:[], calibraciones:[] };

// ============================================================
//  ESTADO DE SYNC
// ============================================================
function setSyncStatus(state, msg) {
  const el = document.getElementById('syncStatus');
  const icons = { ok:'ğŸŸ¢', loading:'ğŸ”„', error:'ğŸ”´', warn:'ğŸŸ¡', offline:'âš«' };
  el.innerHTML = `${icons[state]||'âšª'} ${msg}`;
  el.style.color = state==='ok'?'var(--accent2)':state==='error'?'var(--danger)':state==='warn'?'var(--warn)':'var(--text2)';
}

// ============================================================
//  CARGAR DATOS DESDE GITHUB
// ============================================================
async function loadFromGitHub() {
  setSyncStatus('loading', 'Cargandoâ€¦');
  try {
    // Usamos la API (no raw) para obtener tambiÃ©n el SHA
    const headers = { 'Accept': 'application/vnd.github+json' };
    if (GH.token) headers['Authorization'] = `Bearer ${GH.token}`;

    const res = await fetch(GH.apiUrl, { headers });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const meta = await res.json();

    ghFileSha = meta.sha;
    const content = JSON.parse(atob(meta.content.replace(/\n/g,'')));
    localData = { version:'1.0', lastUpdated:'', fotometros:[], verificaciones:[], calibraciones:[], ...content };
    setSyncStatus('ok', 'GitHub âœ“');
  } catch(e) {
    // Fallback a localStorage si hay datos
    const ls = localStorage.getItem('fc_localData');
    if (ls) {
      localData = JSON.parse(ls);
      setSyncStatus('warn', 'Sin sync (local)');
    } else {
      setSyncStatus(GH.token ? 'error' : 'warn', GH.token ? 'Error GitHub' : 'Sin token â†’');
    }
  }
}

// ============================================================
//  GUARDAR DATOS EN GITHUB
// ============================================================
async function saveToGitHub() {
  // Siempre guardar localmente tambiÃ©n
  localStorage.setItem('fc_localData', JSON.stringify(localData));

  if (!GH.token) { setSyncStatus('warn', 'Sin token â†’'); return; }

  setSyncStatus('loading', 'Guardandoâ€¦');
  localData.lastUpdated = new Date().toISOString();

  const contentB64 = btoa(unescape(encodeURIComponent(JSON.stringify(localData, null, 2))));

  try {
    const body = {
      message: `FotoCalib update ${new Date().toLocaleString('es-ES')}`,
      content: contentB64,
      branch: GH.branch
    };
    if (ghFileSha) body.sha = ghFileSha;

    const res = await fetch(GH.apiUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${GH.token}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || `HTTP ${res.status}`);
    }

    const result = await res.json();
    ghFileSha = result.content.sha;
    setSyncStatus('ok', 'Guardado âœ“');
  } catch(e) {
    setSyncStatus('error', 'Error al guardar');
    console.error('GitHub save error:', e);
  }
}

// ============================================================
//  ACCESSORS â€” ahora usan localData en vez de localStorage
// ============================================================
const DB = { id: () => Date.now() + Math.random().toString(36).slice(2,6) };

const getFotos   = () => localData.fotometros    || [];
const getVerifs  = () => localData.verificaciones || [];
const getCals    = () => localData.calibraciones  || [];

function setFotos(v)  { localData.fotometros    = v; }
function setVerifs(v) { localData.verificaciones = v; }
function setCals(v)   { localData.calibraciones  = v; }

// ============================================================
//  UTILIDADES
// ============================================================
const today = () => new Date().toISOString().slice(0,10);

function daysUntil(dateStr) {
  if (!dateStr) return null;
  const diff = new Date(dateStr) - new Date(today());
  return Math.ceil(diff / (1000*60*60*24));
}

function nextCalDate(lastCalStr) {
  if (!lastCalStr) return null;
  const d = new Date(lastCalStr);
  d.setFullYear(d.getFullYear() + 1);
  return d.toISOString().slice(0,10);
}

function fmtDate(d) {
  if (!d) return 'â€”';
  const [y,m,day] = d.split('-');
  return `${day}/${m}/${y}`;
}

function getDeviceStatus(foto) {
  const fotos = getFotos();
  const verifs = getVerifs().filter(v => v.fotoId === foto.id);
  const cals = getCals().filter(c => c.fotoId === foto.id);

  // CalibraciÃ³n anual
  const allCalDates = [];
  if (foto.calFecha) allCalDates.push(foto.calFecha);
  cals.forEach(c => allCalDates.push(c.fecha));
  const lastCal = allCalDates.sort().at(-1);
  const nextCal = nextCalDate(lastCal);
  const calDays = daysUntil(nextCal);

  // VerificaciÃ³n mensual â€” Ãºltima
  const lastVerif = verifs.sort((a,b) => a.fecha<b.fecha?1:-1)[0];
  const lastVerifDate = lastVerif?.fecha;
  const verifDays = lastVerifDate ? daysUntil(new Date(lastVerifDate).setMonth(new Date(lastVerifDate).getMonth()+1)) : null;

  let calStatus = 'ok', verifStatus = 'ok';

  if (!lastCal) calStatus = 'danger';
  else if (calDays !== null && calDays < 0) calStatus = 'danger';
  else if (calDays !== null && calDays < 30) calStatus = 'warn';

  if (!lastVerifDate) verifStatus = 'danger';
  else {
    const verifDaysNum = typeof verifDays === 'object' ? Math.ceil((verifDays - new Date()) / 86400000) : verifDays;
    if (verifDaysNum !== null && verifDaysNum < 0) verifStatus = 'danger';
    else if (verifDaysNum !== null && verifDaysNum < 7) verifStatus = 'warn';
  }

  const overall = (calStatus === 'danger' || verifStatus === 'danger') ? 'danger'
                : (calStatus === 'warn' || verifStatus === 'warn') ? 'warn' : 'ok';

  const lastVerifFail = lastVerif && lastVerif.params && lastVerif.params.some(p => p.status === 'fail');

  return { overall, calStatus, verifStatus, lastCal, nextCal, calDays, lastVerifDate, lastVerifFail };
}

// ============================================================
//  INIT
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
  const d = new Date();
  document.getElementById('headerDate').innerHTML =
    d.toLocaleDateString('es-ES', {weekday:'short',day:'2-digit',month:'short'}).replace('.','')+'<br>'+
    d.getFullYear();

  setSyncStatus('loading', 'Conectandoâ€¦');

  if (!GH.token) {
    // No hay token: mostrar modal de configuraciÃ³n automÃ¡ticamente
    setSyncStatus('warn', 'Configura token â†’');
    setTimeout(() => openSettings(), 600);
  }

  await loadFromGitHub();
  renderAll();
});

// ============================================================
//  RENDER PRINCIPAL
// ============================================================
function renderAll() {
  renderDashboard();
  renderDevices();
  renderVerifications();
  renderTrazSelector();
}

// ============================================================
//  DASHBOARD
// ============================================================
function renderDashboard() {
  const fotos = getFotos().filter(f => f.estado === 'activo');
  const verifs = getVerifs();
  const cals = getCals();

  let alerts = 0, warns = 0, oks = 0;
  const alertHtml = [];

  fotos.forEach(f => {
    const s = getDeviceStatus(f);
    if (s.overall === 'danger') {
      alerts++;
      alertHtml.push(`<div class="alert-banner"><span>ğŸš¨</span><div><strong>${f.nombre}</strong> â€” ${s.calStatus==='danger'?'CalibraciÃ³n anual vencida/pendiente':''} ${s.verifStatus==='danger'?'VerificaciÃ³n mensual vencida/pendiente':''}</div></div>`);
    } else if (s.overall === 'warn') warns++;
    else oks++;
  });

  document.getElementById('dashAlerts').innerHTML = alertHtml.join('');

  document.getElementById('statGrid').innerHTML = `
    <div class="stat-card">
      <div class="stat-num accent">${fotos.length}</div>
      <div class="stat-desc">FotÃ³metros activos</div>
    </div>
    <div class="stat-card">
      <div class="stat-num ${alerts>0?'danger':oks===fotos.length?'ok':'warn'}">${alerts>0?alerts:oks}</div>
      <div class="stat-desc">${alerts>0?'Con alertas':'Sin alertas'}</div>
    </div>
    <div class="stat-card">
      <div class="stat-num accent">${verifs.length}</div>
      <div class="stat-desc">Verificaciones registradas</div>
    </div>
    <div class="stat-card">
      <div class="stat-num accent">${verifs.filter(v=>v.global==='fail').length}</div>
      <div class="stat-desc">Fallos detectados</div>
    </div>
  `;

  // Ãšltimos 5 dispositivos
  const html = fotos.length === 0
    ? '<div class="empty"><div class="empty-icon">ğŸ“Ÿ</div><h3>Sin fotÃ³metros</h3><p>AÃ±ade tu primer fotÃ³metro con el botÃ³n +</p></div>'
    : fotos.map(f => renderDeviceCard(f, true)).join('');
  document.getElementById('dashDevices').innerHTML = html;
}

// ============================================================
//  DISPOSITIVOS
// ============================================================
let deviceFilter = 'all';
function filterDevices(el) {
  document.querySelectorAll('.filter-row .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  deviceFilter = el.dataset.filter;
  renderDevices();
}

function renderDevices() {
  const fotos = getFotos();
  const filtered = fotos.filter(f => {
    if (deviceFilter === 'all') return true;
    const s = getDeviceStatus(f);
    return s.overall === deviceFilter;
  });
  const html = filtered.length === 0
    ? '<div class="empty"><div class="empty-icon">ğŸ”­</div><h3>Sin resultados</h3><p>No hay fotÃ³metros en este estado</p></div>'
    : filtered.map(f => renderDeviceCard(f, false)).join('');
  document.getElementById('devicesList').innerHTML = html;
}

function renderDeviceCard(foto, compact) {
  const s = getDeviceStatus(foto);
  const statusLabels = {ok:'CORRECTO', warn:'ATENCIÃ“N', danger:'VENCIDO'};
  const verifs = getVerifs().filter(v => v.fotoId === foto.id);
  const lastV = verifs.sort((a,b)=>a.fecha<b.fecha?1:-1)[0];

  return `<div class="card ${s.overall}" onclick="showDetalle('${foto.id}')">
    <div class="card-header">
      <div>
        <div class="card-title">${foto.nombre}</div>
        <div style="margin-top:4px;font-size:12px;color:var(--text2)">${foto.param} Â· ${foto.ubicacion}</div>
      </div>
      <div class="card-serial">${foto.serie}</div>
    </div>
    <div class="card-meta">
      <div class="meta-item">
        <div class="meta-label">Cal. anual</div>
        <div class="meta-value ${s.calStatus}">${fmtDate(s.lastCal)}</div>
      </div>
      <div class="meta-item">
        <div class="meta-label">PrÃ³x. cal.</div>
        <div class="meta-value ${s.calStatus}">${fmtDate(s.nextCal)}${s.calDays!==null?` (${s.calDays}d)`:''}</div>
      </div>
      <div class="meta-item">
        <div class="meta-label">Ãšlt. verif.</div>
        <div class="meta-value ${s.verifStatus}">${fmtDate(s.lastVerifDate)}</div>
      </div>
      <div class="meta-item">
        <div class="meta-label">Estado</div>
        <span class="badge ${s.overall}">${statusLabels[s.overall]}</span>
      </div>
    </div>
    ${s.lastVerifFail ? `<div style="margin-top:8px;font-size:12px;color:var(--danger)">âš  Ãšltima verificaciÃ³n con fallos</div>` : ''}
  </div>`;
}

// ============================================================
//  VERIFICACIONES
// ============================================================
let verifFilter = 'all';
function filterVerif(el) {
  document.querySelectorAll('#page-verificaciones .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  verifFilter = el.dataset.filter;
  renderVerifications();
}

function renderVerifications() {
  const verifs = getVerifs().sort((a,b) => a.fecha<b.fecha?1:-1);
  const fotos = getFotos();
  const filtered = verifs.filter(v => verifFilter === 'all' ? true : v.global === verifFilter);

  if (filtered.length === 0) {
    document.getElementById('verifList').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ§ª</div><h3>Sin verificaciones</h3><p>Registra la primera verificaciÃ³n mensual</p></div>';
    return;
  }

  const html = filtered.map(v => {
    const foto = fotos.find(f => f.id === v.fotoId);
    const passFail = v.global === 'pass';
    return `<div class="card ${passFail?'ok':'danger'}">
      <div class="card-header">
        <div>
          <div class="card-title">${foto?.nombre ?? 'FotÃ³metro eliminado'}</div>
          <div style="font-size:12px;color:var(--text2);margin-top:3px">PatrÃ³n: ${v.patron || 'â€”'} Â· TÃ©cnico: ${v.tecnico || 'â€”'}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
          <span class="badge ${passFail?'ok':'danger'}">${passFail?'PASA':'FALLA'}</span>
          <span style="font-family:var(--mono);font-size:11px;color:var(--text2)">${fmtDate(v.fecha)}</span>
        </div>
      </div>
      ${v.params && v.params.length ? `<div style="display:flex;flex-direction:column;gap:4px;">
        ${v.params.map(p=>`<div style="display:flex;justify-content:space-between;font-size:12px;background:var(--bg);padding:6px 10px;border-radius:6px;">
          <span>${p.nombre}</span>
          <span style="color:var(--text2);font-family:var(--mono)">${p.valor}</span>
          <span style="color:${p.status==='pass'?'var(--accent2)':'var(--danger)'}">${p.status==='pass'?'âœ“':'âœ—'}</span>
        </div>`).join('')}
      </div>` : ''}
      ${v.notas ? `<div style="margin-top:8px;font-size:12px;color:var(--text2);padding:6px 10px;background:var(--bg);border-radius:6px;">${v.notas}</div>` : ''}
    </div>`;
  }).join('');
  document.getElementById('verifList').innerHTML = html;
}

// ============================================================
//  TRAZABILIDAD
// ============================================================
function renderTrazSelector() {
  const fotos = getFotos();
  const sel = document.getElementById('trazSelect');
  sel.innerHTML = '<option value="">â€” Selecciona fotÃ³metro â€”</option>' +
    fotos.map(f => `<option value="${f.id}">${f.nombre} (${f.serie})</option>`).join('');
}

function renderTrazabilidad() {
  const fotoId = document.getElementById('trazSelect').value;
  if (!fotoId) { document.getElementById('trazContent').innerHTML = ''; return; }

  const verifs = getVerifs().filter(v => v.fotoId === fotoId).sort((a,b) => a.fecha<b.fecha?1:-1);
  const cals = getCals().filter(c => c.fotoId === fotoId).sort((a,b) => a.fecha<b.fecha?1:-1);
  const foto = getFotos().find(f => f.id === fotoId);

  const events = [];

  // Cal inicial del fotÃ³metro
  if (foto?.calFecha) {
    events.push({ tipo: 'calibracion', fecha: foto.calFecha, titulo: 'CalibraciÃ³n anual (inicial)', lab: foto.calLab, cert: foto.calCert, notas: foto.notas });
  }

  cals.forEach(c => events.push({ tipo: 'calibracion', fecha: c.fecha, titulo: 'CalibraciÃ³n anual', lab: c.lab, cert: c.cert, notas: c.notas, resultado: c.resultado, vigencia: c.vigencia }));
  verifs.forEach(v => events.push({ tipo: v.global === 'fail' ? 'verificacion_fail' : 'verificacion_ok', fecha: v.fecha, titulo: `VerificaciÃ³n mensual â€” ${v.global==='pass'?'PASA':'FALLA'}`, patron: v.patron, tecnico: v.tecnico, params: v.params, notas: v.notas }));

  events.sort((a,b) => a.fecha < b.fecha ? 1 : -1);

  if (events.length === 0) {
    document.getElementById('trazContent').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“ˆ</div><h3>Sin registros</h3><p>No hay historial para este fotÃ³metro</p></div>';
    return;
  }

  const icons = { calibracion: 'ğŸ”§', verificacion_ok: 'âœ…', verificacion_fail: 'âŒ' };

  const html = '<div class="timeline">' + events.map(e => `
    <div class="timeline-item">
      <div class="timeline-dot ${e.tipo}">${icons[e.tipo]}</div>
      <div class="timeline-body">
        <div class="timeline-title">${e.titulo}</div>
        <div class="timeline-date">${fmtDate(e.fecha)}</div>
        ${e.lab ? `<div class="timeline-note">ğŸ¢ ${e.lab}${e.cert?` Â· Cert: ${e.cert}`:''}</div>` : ''}
        ${e.resultado ? `<div class="timeline-note">ğŸ“Š ${e.resultado}</div>` : ''}
        ${e.vigencia ? `<div class="timeline-note">ğŸ“… VÃ¡lida hasta: ${fmtDate(e.vigencia)}</div>` : ''}
        ${e.patron ? `<div class="timeline-note">ğŸ§ª PatrÃ³n: ${e.patron} Â· TÃ©cnico: ${e.tecnico}</div>` : ''}
        ${e.params && e.params.length ? `<div style="margin-top:4px;display:flex;flex-direction:column;gap:3px;">${e.params.map(p=>`<div style="font-size:12px;color:var(--text2)">â€¢ ${p.nombre}: <span style="font-family:var(--mono)">${p.valor}</span> <span style="color:${p.status==='pass'?'var(--accent2)':'var(--danger)'}">${p.status==='pass'?'âœ“':'âœ—'}</span></div>`).join('')}</div>` : ''}
        ${e.notas ? `<div class="timeline-note" style="font-style:italic">${e.notas}</div>` : ''}
      </div>
    </div>
  `).join('') + '</div>';

  document.getElementById('trazContent').innerHTML = html;
}

// ============================================================
//  MODALS
// ============================================================
function openFab() { openModal('modalFab'); }

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
function openModal(id) {
  document.getElementById(id).classList.add('open');
}

// Cerrar al clic en overlay
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

function openFotometro(id = null) {
  document.getElementById('mFotoId').value = id || '';
  if (id) {
    const f = getFotos().find(x => x.id === id);
    document.getElementById('mFotoTitle').textContent = 'Editar FotÃ³metro';
    document.getElementById('mFotoNombre').value = f.nombre;
    document.getElementById('mFotoSerie').value = f.serie;
    document.getElementById('mFotoParam').value = f.param;
    document.getElementById('mFotoUbic').value = f.ubicacion;
    document.getElementById('mFotoEstado').value = f.estado;
    document.getElementById('mFotoCalFecha').value = f.calFecha || '';
    document.getElementById('mFotoLab').value = f.calLab || '';
    document.getElementById('mFotoCert').value = f.calCert || '';
    document.getElementById('mFotoNotas').value = f.notas || '';
  } else {
    document.getElementById('mFotoTitle').textContent = 'Nuevo FotÃ³metro';
    document.getElementById('mFotoNombre').value = '';
    document.getElementById('mFotoSerie').value = '';
    document.getElementById('mFotoUbic').value = '';
    document.getElementById('mFotoCalFecha').value = today();
    document.getElementById('mFotoLab').value = '';
    document.getElementById('mFotoCert').value = '';
    document.getElementById('mFotoNotas').value = '';
  }
  openModal('modalFotometro');
}

function saveFotometro() {
  const id = document.getElementById('mFotoId').value;
  const nombre = document.getElementById('mFotoNombre').value.trim();
  if (!nombre) { alert('El nombre es obligatorio'); return; }
  const obj = {
    id: id || DB.id(),
    nombre,
    serie: document.getElementById('mFotoSerie').value.trim(),
    param: document.getElementById('mFotoParam').value,
    ubicacion: document.getElementById('mFotoUbic').value.trim(),
    estado: document.getElementById('mFotoEstado').value,
    calFecha: document.getElementById('mFotoCalFecha').value,
    calLab: document.getElementById('mFotoLab').value.trim(),
    calCert: document.getElementById('mFotoCert').value.trim(),
    notas: document.getElementById('mFotoNotas').value.trim(),
  };
  const fotos = getFotos();
  if (id) {
    const idx = fotos.findIndex(f => f.id === id);
    fotos[idx] = obj;
  } else {
    fotos.push(obj);
  }
  setFotos(fotos);
  closeModal('modalFotometro');
  saveToGitHub();
  renderAll();
}

function openVerif(fotoId = null) {
  const fotos = getFotos().filter(f => f.estado === 'activo');
  const sel = document.getElementById('mVerifFoto');
  sel.innerHTML = fotos.map(f => `<option value="${f.id}" ${f.id===fotoId?'selected':''}>${f.nombre}</option>`).join('');
  document.getElementById('mVerifFecha').value = today();
  document.getElementById('mVerifPatron').value = '';
  document.getElementById('mVerifTecnico').value = '';
  document.getElementById('mVerifNotas').value = '';
  // Reset params
  document.getElementById('verifParams').innerHTML = `
    <div class="form-group">
      <label class="form-label">ParÃ¡metro 1</label>
      <div class="result-row">
        <div><label class="form-label">Nombre</label><input type="text" class="form-input param-name" placeholder="Ej: Cloro libre"></div>
        <div><label class="form-label">Valor patrÃ³n â†’ obtenido</label><input type="text" class="form-input param-val" placeholder="1.00 â†’ 1.02 mg/L"></div>
        <div><label class="form-label">OK</label><div class="result-status" onclick="toggleStatus(this)">â€”</div></div>
      </div>
    </div>`;
  openModal('modalVerif');
}

function addParamRow() {
  const container = document.getElementById('verifParams');
  const n = container.querySelectorAll('.form-group').length + 1;
  const div = document.createElement('div');
  div.className = 'form-group';
  div.innerHTML = `<label class="form-label">ParÃ¡metro ${n}</label>
    <div class="result-row">
      <div><label class="form-label">Nombre</label><input type="text" class="form-input param-name" placeholder="ParÃ¡metro"></div>
      <div><label class="form-label">Valor patrÃ³n â†’ obtenido</label><input type="text" class="form-input param-val" placeholder="x.xx â†’ x.xx mg/L"></div>
      <div><label class="form-label">OK</label><div class="result-status" onclick="toggleStatus(this)">â€”</div></div>
    </div>`;
  container.appendChild(div);
}

function toggleStatus(el) {
  if (!el.classList.contains('pass') && !el.classList.contains('fail')) {
    el.classList.add('pass'); el.textContent = 'âœ“';
  } else if (el.classList.contains('pass')) {
    el.classList.remove('pass'); el.classList.add('fail'); el.textContent = 'âœ—';
  } else {
    el.classList.remove('fail'); el.textContent = 'â€”';
  }
}

function saveVerificacion() {
  const fotoId = document.getElementById('mVerifFoto').value;
  const fecha = document.getElementById('mVerifFecha').value;
  if (!fotoId || !fecha) { alert('Selecciona fotÃ³metro y fecha'); return; }

  const names = [...document.querySelectorAll('.param-name')].map(i => i.value.trim());
  const vals = [...document.querySelectorAll('.param-val')].map(i => i.value.trim());
  const statuses = [...document.querySelectorAll('.result-status')].map(el =>
    el.classList.contains('pass') ? 'pass' : el.classList.contains('fail') ? 'fail' : 'pass'
  );
  const params = names.map((n,i) => ({ nombre: n||`ParÃ¡metro ${i+1}`, valor: vals[i], status: statuses[i] }));
  const global = params.some(p => p.status === 'fail') ? 'fail' : 'pass';

  const obj = {
    id: DB.id(), fotoId, fecha,
    patron: document.getElementById('mVerifPatron').value.trim(),
    tecnico: document.getElementById('mVerifTecnico').value.trim(),
    params, global,
    notas: document.getElementById('mVerifNotas').value.trim(),
  };

  const all = getVerifs();
  all.push(obj);
  setVerifs(all);
  closeModal('modalVerif');
  saveToGitHub();
  renderAll();
}

function openCalAnual() {
  const fotos = getFotos().filter(f => f.estado === 'activo');
  document.getElementById('mCalFoto').innerHTML = fotos.map(f => `<option value="${f.id}">${f.nombre}</option>`).join('');
  document.getElementById('mCalFecha').value = today();
  document.getElementById('mCalLab').value = '';
  document.getElementById('mCalCert').value = '';
  document.getElementById('mCalResultado').value = '';
  document.getElementById('mCalNotas').value = '';
  // Auto vigencia = 1 aÃ±o
  const vig = new Date(); vig.setFullYear(vig.getFullYear()+1);
  document.getElementById('mCalVigencia').value = vig.toISOString().slice(0,10);
  openModal('modalCalAnual');
}

function saveCalAnual() {
  const fotoId = document.getElementById('mCalFoto').value;
  const fecha = document.getElementById('mCalFecha').value;
  if (!fotoId || !fecha) { alert('Selecciona fotÃ³metro y fecha'); return; }
  const obj = {
    id: DB.id(), fotoId, fecha,
    lab: document.getElementById('mCalLab').value.trim(),
    cert: document.getElementById('mCalCert').value.trim(),
    resultado: document.getElementById('mCalResultado').value.trim(),
    vigencia: document.getElementById('mCalVigencia').value,
    notas: document.getElementById('mCalNotas').value.trim(),
  };
  // Actualizar tambiÃ©n la fecha en el fotÃ³metro
  const fotos = getFotos();
  const idx = fotos.findIndex(f => f.id === fotoId);
  if (idx >= 0 && (!fotos[idx].calFecha || obj.fecha > fotos[idx].calFecha)) {
    fotos[idx].calFecha = obj.fecha;
    fotos[idx].calLab = obj.lab;
    fotos[idx].calCert = obj.cert;
    setFotos(fotos);
  }
  const all = getCals();
  all.push(obj);
  setCals(all);
  closeModal('modalCalAnual');
  saveToGitHub();
  renderAll();
}

// ============================================================
//  DETALLE FOTÃ“METRO
// ============================================================
let detalleFotoId = null;
function showDetalle(id) {
  detalleFotoId = id;
  const foto = getFotos().find(f => f.id === id);
  const s = getDeviceStatus(foto);
  const verifs = getVerifs().filter(v => v.fotoId === id).sort((a,b)=>a.fecha<b.fecha?1:-1);
  const lastV = verifs[0];

  document.getElementById('detalleContent').innerHTML = `
    <div style="margin-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:6px;">
        <div style="font-size:17px;font-weight:700;">${foto.nombre}</div>
        <span class="card-serial">${foto.serie}</span>
      </div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:12px">${foto.param} Â· ${foto.ubicacion}</div>
      <span class="badge ${s.overall}">${{ok:'CORRECTO',warn:'ATENCIÃ“N',danger:'VENCIDO'}[s.overall]}</span>
    </div>
    <div class="form-divider"></div>
    <div class="section-label" style="margin-top:12px;">CalibraciÃ³n anual</div>
    <div class="card-meta" style="margin-bottom:12px;">
      <div class="meta-item"><div class="meta-label">Ãšltima</div><div class="meta-value ${s.calStatus}">${fmtDate(s.lastCal)}</div></div>
      <div class="meta-item"><div class="meta-label">PrÃ³xima</div><div class="meta-value ${s.calStatus}">${fmtDate(s.nextCal)}</div></div>
      <div class="meta-item"><div class="meta-label">Laboratorio</div><div class="meta-value" style="font-size:12px">${foto.calLab||'â€”'}</div></div>
      <div class="meta-item"><div class="meta-label">Certificado</div><div class="meta-value" style="font-size:12px;color:var(--accent)">${foto.calCert||'â€”'}</div></div>
    </div>
    <div class="section-label">Ãšltima verificaciÃ³n mensual</div>
    ${lastV ? `<div class="card-meta">
      <div class="meta-item"><div class="meta-label">Fecha</div><div class="meta-value ${s.verifStatus}">${fmtDate(lastV.fecha)}</div></div>
      <div class="meta-item"><div class="meta-label">Resultado</div><span class="badge ${lastV.global==='pass'?'ok':'danger'}">${lastV.global==='pass'?'PASA':'FALLA'}</span></div>
      <div class="meta-item"><div class="meta-label">TÃ©cnico</div><div class="meta-value" style="font-size:12px">${lastV.tecnico||'â€”'}</div></div>
      <div class="meta-item"><div class="meta-label">PatrÃ³n</div><div class="meta-value" style="font-size:12px">${lastV.patron||'â€”'}</div></div>
    </div>` : '<div style="font-size:13px;color:var(--text2)">Sin verificaciones registradas</div>'}
    <div style="display:flex;gap:8px;margin-top:14px;">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('modalDetalle');openVerif('${foto.id}')">ğŸ§ª Nueva verificaciÃ³n</button>
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('modalDetalle');openCalAnual()">ğŸ“‹ Nueva calibraciÃ³n</button>
    </div>
    ${foto.notas ? `<div style="margin-top:12px;font-size:12px;color:var(--text2);padding:10px;background:var(--bg);border-radius:8px;">${foto.notas}</div>` : ''}
  `;
  openModal('modalDetalle');
}

function editFotometro() {
  closeModal('modalDetalle');
  openFotometro(detalleFotoId);
}

function confirmDelete() {
  openModal('confirmDialog');
}
function closeConfirm() { closeModal('confirmDialog'); }
function doDelete() {
  setFotos(getFotos().filter(f => f.id !== detalleFotoId));
  setVerifs(getVerifs().filter(v => v.fotoId !== detalleFotoId));
  setCals(getCals().filter(c => c.fotoId !== detalleFotoId));
  closeModal('confirmDialog');
  closeModal('modalDetalle');
  saveToGitHub();
  renderAll();
}

// Fix confirm dialog close
document.getElementById('confirmDialog').addEventListener('click', e => {
  if (e.target === document.getElementById('confirmDialog')) closeConfirm();
});

// ============================================================
//  NAVEGACIÃ“N
// ============================================================
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'trazabilidad') renderTrazSelector();
}

// ============================================================
//  EXPORTAR CSV
// ============================================================
function exportCSV() {
  const fotos = getFotos();
  const verifs = getVerifs();
  const cals = getCals();

  // --- Hoja 1: FotÃ³metros ---
  let csv = 'FOTÃ“METROS\n';
  csv += 'Nombre,NÂº Serie,ParÃ¡metro,UbicaciÃ³n,Estado,Ãšlt. Cal. Anual,Laboratorio,NÂº Certificado,Notas\n';
  fotos.forEach(f => {
    csv += [f.nombre, f.serie, f.param, f.ubicacion, f.estado, f.calFecha||'', f.calLab||'', f.calCert||'', (f.notas||'').replace(/,/g,' ')].map(v => `"${v}"`).join(',') + '\n';
  });

  csv += '\nVERIFICACIONES MENSUALES\n';
  csv += 'FotÃ³metro,NÂº Serie,Fecha,PatrÃ³n/Kit,ParÃ¡metros,TÃ©cnico,Resultado Global,Observaciones\n';
  verifs.sort((a,b)=>a.fecha<b.fecha?1:-1).forEach(v => {
    const foto = fotos.find(f => f.id === v.fotoId);
    const paramsStr = (v.params||[]).map(p=>`${p.nombre}: ${p.valor} [${p.status==='pass'?'OK':'FALLO'}]`).join(' | ');
    csv += [foto?.nombre||'â€”', foto?.serie||'â€”', v.fecha, v.patron||'', paramsStr, v.tecnico||'', v.global==='pass'?'PASA':'FALLA', (v.notas||'').replace(/,/g,' ')].map(v=>`"${v}"`).join(',') + '\n';
  });

  csv += '\nCALIBRACIONES ANUALES (ADICIONALES)\n';
  csv += 'FotÃ³metro,NÂº Serie,Fecha,Laboratorio,NÂº Certificado,Resultado/Incertidumbre,VÃ¡lida hasta,Observaciones\n';
  cals.sort((a,b)=>a.fecha<b.fecha?1:-1).forEach(c => {
    const foto = fotos.find(f => f.id === c.fotoId);
    csv += [foto?.nombre||'â€”', foto?.serie||'â€”', c.fecha, c.lab||'', c.cert||'', c.resultado||'', c.vigencia||'', (c.notas||'').replace(/,/g,' ')].map(v=>`"${v}"`).join(',') + '\n';
  });

  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `FotoCalib_${today()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ============================================================
//  EXPORTAR PDF (ventana de impresiÃ³n con estilos propios)
// ============================================================
function exportPDF() {
  const fotos = getFotos();
  const verifs = getVerifs().sort((a,b)=>a.fecha<b.fecha?1:-1);
  const cals = getCals().sort((a,b)=>a.fecha<b.fecha?1:-1);
  const nowStr = new Date().toLocaleDateString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric'});

  const statusBadge = (s, label) => {
    const colors = {ok:'#00a86b', warn:'#cc8800', danger:'#cc2233', pass:'#00a86b', fail:'#cc2233'};
    const labels = {ok:'CORRECTO', warn:'ATENCIÃ“N', danger:'VENCIDO', pass:'PASA', fail:'FALLA'};
    const c = colors[s] || '#666';
    return `<span style="background:${c}20;color:${c};border:1px solid ${c}40;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">${label||labels[s]||s.toUpperCase()}</span>`;
  };

  let html = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">
<title>FotoCalib â€” Informe ${nowStr}</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, sans-serif; font-size: 12px; color: #111; background: #fff; padding: 20px; }
  h1 { font-size: 20px; color: #003366; margin-bottom: 4px; }
  .subtitle { font-size: 11px; color: #555; margin-bottom: 20px; }
  h2 { font-size: 14px; color: #003366; border-bottom: 2px solid #003366; padding-bottom: 4px; margin: 20px 0 10px; }
  h3 { font-size: 13px; color: #333; margin: 14px 0 6px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 12px; font-size: 11px; }
  th { background: #003366; color: #fff; padding: 6px 8px; text-align: left; }
  td { padding: 5px 8px; border-bottom: 1px solid #dde; vertical-align: top; }
  tr:nth-child(even) td { background: #f5f8ff; }
  .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; }
  .ok { background: #e6f9f0; color: #006633; }
  .danger { background: #fde8ea; color: #cc2233; }
  .warn { background: #fff5cc; color: #886600; }
  .mono { font-family: 'Courier New', monospace; }
  .page-break { page-break-after: always; }
  .header-bar { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #003366; padding-bottom: 12px; margin-bottom: 16px; }
  .logo-text { font-size: 24px; font-weight: 900; color: #003366; letter-spacing: -1px; }
  .logo-sub { font-size: 10px; color: #666; }
  footer { margin-top: 24px; border-top: 1px solid #dde; padding-top: 8px; font-size: 10px; color: #888; display: flex; justify-content: space-between; }
  @media print {
    body { padding: 10px; }
    .no-print { display: none; }
    @page { margin: 15mm; size: A4; }
  }
</style></head><body>`;

html += `<div class="header-bar">
<div><div class="logo-text">FotoCalib</div><div class="logo-sub">GestiÃ³n de calibraciones de fotÃ³metros Â· RD 3/2023 Â· RD 487/2022</div></div>
<div style="text-align:right;font-size:11px;color:#555;">Fecha de informe: <strong>${nowStr}</strong><br>Total fotÃ³metros: <strong>${fotos.length}</strong></div>

  </div>`;

// â€” SECCIÃ“N FOTÃ“METROS â€”
html += `<h2>ğŸ“Ÿ FotÃ³metros registrados</h2>

  <table>
    <thead><tr><th>Nombre / Modelo</th><th>NÂº Serie</th><th>ParÃ¡metro</th><th>UbicaciÃ³n</th><th>Ãšlt. CalibraciÃ³n</th><th>Laboratorio</th><th>Certificado</th><th>Estado</th></tr></thead>
    <tbody>`;
  fotos.forEach(f => {
    const s = getDeviceStatus(f);
    html += `<tr>
      <td><strong>${f.nombre}</strong></td>
      <td class="mono">${f.serie||'â€”'}</td>
      <td>${f.param}</td>
      <td>${f.ubicacion||'â€”'}</td>
      <td class="mono">${fmtDate(f.calFecha)}</td>
      <td>${f.calLab||'â€”'}</td>
      <td class="mono">${f.calCert||'â€”'}</td>
      <td><span class="badge ${s.overall}">${{ok:'CORRECTO',warn:'ATENCIÃ“N',danger:'VENCIDO'}[s.overall]}</span></td>
    </tr>`;
  });
  html += `</tbody></table>`;

// â€” SECCIÃ“N CALIBRACIONES ANUALES â€”
const allCals = [];
fotos.forEach(f => { if(f.calFecha) allCals.push({â€¦f, fecha: f.calFecha, lab: f.calLab, cert: f.calCert, resultado: â€˜â€™, vigencia: nextCalDate(f.calFecha), notas: f.notas, _type:â€˜inicialâ€™}); });
cals.forEach(c => { const f = fotos.find(x=>x.id===c.fotoId); allCals.push({â€¦c, nombre: f?.nombre||â€™â€”â€™, serie: f?.serie||â€™â€”â€™, _type:â€˜adicionalâ€™}); });
allCals.sort((a,b)=>a.fecha<b.fecha?1:-1);

html += `<h2>ğŸ“‹ Calibraciones anuales</h2>

  <table>
    <thead><tr><th>FotÃ³metro</th><th>NÂº Serie</th><th>Fecha</th><th>Laboratorio</th><th>Certificado</th><th>Resultado</th><th>VÃ¡lida hasta</th></tr></thead>
    <tbody>`;
  allCals.forEach(c => {
    html += `<tr>
      <td><strong>${c.nombre||c.nombre}</strong></td>
      <td class="mono">${c.serie||'â€”'}</td>
      <td class="mono">${fmtDate(c.fecha)}</td>
      <td>${c.lab||c.calLab||'â€”'}</td>
      <td class="mono">${c.cert||c.calCert||'â€”'}</td>
      <td>${c.resultado||'â€”'}</td>
      <td class="mono">${fmtDate(c.vigencia)}</td>
    </tr>`;
  });
  html += `</tbody></table>`;

// â€” SECCIÃ“N VERIFICACIONES â€”
html += `<h2>ğŸ§ª Verificaciones mensuales (historial completo)</h2>`;

fotos.forEach(f => {
const fv = verifs.filter(v => v.fotoId === f.id);
if (!fv.length) return;
html += `<h3>${f.nombre} <span class="mono" style="font-weight:400;color:#666;">(${f.serie})</span></h3> <table> <thead><tr><th>Fecha</th><th>PatrÃ³n / Kit</th><th>ParÃ¡metros verificados</th><th>TÃ©cnico</th><th>Resultado</th><th>Observaciones</th></tr></thead> <tbody>`;
fv.forEach(v => {
const paramsStr = (v.params||[]).map(p=>`${p.nombre}: ${p.valor} [${p.status==='pass'?'OK':'FALLO'}]`).join(â€™<br>â€™);
html += `<tr> <td class="mono">${fmtDate(v.fecha)}</td> <td>${v.patron||'â€”'}</td> <td>${paramsStr}</td> <td>${v.tecnico||'â€”'}</td> <td><span class="badge ${v.global==='pass'?'ok':'danger'}">${v.global==='pass'?'PASA':'FALLA'}</span></td> <td style="font-style:italic;color:#666;">${v.notas||''}</td> </tr>`;
});
html += `</tbody></table>`;
});

html += `<footer>
<span>FotoCalib Â· RD 3/2023 Â· RD 487/2022 â€” Informe generado el ${nowStr}</span>
<span>Documento de trazabilidad de fotÃ³metros</span>

  </footer>
  <div class="no-print" style="text-align:center;margin:20px;">
    <button onclick="window.print()" style="padding:10px 24px;background:#003366;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;">ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
    <button onclick="window.close()" style="padding:10px 24px;background:#eee;color:#333;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-left:8px;">Cerrar</button>
  </div>
  </body></html>`;

const w = window.open(â€™â€™, â€˜_blankâ€™, â€˜width=900,height=700â€™);
w.document.write(html);
w.document.close();
}

// ============================================================
//  SETTINGS
// ============================================================
function openSettings() {
document.getElementById(â€˜sTokenâ€™).value = GH.token;
document.getElementById(â€˜settingsStatusâ€™).textContent = â€˜â€™;
// Mostrar aviso si estamos dentro de Claude.ai u otro sandbox
const isSandboxed = window.location.hostname.includes(â€˜claude.aiâ€™)
|| window.location.hostname.includes(â€˜anthropicâ€™)
|| window.location.hostname === â€˜â€™;
document.getElementById(â€˜sandboxWarningâ€™).style.display = isSandboxed ? â€˜blockâ€™ : â€˜noneâ€™;
openModal(â€˜modalSettingsâ€™);
}

function saveSettings() {
const token = document.getElementById(â€˜sTokenâ€™).value.trim();
if (token) localStorage.setItem(â€˜fc_gh_tokenâ€™, token);
else localStorage.removeItem(â€˜fc_gh_tokenâ€™);
closeModal(â€˜modalSettingsâ€™);
// Recargar desde GitHub con el nuevo token
loadFromGitHub().then(() => renderAll());
}

async function testGitHub() {
const token = document.getElementById(â€˜sTokenâ€™).value.trim();
const el = document.getElementById(â€˜settingsStatusâ€™);
el.style.color = â€˜var(â€“text2)â€™;
el.textContent = â€˜â³ Probandoâ€¦â€™;
try {
const res = await fetch(GH.apiUrl, {
headers: {
â€˜Authorizationâ€™: `Bearer ${token}`,
â€˜Acceptâ€™: â€˜application/vnd.github+jsonâ€™
}
});
if (res.ok) {
el.style.color = â€˜var(â€“accent2)â€™;
el.textContent = â€˜âœ… ConexiÃ³n correcta. El archivo existe y es accesible.â€™;
} else if (res.status === 404) {
el.style.color = â€˜var(â€“warn)â€™;
el.textContent = â€˜âš ï¸ Token OK pero el archivo no existe aÃºn. Se crearÃ¡ al guardar.â€™;
} else if (res.status === 401) {
el.style.color = â€˜var(â€“danger)â€™;
el.textContent = â€˜âŒ Token invÃ¡lido o sin permisos suficientes.â€™;
} else {
el.style.color = â€˜var(â€“danger)â€™;
el.textContent = `âŒ Error HTTP ${res.status}`;
}
} catch(e) {
// Detectar si es un bloqueo de sandbox (CSP) o error de red real
const isSandboxed = window.location.hostname.includes(â€˜claude.aiâ€™)
|| window.location.hostname.includes(â€˜anthropicâ€™)
|| window.location.hostname === â€˜â€™;
el.style.color = â€˜var(â€“warn)â€™;
if (isSandboxed) {
el.innerHTML = â€˜âš ï¸ <strong style="color:var(--text)">EstÃ¡s dentro de Claude.ai</strong>, que bloquea llamadas externas.<br>Abre el archivo en Safari o en GitHub Pages y funcionarÃ¡ perfectamente.â€™;
} else {
el.style.color = â€˜var(â€“danger)â€™;
el.textContent = â€˜âŒ Error de red. Â¿Tienes conexiÃ³n a internet?â€™;
}
}
}

</script>
</body>
</html>